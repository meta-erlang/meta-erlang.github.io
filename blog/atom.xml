<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://meta-erlang.github.io/blog/</id>
    <title>meta-erlang Blog</title>
    <updated>2026-01-02T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://meta-erlang.github.io/blog/"/>
    <subtitle>meta-erlang Blog</subtitle>
    <icon>https://meta-erlang.github.io/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[meta-erlang Yocto Project Compatible v3 Layers Accepted]]></title>
        <id>https://meta-erlang.github.io/blog/2026/01/02/index/</id>
        <link href="https://meta-erlang.github.io/blog/2026/01/02/index/"/>
        <updated>2026-01-02T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This post is to inform that meta-erlang has been accepted as Yocto Project]]></summary>
        <content type="html"><![CDATA[<p>This post is to inform that meta-erlang has been accepted as Yocto Project
Compatible v3 Layer.</p>
<p>The
<a href="https://www.yoctoproject.org/development/yocto-project-compatible-layers/" target="_blank" rel="noopener noreferrer" class="">Yocto Project Compatible Layers</a>
is a program to evaluate and list all layers that follows
<a href="https://docs.yoctoproject.org/current/overview-manual/yp-intro.html#the-yocto-project-layer-model" target="_blank" rel="noopener noreferrer" class="">The Yocto Project Layer Model</a>.</p>
<p>On last December/2025, I received an email from Yocto Project managers saying as
follows:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Dear Yocto Layer Maintainer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Congratulations! Your layer has been successfully reviewed and is now recognized as Yocto Project Compatible v3.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">As part of this recognition, you are granted the right to display the Yocto Project Compatible badge in association with your layer and related materials.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">What‚Äôs Included in This Email:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‚úÖ Your Rights: You may now publicly use the ‚ÄúYocto Project Compatible‚Äù badge to promote your layer.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    üîó Links to Entry: Your layer listing can be found on the Yocto Project Layer Index: https://layers.openembedded.org/layerindex/branch/master/layers/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    üß™ Layer Compatibility Check: Your layer has passed compatibility validation with the current Yocto Project release v3.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    üìé Attached:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        The official Yocto Project Compatible badge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Branding Guidelines to help you use the badge properly</span><br></span></code></pre></div></div>
<p>In fact, I have applied meta-erlang through
<a href="https://www.yoctoproject.org/compatible-registration/" target="_blank" rel="noopener noreferrer" class="">Yocto Project Compatible Layer Registration</a>.
And there was the final result.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-does-it-mean-">What does it mean ?<a href="https://meta-erlang.github.io/blog/2026/01/02/index/#what-does-it-mean-" class="hash-link" aria-label="Direct link to What does it mean ?" title="Direct link to What does it mean ?" translate="no">‚Äã</a></h2>
<p>The rights to officially promote meta-erlang as ‚ÄúYocto Project Compatible‚Äù and
publicly use a badge which informs the end user that meta-erlang has passed to
all
<a href="https://docs.yoctoproject.org/current/dev-manual/layers.html#making-sure-your-layer-is-compatible-with-yocto-project" target="_blank" rel="noopener noreferrer" class="">compatibility checks</a>.
This is the real value of the compatible layer program.</p>
<p><img decoding="async" loading="lazy" alt="alt Yocto Project Compatible badge" src="https://meta-erlang.github.io/assets/images/YoctoCompatibleBadge-659b72e8ad5003e477c67b92cb445227.png" title="Yocto Project Compatible badge" width="720" height="580" class="img_ev3q"></p>
<p>Also, meta-erlang is listed as compatible with a small badge on the Yocto
Project Layer Index:
<a href="https://layers.openembedded.org/layerindex/branch/master/layers/" target="_blank" rel="noopener noreferrer" class="">https://layers.openembedded.org/layerindex/branch/master/layers/</a></p>
<p>In practical terms, I also
<a href="https://github.com/meta-erlang/kas-meta-erlang/blob/main/lux/test/yocto_layer_compatible_check.lux" target="_blank" rel="noopener noreferrer" class="">added a new lux test</a>
which executes the yocto-check-layer check script in order to verify if
meta-erlang is compatible and keeps compatible,
<a href="https://docs.yoctoproject.org/current/dev-manual/layers.html#making-sure-your-layer-is-compatible-with-yocto-project" target="_blank" rel="noopener noreferrer" class="">Making Sure Your Layer is Compatible With Yocto Project</a>.</p>]]></content>
        <author>
            <name>Jo√£o Henrique Ferreira de Freitas</name>
            <uri>https://github.com/joaohf</uri>
        </author>
        <category label="meta-erlang" term="meta-erlang"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Testing meta-erlang with LuX]]></title>
        <id>https://meta-erlang.github.io/blog/2025/09/26/index/</id>
        <link href="https://meta-erlang.github.io/blog/2025/09/26/index/"/>
        <updated>2025-09-26T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In this post we will get a overview about how testimage feature has been enabled]]></summary>
        <content type="html"><![CDATA[<p>In this post we will get a overview about how testimage feature has been enabled
into recipe images examples in order to implement tests.</p>
<p>As meta-erlang layer provides many
<a href="https://layers.openembedded.org/layerindex/branch/master/layer/meta-erlang/" target="_blank" rel="noopener noreferrer" class="">recipes for Erlang and Elixir application</a>,
testing and verifying if each supported application is still working between
Yocto releases is very important.</p>
<p>So, this post is mostly about Yocto oeqa framework and
<a href="https://github.com/hawk/lux" target="_blank" rel="noopener noreferrer" class="">lux tool</a>.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="yocto-oeqa-framework">Yocto oeqa framework<a href="https://meta-erlang.github.io/blog/2025/09/26/index/#yocto-oeqa-framework" class="hash-link" aria-label="Direct link to Yocto oeqa framework" title="Direct link to Yocto oeqa framework" translate="no">‚Äã</a></h2>
<p>The Yocto Project provides a framework called
<a href="https://git.yoctoproject.org/poky/tree/meta/lib/oeqa" target="_blank" rel="noopener noreferrer" class="">oeqa</a> and integrated with
Yocto ecosystem for testing. It is able to test many aspects like: image test,
SDK, build performance, bitbake. All those tests are implemented with python
unittest.</p>
<p>The documentation section called
<a href="https://docs.yoctoproject.org/test-manual/index.html" target="_blank" rel="noopener noreferrer" class="">Yocto Project Test Environment Manual</a>
explains how everything works.</p>
<p>For the meta-erlang context, we are interesting in two types of tests:</p>
<ul>
<li class=""><a href="https://docs.yoctoproject.org/test-manual/intro.html#testimage" target="_blank" rel="noopener noreferrer" class="">testimage</a>,
these tests run once an image is up and running. Let's suppose an image with
riak installed is up and running, we want to check if riak is online, restart,
start again and run health checks</li>
<li class=""><a href="https://docs.yoctoproject.org/test-manual/ptest.html#testing-packages-with-ptest" target="_blank" rel="noopener noreferrer" class="">ptest</a>,
package level test; it is not the focus today</li>
</ul>
<p>For a full oeqa view, the source code is
<a href="https://github.com/meta-erlang/meta-erlang/tree/master/lib/oeqa/runtime" target="_blank" rel="noopener noreferrer" class="">here</a>.</p>
<p>oeqa framework has all the elements needed in order to write unit tests. But, I
was not willing to write unit tests in python way. Instead, I was looking into a
different way for <em>test image</em> type of tests.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="lux-lucid-expect-scripting">Lux, LUcid eXpect scripting<a href="https://meta-erlang.github.io/blog/2025/09/26/index/#lux-lucid-expect-scripting" class="hash-link" aria-label="Direct link to Lux, LUcid eXpect scripting" title="Direct link to Lux, LUcid eXpect scripting" translate="no">‚Äã</a></h2>
<p>Lux is an amazing application written in Erlang/OTP. It's aim is for test
automation. Its github <a href="https://github.com/hawk/lux" target="_blank" rel="noopener noreferrer" class="">hawk/lux</a> is full of
examples and
<a href="https://github.com/hawk/lux/blob/master/doc/lux.md" target="_blank" rel="noopener noreferrer" class="">lux documentation</a> is also
great. From its github's page:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">With Lux it is possible to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    simplify automated testing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    control interactive programs by sending textual input to them and using [regular expression][]s to ensure that their output matches the expectations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    perform detailed post mortem analyzis of test suite results</span><br></span></code></pre></div></div>
<p>There is a talk about Lux presented at the Erlang User Conference 2019:
<a href="https://www.youtube.com/watch?v=Nu15YOpmCKQ" target="_blank" rel="noopener noreferrer" class="">Cons T Ahs and Hakan Mattsson - LUX - an expect like test tool | Code BEAM STO 19</a>
and it explains all internal details that make lux an excellent tool for writing
automated tests.</p>
<p>Let's see a simple lux script example where I want to verify if riak service is
ok. The test case is named
<a href="https://github.com/meta-erlang/meta-erlang/blob/master/lib/oeqa/runtime/files/lux/riak/start_restart_stop.lux" target="_blank" rel="noopener noreferrer" class="">start_restart_stop.lux</a>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[doc Test if riak is able to start, restart and stop]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[include ../support/luxinc/utils.luxinc]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># riak is not so fast when starting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[config timeout=30000]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[shell cmd]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Right after a boot, riak needs some time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # mainly because clutterfish processing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [sleep 30]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [doc2 Stop riak]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    !systemctl stop riak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [invoke ok]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [doc2 Start riak]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    !systemctl start riak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [invoke ok]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [doc2 Check if riak is up and running]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    !SYSTEMD_COLORS=0 systemctl status --line=0 --no-pager riak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ?.*Active: active \(running\).*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [invoke check-exitcode 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # After a start, give some time to riak.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [sleep 30]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [doc2 Ping riak]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    !/usr/lib/riak/bin/riak ping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ?pong</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [invoke check-exitcode 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [doc2 Stop riak]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    !systemctl stop riak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [invoke ok]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [doc2 Check if riak has been stop without any issue]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    !SYSTEMD_COLORS=0 systemctl status --line=0 --no-pager riak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ?.*Active: inactive \(dead\).*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [invoke check-exitcode 3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[cleanup]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    !systemctl stop riak</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [invoke ok]</span><br></span></code></pre></div></div>
<p>The above test starts a shell, named 'cmd'. And tries to:</p>
<ul>
<li class="">stop</li>
<li class="">start</li>
<li class="">check riak service status</li>
<li class="">ping riak</li>
<li class="">stop</li>
<li class="">check if riak was stopped</li>
</ul>
<p>The key point to understand lux scripts is that whatever you do as a human, lux
will also do in order to test the above commands; lux script will work in the
same way but faster.</p>
<p>For instance, to check if systemd was able to start riak one could check the
result of the command <code>systemctl start riak</code> and after that the output of
<code>systemctl status riak</code> in order to conclude or not if riak has been started
properly.</p>
<p>There are some lux scripts implemented for each application that meta-erlang has
a recipe
<a href="https://github.com/meta-erlang/meta-erlang/tree/master/lib/oeqa/runtime/files/lux" target="_blank" rel="noopener noreferrer" class="">lib/oeqa/runtime/files/lux</a>.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="mixing-lux-and-oeqa-into-meta-erlang-for-testing-image">Mixing lux and oeqa into meta-erlang for testing image<a href="https://meta-erlang.github.io/blog/2025/09/26/index/#mixing-lux-and-oeqa-into-meta-erlang-for-testing-image" class="hash-link" aria-label="Direct link to Mixing lux and oeqa into meta-erlang for testing image" title="Direct link to Mixing lux and oeqa into meta-erlang for testing image" translate="no">‚Äã</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="preparing-testable-images">Preparing testable images<a href="https://meta-erlang.github.io/blog/2025/09/26/index/#preparing-testable-images" class="hash-link" aria-label="Direct link to Preparing testable images" title="Direct link to Preparing testable images" translate="no">‚Äã</a></h3>
<p>Yocto documentation says that when testimage feature is enabled, the TEST_SUITES
image variable is used to setup and run image tests.</p>
<p>The following recipe called
<a href="https://github.com/meta-erlang/meta-erlang/blob/master/recipes-examples/images/riak-image.bb" target="_blank" rel="noopener noreferrer" class="">riak-image.bb</a>
adds riak into TEST_SUITES variable only for qemu MACHINES:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SUMMARY = "A console-only image with more full-featured Linux system \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">functionality installed with OpenRiak installed."</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LICENSE = "MIT"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include common.inc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">include testimage-common.inc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">APPLICATION = "riak"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">APPLICATION += "${@bb.utils.contains('IMAGE_CLASSES', 'testimage', 'curl', '', d)}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">inherit core-image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TEST_SUITES:qemuall += "riak"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">QB_MEM ?= "-m 1024"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IMAGE_ROOTFS_EXTRA_SPACE = "256000"</span><br></span></code></pre></div></div>
<p>The testimage-common.inc will install lux package when IMAGE_CLASSES variable
contains testimage feature.</p>
<p>So, we need to have an image that declares what are the test suites that will be
executable and the image is up and running. It's important to mention that these
tests will be executable inside a QEMU instance.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="adding-support-for-running-lux-scripts">Adding support for running lux scripts<a href="https://meta-erlang.github.io/blog/2025/09/26/index/#adding-support-for-running-lux-scripts" class="hash-link" aria-label="Direct link to Adding support for running lux scripts" title="Direct link to Adding support for running lux scripts" translate="no">‚Äã</a></h3>
<p>Now, it's time to get an idea about how to implement an oeqa test which will
call a lux script.</p>
<p>As a test case example, let's dissect a test
<a href="https://github.com/meta-erlang/meta-erlang/blob/master/lib/oeqa/runtime/cases/riak.py" target="_blank" rel="noopener noreferrer" class="">case for riak</a>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> oeqa</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">decorator</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">depends </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> OETestDepends</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> oeqa</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">decorator</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">oetimeout </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> OETimeout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> oeqa</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">decorator</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">package </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> OEHasPackage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> oeqa</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">decorator</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lux </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> LuxTestCase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> oeqa</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">meta_erlang </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> MetaErlangTestCase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">RiakTest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MetaErlangTestCase</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@OETimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">300</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@OEHasPackage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"lux"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@OETestDepends</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'ssh.SSHTest.test_ssh'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@LuxTestCase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"start_restart_stop.lux"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"riak"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">test_start_restart_stop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run_lux_test_case</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>The test case is written in python and uses some decorators available in oeqa
framework and some
<a href="https://github.com/meta-erlang/meta-erlang/blob/master/lib/oeqa/runtime/decorator/lux.py" target="_blank" rel="noopener noreferrer" class="">extra one to support lux</a>.
The purpose of these decorators is mainly to check conditions and configure lux
scripts like what is the name of lux script which (e.g.:
<em>start_restart_stop.lux</em>) implements the test and what folder it is located
(e.g.: <em>riak</em>).</p>
<p>The
<a href="https://github.com/meta-erlang/meta-erlang/blob/master/lib/oeqa/runtime/meta_erlang.py" target="_blank" rel="noopener noreferrer" class="">MetaErlangTestCase</a>
class implements the function <em>run_lux_test_case</em> and it is responsible for:</p>
<ul>
<li class="">copy test case to DUT (Device Under Test)</li>
<li class="">copy lux support configuration files and macros</li>
<li class="">execute lux test cases</li>
<li class="">check the results</li>
<li class="">copy logs from DUT into host</li>
</ul>
<p>The python test case above is needed as a bridge to call lux inside DUT. As the
main purpose is to use lux running on target for testing.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="conclusion">Conclusion<a href="https://meta-erlang.github.io/blog/2025/09/26/index/#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion" translate="no">‚Äã</a></h2>
<p>This sort of integration is like eating your own dog food. That means, using
components from Yocto Project and meta-erlang for testing all the work.</p>
<p>oeqa is pretty solid and each Yocto release there are more and more tests
covering many areas of the ecosystem. I think lux is the right tool to provide
test cases without the needed to implement python code as with lux we can write
exactly how one does test.</p>]]></content>
        <author>
            <name>Jo√£o Henrique Ferreira de Freitas</name>
            <uri>https://github.com/joaohf</uri>
        </author>
        <category label="meta-erlang" term="meta-erlang"/>
        <category label="test" term="test"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[beamruntime]]></title>
        <id>https://meta-erlang.github.io/blog/2025/09/25/index/</id>
        <link href="https://meta-erlang.github.io/blog/2025/09/25/index/"/>
        <updated>2025-09-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[One of the coolest features from the Yocto Project is the ability of creating]]></summary>
        <content type="html"><![CDATA[<p>One of the coolest features from the Yocto Project is the ability of creating
toolchains and SDK for specific needs. There is a full session on Yocto's
documentation about
<a href="https://docs.yoctoproject.org/sdk-manual/index.html" target="_blank" rel="noopener noreferrer" class="">Software Development Kits</a>.
Also, many talks showing that feature in action, e.g.:
<a href="https://www.youtube.com/watch?v=b0yXASkIIv8&amp;t=2496s" target="_blank" rel="noopener noreferrer" class="">Building Bare Metal Toolchains, Crosstool-ng and Yocto Project - Mark Hatle, Xilinx</a>.</p>
<p>While reading this discussion:
<a href="https://github.com/erlef/otp_builds/issues/39#issuecomment-3265877959" target="_blank" rel="noopener noreferrer" class="">It is possible that this project may expand to also provide Linux builds?</a>,
I thought it would be interesting as a PoC to create a sort of <em>beamruntime</em>
Yocto based toolchain with only Erlang/OTP and Elixir installed plus base
libraries like libc, termcap, openssl. Nothing more. As meta-erlang layer has
all the components and infrastructure for that. See beamtools idea.</p>
<p>The target audience is for Linux boxes that does not have Erlang/OTP installed,
then the user would install beamruntime and get access to a fresh and up to date
Erlang/OTP and Elixir environment. As the SDK generated by Yocto is
self-content, there is no need to install anything else into Operational System.</p>
<p>Moreover, beamruntime is linux distribution independent, it could run in any
distribution for the target architecture.</p>
<p>In fact, this idea is not new in meta-erlang land, <em>beamtools</em> uses exact the
same approach. The difference is beamtools has development tools for building
Erlang/OTP and Elixir application (like headers, rebar3, etc). While beamruntime
is just for running application, that is BEAM VM and modules.</p>
<p>One advantage of using Yocto for making SDKs is that Yocto is also a platform
where each component and version are well tested and all components for a Yocto
release is enough stable and are up to date versions. So, there is no need to
worry too much about what goes inside the SDK. If this is too important, it's
possible to provide a Software Bill of Materials for beamruntime.</p>
<p>However, the key point is that it allows you to take control of the full process
and not only consume binaries from Internet. Of course it depends on each use
case. But it's important to notice that building your own SDK is also feasible.</p>
<p>I made all my tests using Yocto master branch which is for development only.
I'll update this post following the next Yocto release, by end of October. Then,
I'll also provide a stable beamruntime tools for testing.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="beamruntime-recipe">beamruntime recipe<a href="https://meta-erlang.github.io/blog/2025/09/25/index/#beamruntime-recipe" class="hash-link" aria-label="Direct link to beamruntime recipe" title="Direct link to beamruntime recipe" translate="no">‚Äã</a></h2>
<p>I've started with two architecture targets in mind: x86-64 and aarch64. And a
new bitbake recipe called
<a href="https://github.com/meta-erlang/meta-erlang/blob/master/recipes-core/meta/beamruntime-tarball.bb" target="_blank" rel="noopener noreferrer" class="">beamruntime-tarball</a>.</p>
<p>After building it using <code>bitbake beamruntime-tarball</code> a sdk was made and
available at <em>tmp/deploy/sdk</em> ready for use.</p>
<p>I borrowed some ideas from the
<a href="https://git.yoctoproject.org/poky/tree/meta/recipes-core/meta/buildtools-tarball.bb" target="_blank" rel="noopener noreferrer" class="">OE-core recipe from here</a>.
Because the purpose is very similar.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="practical-usage">Practical usage<a href="https://meta-erlang.github.io/blog/2025/09/25/index/#practical-usage" class="hash-link" aria-label="Direct link to Practical usage" title="Direct link to Practical usage" translate="no">‚Äã</a></h2>
<p>Installing beamruntime is like running a selfextract shell script which install
beamruntime in the target folder (-d option):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ x86_64-beamruntime-nativesdk-standalone-5.2.99+snapshot-musl-erlang-28.0.4-elixir-1.18.4.sh -d /tmp/test0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BEAM runtime installer version 5.2.99+snapshot-erlang-28.0.4-elixir-1.18.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">==========================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You are about to install the SDK to "/tmp/test0". Proceed [Y/n]?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Extracting SDK......done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Setting it up...done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SDK has been successfully set up and is ready to be used.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Each time you wish to use the SDK in a new shell session, you need to source the environment setup script e.g.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> $ . /tmp/test0/environment-setup-x86_64-pokysdk-linux</span><br></span></code></pre></div></div>
<p>After the installation, and for each shell, it's necessary to source a script
that will fix some environment variables:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ source /tmp/test0/environment-setup-x86_64-pokysdk-linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ erl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Erlang/OTP 28 [erts-16.0.3] [source] [64-bit] [smp:12:12] [ds:12:12:10] [async-threads:1] [jit:ns]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Eshell V16.0.3 (press Ctrl+G to abort, type help(). for help)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1&gt; application:start(crypto).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2&gt;</span><br></span></code></pre></div></div>
<p>Erlang shell is working as expected. Let's take a look in the image process
mapping to check from where the beam PID is getting libraries:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat /proc/142729/maps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">60245d000000-60245d018000 rw-p 00a00000 fc:00 26099460                   /tmp/test0/sysroots/x86_64-pokysdk-linux/usr/lib/erlang/erts-16.0.3/bin/beam.smp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">785f53fee000-785f53ff3000 rw-p 001de000 fc:00 26099940                   /tmp/test0/sysroots/x86_64-pokysdk-linux/lib/libc.so.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">785f54272000-785f54275000 rw-p 00271000 fc:00 20982895                   /tmp/test0/sysroots/x86_64-pokysdk-linux/usr/lib/libstdc++.so.6.0.34</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">785f542cf000-785f542d0000 rw-p 0002b000 fc:00 26099910                   /tmp/test0/sysroots/x86_64-pokysdk-linux/lib/libgcc_s.so.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">785f543c1000-785f543c2000 rw-p 000f0000 fc:00 26099961                   /tmp/test0/sysroots/x86_64-pokysdk-linux/lib/libm.so.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">785f543dc000-785f543dd000 rw-p 00019000 fc:00 20982885                   /tmp/test0/sysroots/x86_64-pokysdk-linux/usr/lib/libz.so.1.3.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">785f5440f000-785f54410000 rw-p 00031000 fc:00 26099959                   /tmp/test0/sysroots/x86_64-pokysdk-linux/lib/libtinfo.so.5.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">785f54451000-785f54452000 rw-p 00039000 fc:00 26099952                   /tmp/test0/sysroots/x86_64-pokysdk-linux/lib/ld-linux-x86-64.so.2</span><br></span></code></pre></div></div>
<p>As expected every dependency is self-content from <code>/tmp/test0</code>. Even the openssl
libs:</p>
<p>Get some crypto info:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2&gt; crypto:info().</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#{otp_crypto_version =&gt; "5.6",compile_type =&gt; normal,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  link_type =&gt; dynamic,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cryptolib_version_compiled =&gt; "OpenSSL 3.5.2 5 Aug 2025",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  cryptolib_version_linked =&gt; "OpenSSL 3.5.2 5 Aug 2025",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fips_provider_available =&gt; false}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3&gt; crypto:info_lib().</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[{&lt;&lt;"OpenSSL"&gt;&gt;,810549280,&lt;&lt;"OpenSSL 3.5.2 5 Aug 2025"&gt;&gt;}]</span><br></span></code></pre></div></div>
<p>My Ubuntu (24.04) host has OpenSSL 3.0.13, not <em>3.5.2</em>. That is a good sign for
self-content approach.</p>
<p>So, beamruntime could be used as a generic Erlang/OTP and Elixir installation
for Linux boxes.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="more-details">More details<a href="https://meta-erlang.github.io/blog/2025/09/25/index/#more-details" class="hash-link" aria-label="Direct link to More details" title="Direct link to More details" translate="no">‚Äã</a></h2>
<p>The file
<em>x86_64-beamruntime-nativesdk-standalone-5.2.99+snapshot-musl-erlang-28.0.4-elixir-1.18.4.sh</em>
has 36291 KB and when installed it goes up to 78476 KB. The user can install it
in any folder.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The size footprint is relative, as in this experience I was targeting a generic
installation. So, right now, it's not part of the scope the following Erlang/OTP
features: odbc, sctp support, wx.</p></div></div>
<p>beamruntime provides the following packages:</p>
<ul>
<li class="">libc (musl)</li>
<li class="">terminfo</li>
<li class="">zlib</li>
<li class="">openssl</li>
<li class="">Erlang/OTP</li>
<li class="">Elixir</li>
</ul>
<p>A more detailed list with package size and theirs names:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">11825	KiB	nativesdk-erlang-erts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7018	KiB	nativesdk-elixir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6418	KiB	nativesdk-erlang-stdlib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5894	KiB	nativesdk-libcrypto3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4428	KiB	nativesdk-libc6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3248	KiB	nativesdk-erlang-compiler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3163	KiB	nativesdk-erlang-snmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2890	KiB	nativesdk-glibc-binary-localedata-en-us.utf-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2868	KiB	nativesdk-erlang-kernel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2681	KiB	nativesdk-erlang-public-key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2511	KiB	nativesdk-libstdc++6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2254	KiB	nativesdk-erlang-ssl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1971	KiB	nativesdk-erlang-xmerl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1893	KiB	nativesdk-erlang-common-test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1459	KiB	nativesdk-erlang-dialyzer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1267	KiB	nativesdk-erlang-ssh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1246	KiB	nativesdk-erlang-asn1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1158	KiB	nativesdk-erlang-mnesia</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1137	KiB	nativesdk-erlang-diameter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">848	KiB	nativesdk-erlang-inets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">699	KiB	nativesdk-erlang-tools</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">594	KiB	nativesdk-erlang-edoc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">472	KiB	nativesdk-erlang-emacs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">467	KiB	nativesdk-erlang-reltool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">449	KiB	nativesdk-erlang-syntax-tools</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">401	KiB	nativesdk-erlang-sasl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">348	KiB	nativesdk-erlang-crypto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">328	KiB	nativesdk-erlang-runtime-tools</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">261	KiB	nativesdk-erlang-parsetools</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">220	KiB	nativesdk-erlang-eunit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">200	KiB	nativesdk-libtinfo5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">177	KiB	nativesdk-erlang-eldap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">175	KiB	nativesdk-libgcc1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">159	KiB	nativesdk-erlang-os-mon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">139	KiB	nativesdk-openssl-ossl-module-legacy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">124	KiB	nativesdk-erlang-erl-interface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">123	KiB	nativesdk-erlang-tftp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">115	KiB	nativesdk-erlang-ftp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">102	KiB	nativesdk-libz1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">85	KiB	nativesdk-erlang-typer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">66	KiB	nativesdk-erlang-epmd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">26	KiB	nativesdk-ncurses-terminfo-base</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">24	KiB	nativesdk-openssl-conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0	KiB	nativesdk-sdk-provides-dummy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0	KiB	nativesdk-erlang-modules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0	KiB	nativesdk-erlang-erl-docgen</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0	KiB	nativesdk-erlang</span><br></span></code></pre></div></div>
<p>On this Erlang/OTP installation, I did not enabled wx (wxwidget), odbc, lkscp
options. And all Erlang/OTP modules have been installed. It's a pretty generic
installation, though.</p>
<p>Some additional Yocto configuration for reducing size were applied. Like the
following:</p>
<ul>
<li class="">
<p>Disable locales:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ENABLE_BINARY_LOCALE_GENERATION       = "1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOCALE_GENERATION_WITH_CROSS_LOCALEDEF = "1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GLIBC_INTERNAL_USE_BINARY_LOCALE     = "compile"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GLIBC_GENERATE_LOCALES                = "en_US.UTF-8"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IMAGE_LINGUAS                         = "en-us"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOCALE_UTF8_ONLY      = "1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOCALE_UTF8_IS_DEFAULT = "1"</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>Use musl:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">TCLIBC = "musl"</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>Disable opengl support:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">DISTRO_FEATURES_FILTER_NATIVESDK:remove = "opengl"</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>Optional: disable termcap (reducing ~300KB)</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PACKAGECONFIG:remove:pn-nativesdk-erlang = "termcap"</span><br></span></code></pre></div></div>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="next-steps-and-ideas">Next steps and ideas<a href="https://meta-erlang.github.io/blog/2025/09/25/index/#next-steps-and-ideas" class="hash-link" aria-label="Direct link to Next steps and ideas" title="Direct link to Next steps and ideas" translate="no">‚Äã</a></h2>
<ul>
<li class="">Provide musl and glibc beamruntime packages for testing. Both versions of
beamruntime work as expected.</li>
<li class="">Enable static build, what would be the final footprint ?</li>
<li class="">Make beamruntime a bit more generic like adding odbc, lksctp ?</li>
<li class="">Or make it less generic removing some erlang application that does not make
sense for runtime. Like: dialyzer, edoc, emacs, typer</li>
<li class="">What does mean generic nowadays ? Providing a generic beamruntime is feasible
and if a specific user wants to add or remove components it could be easily
done building a beamruntime itself.</li>
<li class="">How beamruntime could be useful for tools that expect a Erlang/OTP
installation on the target host ?</li>
</ul>]]></content>
        <author>
            <name>Jo√£o Henrique Ferreira de Freitas</name>
            <uri>https://github.com/joaohf</uri>
        </author>
        <category label="meta-erlang" term="meta-erlang"/>
        <category label="beamruntime" term="beamruntime"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Erlang-Red, recipe introduction]]></title>
        <id>https://meta-erlang.github.io/blog/2025/07/27/index/</id>
        <link href="https://meta-erlang.github.io/blog/2025/07/27/index/"/>
        <updated>2025-07-27T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Erlang-Red is an experimental Erlang]]></summary>
        <content type="html"><![CDATA[<p><a href="https://github.com/gorenje/erlang-red" target="_blank" rel="noopener noreferrer" class="">Erlang-Red</a> is an experimental Erlang
backend to replace <a href="https://nodered.org/" target="_blank" rel="noopener noreferrer" class="">Node-RED</a>. This blog post introduces
the erlang-red recipe available in meta-erlang layer.</p>
<p>The purpose here is to get a virtual environment with Erlang-Red installed where
it is possible to start creating basic flow and explore possibilities using
Yocto and Erlang-Red.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="erlang-red">Erlang-Red<a href="https://meta-erlang.github.io/blog/2025/07/27/index/#erlang-red" class="hash-link" aria-label="Direct link to Erlang-Red" title="Direct link to Erlang-Red" translate="no">‚Äã</a></h2>
<p>According to <a href="https://github.com/gorenje/erlang-red" target="_blank" rel="noopener noreferrer" class="">Erlang-Red</a>, it is:</p>
<blockquote>
<p>Experimental Erlang backend to replace Node-REDs existing NodeJS backend,
aiming for 100% compatible with existing flow code.</p>
<p>The goal is bring the advantages of low-code visual flow-based programming to
a programming language that is designed for message passing and concurrency
from the ground up, hence Erlang. More details described in the corresponding
blog post.</p>
</blockquote>
<p>A few months ago I was reading <a href="https://erlangforums.com/" target="_blank" rel="noopener noreferrer" class="">Erlang Forums</a> when I
saw a thread about
<a href="https://erlangforums.com/t/erlang-red-erlang-interpreter-for-node-red-flow-code-visual-flow-based-programming/4678" target="_blank" rel="noopener noreferrer" class="">Erlang-RED - Erlang interpreter for Node-RED flow code (visual flow based programming)</a>.
It looked so fantastic that someone was trying to implement a new backend for
Node-RED, moreover it is written in Erlang/OTP.</p>
<p>In order to get a better view of Erlang-Red philosophy and internals I recommend
reading this blog post:
<a href="https://blog.openmindmap.org/erlang-red" target="_blank" rel="noopener noreferrer" class="">The Erlang-Red Project</a>.</p>
<p>I thought that writing an
<a href="https://layers.openembedded.org/layerindex/recipe/464852/" target="_blank" rel="noopener noreferrer" class="">Erlang-Red Yocto recipe</a>
could be useful for anyone interested in applying flow based programming in the
context of linux embedded projects.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-erlang-red-recipe">The Erlang-Red recipe<a href="https://meta-erlang.github.io/blog/2025/07/27/index/#the-erlang-red-recipe" class="hash-link" aria-label="Direct link to The Erlang-Red recipe" title="Direct link to The Erlang-Red recipe" translate="no">‚Äã</a></h2>
<p>As everything else in OpenEmbedded / Yocto land, it is necessary a recipe in
order to get any software installed in the final image built with Yocto. Some
recipes are easy, while others are more complicated. As Erlang-Red uses rebar3
as build tool, it was easy to build, release and package it using
<a href="https://github.com/meta-erlang/meta-erlang/blob/master/classes/rebar3.bbclass" target="_blank" rel="noopener noreferrer" class="">rebar3.bbclass</a>.</p>
<p>A full working
<a href="https://github.com/meta-erlang/meta-erlang/blob/master/recipes-extended/erlang-red/erlang-red_git.bb" target="_blank" rel="noopener noreferrer" class="">erlang-red bitbake recipe</a>
is now available on meta-erlang layer. And in the rest of this blog post I will
guide you to get a basic image working.</p>
<p>I have added erlang-red recipe to meta-erlang master branch. I did not test it
using others Yocto branches. But the recipe will work in other branches with
small fixes.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="setup-bitbake-and-yocto">Setup bitbake and Yocto<a href="https://meta-erlang.github.io/blog/2025/07/27/index/#setup-bitbake-and-yocto" class="hash-link" aria-label="Direct link to Setup bitbake and Yocto" title="Direct link to Setup bitbake and Yocto" translate="no">‚Äã</a></h2>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>This is the point where reading the
<a href="https://docs.yoctoproject.org/brief-yoctoprojectqs/index.html" target="_blank" rel="noopener noreferrer" class="">Yocto Project Quick Build</a>
documentation can help to understand basic principles. In this section I
extracted the commands that I used to run this use case.</p></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="fetching-source-code">Fetching source code<a href="https://meta-erlang.github.io/blog/2025/07/27/index/#fetching-source-code" class="hash-link" aria-label="Direct link to Fetching source code" title="Direct link to Fetching source code" translate="no">‚Äã</a></h3>
<p>Cloning all repositories for master branch:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master git://git.yoctoproject.org/poky</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/meta-erlang/meta-erlang</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="sourcing-build-environment">Sourcing build environment<a href="https://meta-erlang.github.io/blog/2025/07/27/index/#sourcing-build-environment" class="hash-link" aria-label="Direct link to Sourcing build environment" title="Direct link to Sourcing build environment" translate="no">‚Äã</a></h3>
<p>Source the init build environment script:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> poky</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> oe-init-build-env </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/build</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="adding-meta-erlang-layer">Adding meta-erlang layer<a href="https://meta-erlang.github.io/blog/2025/07/27/index/#adding-meta-erlang-layer" class="hash-link" aria-label="Direct link to Adding meta-erlang layer" title="Direct link to Adding meta-erlang layer" translate="no">‚Äã</a></h3>
<p>Add the needed layers:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-erlang</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="configuring-the-build-environment">Configuring the build environment<a href="https://meta-erlang.github.io/blog/2025/07/27/index/#configuring-the-build-environment" class="hash-link" aria-label="Direct link to Configuring the build environment" title="Direct link to Configuring the build environment" translate="no">‚Äã</a></h3>
<p>For this use case, the quickest way is to edit and add some snippets in the
configuration file: <em>conf/local.conf</em>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># select which machine we want to build</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MACHINE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"qemuriscv32"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># systemd only</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INIT_MANAGER </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"systemd"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># install erlang-red when creating an image</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IMAGE_INSTALL:append </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">" erlang-red"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># additional QEMU configuration for slirp mode, export 8080 tcp port</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">QB_SLIRP_OPT </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"-netdev user,id=net0,hostfwd=tcp::8080-:8080,hostfwd=tcp::2222-:22"</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="build-erlang-red-recipe">Build erlang-red recipe<a href="https://meta-erlang.github.io/blog/2025/07/27/index/#build-erlang-red-recipe" class="hash-link" aria-label="Direct link to Build erlang-red recipe" title="Direct link to Build erlang-red recipe" translate="no">‚Äã</a></h3>
<p>Right, the environment is configured. Have sourced the <code>oe-init-build-env</code>, we
can build erlang-red recipe:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake erlang-red</span><br></span></code></pre></div></div>
<p>This bitbake command will build erlang-red and all its building dependencies.</p>
<p>But to get something useful, we need to also build an image.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="a-basic-image-with-erlang-red-enabled">A basic image with erlang-red enabled<a href="https://meta-erlang.github.io/blog/2025/07/27/index/#a-basic-image-with-erlang-red-enabled" class="hash-link" aria-label="Direct link to A basic image with erlang-red enabled" title="Direct link to A basic image with erlang-red enabled" translate="no">‚Äã</a></h2>
<p>Next, we need to build the final image:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake core-image-full-cmdline</span><br></span></code></pre></div></div>
<p>Because we have added erlang-red to <code>IMAGE_INSTALL</code>, the build image process
will install erlang-red.</p>
<p>With image ready, it is time to run it.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="running-erlang-red-with-qemu-emulator">Running erlang-red with QEMU emulator<a href="https://meta-erlang.github.io/blog/2025/07/27/index/#running-erlang-red-with-qemu-emulator" class="hash-link" aria-label="Direct link to Running erlang-red with QEMU emulator" title="Direct link to Running erlang-red with QEMU emulator" translate="no">‚Äã</a></h2>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">runqemu core-image-full-cmdline serialstdio nographic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Poky </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Yocto Project Reference Distro</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5.2</span><span class="token plain">.99+snapshot-bd4625cd4db0f02162092d85aeab3023914f768a qemuriscv32 ttyS0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qemuriscv32 login: root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: Poky is a reference Yocto Project distribution that should be used </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">testing and development purposes only. It is recommended that you create your</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">own distribution </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> production use.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@qemuriscv32:~</span><span class="token comment" style="color:#999988;font-style:italic">#</span><br></span></code></pre></div></div>
<p>I used the arguments <code>serialstdio</code>, to enable a serial console input attached to
stdio; and <code>nographic</code> to avoid starting QEMU GUI frontend.</p>
<p>In a new terminal, let's open a ssh session and start erlang-red using systemctl
command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">ssh</span><span class="token plain"> root@192.168.7.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Last login: Fri Aug  </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">18</span><span class="token plain">:50:29 </span><span class="token number" style="color:#36acaa">2025</span><span class="token plain"> from </span><span class="token number" style="color:#36acaa">172.17</span><span class="token plain">.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: Poky is a reference Yocto Project distribution that should be used </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">testing and development purposes only. It is recommended that you create your</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">own distribution </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> production use.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@qemuriscv32:~</span><span class="token comment" style="color:#999988;font-style:italic"># systemctl status erlang-red</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚óè erlang-red.service - Breadboard Programming </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> Erlang inspired by Node-RED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Loaded: loaded </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">/usr/lib/systemd/system/erlang-red.service</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> enabled</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> preset: enabled</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Active: active </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">running</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> since Fri </span><span class="token number" style="color:#36acaa">2025</span><span class="token plain">-08-01 </span><span class="token number" style="color:#36acaa">18</span><span class="token plain">:49:45 UTC</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 55s ago</span><br></span></code></pre></div></div>
<p>Great, erlang-red is up and running.</p>
<p>In the host, open a browser at <a href="http://192.168.7.2:8080/erlang-red" target="_blank" rel="noopener noreferrer" class="">http://192.168.7.2:8080/erlang-red</a> to see the
erlang-red web interface.</p>
<p>Well, now it is the right time to learn about flow based programming and start
playing with erlang-red.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="erlang-red-runtime-analysis">Erlang-Red runtime analysis<a href="https://meta-erlang.github.io/blog/2025/07/27/index/#erlang-red-runtime-analysis" class="hash-link" aria-label="Direct link to Erlang-Red runtime analysis" title="Direct link to Erlang-Red runtime analysis" translate="no">‚Äã</a></h2>
<p>The Erlang-Red performance is relative as there is no much to say when emulating
using QEMU without KVM to improve performance. Some rough analises below:</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-about-the-disk-footprint-">What about the disk footprint ?<a href="https://meta-erlang.github.io/blog/2025/07/27/index/#what-about-the-disk-footprint-" class="hash-link" aria-label="Direct link to What about the disk footprint ?" title="Direct link to What about the disk footprint ?" translate="no">‚Äã</a></h3>
<p>The total erlang-red footprint is about 35Mb of disk space. It includes the ERTS
(Erlang Runtime System) and all Erlang/Elixir dependencies. All files installed
on <code>/usr/lib/erlang-red</code> folder. The erlang-red package also provides systemV
and systemd start/stop scripts.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="and-about-memory-footprint-">And about memory footprint ?<a href="https://meta-erlang.github.io/blog/2025/07/27/index/#and-about-memory-footprint-" class="hash-link" aria-label="Direct link to And about memory footprint ?" title="Direct link to And about memory footprint ?" translate="no">‚Äã</a></h3>
<p>In this use case I used systemd because I want to get the memory footprint that
systemd was reporting:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@qemuriscv32:~</span><span class="token comment" style="color:#999988;font-style:italic"># systemctl status erlang-red</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">‚óè erlang-red.service - Breadboard Programming </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> Erlang inspired by Node-RED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Loaded: loaded </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">/usr/lib/systemd/system/erlang-red.service</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> enabled</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> preset: enabled</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Active: active </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">running</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> since Fri </span><span class="token number" style="color:#36acaa">2025</span><span class="token plain">-08-01 </span><span class="token number" style="color:#36acaa">18</span><span class="token plain">:49:45 UTC</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 55s ago</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Invocation: 704b9bef5b384451932e15cadb7291fa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Main PID: </span><span class="token number" style="color:#36acaa">322</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">beam.smp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Tasks: </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">limit: </span><span class="token number" style="color:#36acaa">4915</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Memory: </span><span class="token number" style="color:#36acaa">69</span><span class="token plain">.7M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">peak: </span><span class="token number" style="color:#36acaa">75</span><span class="token plain">.4M</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CPU: </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">.751s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     CGroup: /system.slice/erlang-red.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             ‚îú‚îÄ322 /usr/lib/erlang-red/bin/erlang_red </span><span class="token parameter variable" style="color:#36acaa">-Bd</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-C</span><span class="token plain"> multi_time_warp -- </span><span class="token parameter variable" style="color:#36acaa">-root</span><span class="token plain"> /usr/lib/erlang-red </span><span class="token parameter variable" style="color:#36acaa">-bindir</span><span class="token plain"> /usr/lib/erlang-red/erts-16.0.1/bin </span><span class="token parameter variable" style="color:#36acaa">-progname</span><span class="token plain"> usr/lib/erlang-red/bin/erlang_red -- </span><span class="token parameter variable" style="color:#36acaa">-home</span><span class="token plain"> /var/lib/erlang</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             ‚îú‚îÄ380 /usr/lib/erlang-red/erts-16.0.1/bin/epmd </span><span class="token parameter variable" style="color:#36acaa">-daemon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             ‚îú‚îÄ435 erl_child_setup </span><span class="token number" style="color:#36acaa">1024</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             ‚îî‚îÄ458 /usr/lib/erlang-red/lib/erlexec-2.2.0/priv/x86_64-pc-linux-gnu/exec-port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Aug 01 </span><span class="token number" style="color:#36acaa">18</span><span class="token plain">:49:45 qemuriscv32 systemd</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: Started Breadboard Programming </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> Erlang inspired by Node-RED.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Aug 01 </span><span class="token number" style="color:#36acaa">18</span><span class="token plain">:49:47 qemuriscv32 erlang_red</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">322</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: Exec: /usr/lib/erlang-red/erts-16.0.1/bin/erlexec </span><span class="token parameter variable" style="color:#36acaa">-noinput</span><span class="token plain"> +Bd </span><span class="token parameter variable" style="color:#36acaa">-boot</span><span class="token plain"> /usr/lib/erlang-red/releases/0.2.2/start </span><span class="token parameter variable" style="color:#36acaa">-mode</span><span class="token plain"> embedded </span><span class="token parameter variable" style="color:#36acaa">-boot_var</span><span class="token plain"> SYSTEM_LIB_DIR /usr/lib/erlang-red/lib</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Aug 01 </span><span class="token number" style="color:#36acaa">18</span><span class="token plain">:49:47 qemuriscv32 erlang_red</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">322</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: Root: /usr/lib/erlang-red</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Aug 01 </span><span class="token number" style="color:#36acaa">18</span><span class="token plain">:49:47 qemuriscv32 erlang_red</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">322</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: /usr/lib/erlang-red</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Aug 01 </span><span class="token number" style="color:#36acaa">18</span><span class="token plain">:49:50 qemuriscv32 erlang_red</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">322</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">: warning: the VM is running with native name encoding of latin1 </span><span class="token function" style="color:#d73a49">which</span><span class="token plain"> may cause Elixir to malfunction as it expects utf8. Please ensure your locale is </span><span class="token builtin class-name">set</span><span class="token plain"> to UTF-8 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">which can</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lines </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">-19/19 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">END</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>So, 69.7M is the memory consumption.</p>
<p>As Erlang-Red is in it's early development stages, I believe that are open space
for code optimization for reducing memory usage and also for tuning ERTS for the
Erlang-Red use case.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-has-next-">What has next ?<a href="https://meta-erlang.github.io/blog/2025/07/27/index/#what-has-next-" class="hash-link" aria-label="Direct link to What has next ?" title="Direct link to What has next ?" translate="no">‚Äã</a></h2>
<p>As a next project, I wish to install erlang-red into a Raspberry Pi platform and
control some external hardware. This is a pretty common scenario and let's see
how feasible it is with Erlang-Red.</p>]]></content>
        <author>
            <name>Jo√£o Henrique Ferreira de Freitas</name>
            <uri>https://github.com/joaohf</uri>
        </author>
        <category label="meta-erlang" term="meta-erlang"/>
        <category label="erlang-red" term="erlang-red"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[autotools as build tool for Erlang/OTP projects]]></title>
        <id>https://meta-erlang.github.io/blog/2025/05/11/index/</id>
        <link href="https://meta-erlang.github.io/blog/2025/05/11/index/"/>
        <updated>2025-05-11T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[The]]></summary>
        <content type="html"><![CDATA[<p>The
<a href="https://github.com/meta-erlang/hello-world/tree/master/hello-erlang-autoconf" target="_blank" rel="noopener noreferrer" class="">hello-erlang-autoconf</a>
repository is an example about how to use autotools as build tool for Erlang/OTP
projects. The original code came from <a href="https://github.com/sirbeancounter/hello" target="_blank" rel="noopener noreferrer" class="">https://github.com/sirbeancounter/hello</a>. I
just adapted it and fixed small issues for Yocto integration.</p>
<p>The result was the creating of a recipe called
<a href="https://github.com/meta-erlang/meta-erlang/blob/master/recipes-examples/hello-erlang-autoconf/hello-erlang-autoconf_0.1.0.bb" target="_blank" rel="noopener noreferrer" class="">hello-erlang-autoconf</a>
as an example about how to integrate autotools with erlang build. This recipe is
very interesting because it inherit the class <code>autotools</code> which is a standard
class from openembedded-core.</p>
<p>autotools provides support for building Erlang projects:
<a href="https://www.gnu.org/software/autoconf/manual/autoconf-2.72/html_node/Erlang-Libraries.html" target="_blank" rel="noopener noreferrer" class="">Erlang-Libraries</a>
and I've found a talk about:
<a href="https://erlang.org/euc/06/proceedings/1430Lenglet.ppt" target="_blank" rel="noopener noreferrer" class="">Using GNU Autoconf to Configure Erlang Programs</a>.
It looks like using autotools is something that could save time as build tool.</p>
<p>I think the final result for the recipe
<a href="https://github.com/meta-erlang/meta-erlang/blob/master/recipes-examples/hello-erlang-autoconf/hello-erlang-autoconf_0.1.0.bb" target="_blank" rel="noopener noreferrer" class="">hello-erlang-autoconf</a>
was very short and easy to customize. Moreover, as autotools is pretty standard
for configuring and building software package it brings solid foundations too.</p>
<p>I'm not saying that autotools is easy to learn or it is the best tool. But
something to consider.</p>
<p>After building the recipe <code>bitbake hello-erlang-autoconf</code> and with buildhistory
enabled it is possible to inspect the size of each dependency.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Enabled in <code>local.conf</code>:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">USER_CLASSES ?= "buildhistory buildstats"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BUILDHISTORY_COMMIT = "1"</span><br></span></code></pre></div></div></div></div>
<p>Starting with <em>hello-erlang-autoconf</em> package it says:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> buildhistory/packages/riscv32imafdc-poky-linux/hello-erlang-autoconf/hello-erlang-autoconf/latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PV </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.1</span><span class="token plain">.0+git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PR </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> r0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PKGV </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.1</span><span class="token plain">.0+git0+6c7f37489e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RPROVIDES </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RDEPENDS </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> erlang-epmd erlang-erts erlang-kernel erlang-stdlib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RRECOMMENDS </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PKGSIZE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12705</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FILES </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> /usr/lib/erlang/lib/hello-*/ebin /etc/hello.d /etc/hello.d/hello.boot /etc/init.d/hello.otp.system /usr/bin/hello.start /usr/bin/hello.stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FILELIST </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> /etc/hello.d/hello.boot /etc/hello.d/hello.config /etc/init.d/hello.otp.system /usr/bin/hello.start /usr/bin/hello.stop /usr/lib/erlang/lib/hello-6c7f374/ebin/hello.app /usr/lib/erlang/lib/hello-6c7f374/ebin/hello.beam /usr/lib/erlang/lib/hello-6c7f374/ebin/hello_app.beam /usr/lib/erlang/lib/hello-6c7f374/ebin/hello_sup.beam</span><br></span></code></pre></div></div>
<p>Looking into <code>RDEPENDS</code> it is clear what are necessary to be installed in order
to run hello-erlang-autoconf application:</p>
<!-- -->
<p>A close look into all installed files by hellor-erlang-autoconf:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> buildhistory/packages/riscv32imafdc-poky-linux/hello-erlang-autoconf/hello-erlang-autoconf/files-in-package.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> ./etc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> ./etc/hello.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- root       root             </span><span class="token number" style="color:#36acaa">7550</span><span class="token plain"> ./etc/hello.d/hello.boot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x root       root               </span><span class="token number" style="color:#36acaa">63</span><span class="token plain"> ./etc/hello.d/hello.config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> ./etc/init.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">1525</span><span class="token plain"> ./etc/init.d/hello.otp.system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> ./usr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> ./usr/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x root       root              </span><span class="token number" style="color:#36acaa">370</span><span class="token plain"> ./usr/bin/hello.start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x root       root              </span><span class="token number" style="color:#36acaa">506</span><span class="token plain"> ./usr/bin/hello.stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> ./usr/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> ./usr/lib/erlang</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> ./usr/lib/erlang/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> ./usr/lib/erlang/lib/hello-6c7f374</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> ./usr/lib/erlang/lib/hello-6c7f374/ebin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- root       root              </span><span class="token number" style="color:#36acaa">231</span><span class="token plain"> ./usr/lib/erlang/lib/hello-6c7f374/ebin/hello.app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- root       root              </span><span class="token number" style="color:#36acaa">636</span><span class="token plain"> ./usr/lib/erlang/lib/hello-6c7f374/ebin/hello_app.beam</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- root       root             </span><span class="token number" style="color:#36acaa">1024</span><span class="token plain"> ./usr/lib/erlang/lib/hello-6c7f374/ebin/hello.beam</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- root       root              </span><span class="token number" style="color:#36acaa">800</span><span class="token plain"> ./usr/lib/erlang/lib/hello-6c7f374/ebin/hello_sup.beam</span><br></span></code></pre></div></div>
<p>A few files. Just .beam objects and start scripts. An interesting fact, the
following files:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> ./usr/lib/erlang/lib/hello-6c7f374</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> ./usr/lib/erlang/lib/hello-6c7f374/ebin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- root       root              </span><span class="token number" style="color:#36acaa">231</span><span class="token plain"> ./usr/lib/erlang/lib/hello-6c7f374/ebin/hello.app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- root       root              </span><span class="token number" style="color:#36acaa">636</span><span class="token plain"> ./usr/lib/erlang/lib/hello-6c7f374/ebin/hello_app.beam</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- root       root             </span><span class="token number" style="color:#36acaa">1024</span><span class="token plain"> ./usr/lib/erlang/lib/hello-6c7f374/ebin/hello.beam</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- root       root              </span><span class="token number" style="color:#36acaa">800</span><span class="token plain"> ./usr/lib/erlang/lib/hello-6c7f374/ebin/hello_sup.beam</span><br></span></code></pre></div></div>
<p>Get installed inside <em>/usr/lib/erlang/lib/</em>, this is where the standard
Erlang/OTP is installed by erlang recipe from meta-erlang layer.</p>
<p>More details about all erlang-* dependencies:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> buildhistory/packages/riscv32imafdc-poky-linux/erlang/erlang-epmd/latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PV </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">28.0</span><span class="token plain">.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PR </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> r0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RPROVIDES </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RDEPENDS </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> base-files base-passwd glibc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.41</span><span class="token plain">+git0+6e489c17f8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> libsystemd </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">257.6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> shadow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RRECOMMENDS </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PKGSIZE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">47150</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FILES </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> /usr/lib/erlang/erts-*/bin/epmd /usr/lib/erlang/bin/epmd /usr/bin/epmd /usr/lib/systemd/system/epmd.service /usr/lib/systemd/system/epmd.socket /etc/init.d /usr/lib/systemd/system-preset/98-erlang-epmd.preset /usr/lib/systemd/system/epmd.service /usr/lib/systemd/system/epmd.socket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FILELIST </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> /usr/bin/epmd /usr/lib/erlang/bin/epmd /usr/lib/erlang/erts-16.0.1/bin/epmd /usr/lib/systemd/system-preset/98-erlang-epmd.preset /usr/lib/systemd/system/epmd.service /usr/lib/systemd/system/epmd.socket</span><br></span></code></pre></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> buildhistory/packages/riscv32imafdc-poky-linux/erlang/erlang-erts/latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PV </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">28.0</span><span class="token plain">.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PR </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> r0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RPROVIDES </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RDEPENDS </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> glibc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.41</span><span class="token plain">+git0+6e489c17f8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ncurses-libtinfo </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6.5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> zlib </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.3</span><span class="token plain">.1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RRECOMMENDS </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PKGSIZE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4690380</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FILES </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> /usr/bin /usr/lib/erlang/releases /usr/lib/erlang/bin /usr/lib/erlang/erts-*/bin /usr/lib/erlang/lib/erts-*/ebin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FILELIST </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> /usr/bin/erl /usr/bin/escript /usr/bin/run_erl /usr/bin/to_erl /usr/lib/erlang/bin/erl /usr/lib/erlang/bin/erl_call /usr/lib/erlang/bin/escript /usr/lib/erlang/bin/no_dot_erlang.boot /usr/lib/erlang/bin/run_erl /usr/lib/erlang/bin/start /usr/lib/erlang/bin/start.boot /usr/lib/erlang/bin/start.script /usr/lib/erlang/bin/start_clean.boot /usr/lib/erlang/bin/start_erl /usr/lib/erlang/bin/start_sasl.boot /usr/lib/erlang/bin/to_erl /usr/lib/erlang/erts-16.0.1/bin/beam.smp /usr/lib/erlang/erts-16.0.1/bin/dyn_erl /usr/lib/erlang/erts-16.0.1/bin/erl /usr/lib/erlang/erts-16.0.1/bin/erl.src /usr/lib/erlang/erts-16.0.1/bin/erl_call /usr/lib/erlang/erts-16.0.1/bin/erl_child_setup /usr/lib/erlang/erts-16.0.1/bin/erlexec /usr/lib/erlang/erts-16.0.1/bin/escript /usr/lib/erlang/erts-16.0.1/bin/heart /usr/lib/erlang/erts-16.0.1/bin/inet_gethost /usr/lib/erlang/erts-16.0.1/bin/run_erl /usr/lib/erlang/erts-16.0.1/bin/start /usr/lib/erlang/erts-16.0.1/bin/start.src /usr/lib/erlang/erts-16.0.1/bin/start_erl.src /usr/lib/erlang/erts-16.0.1/bin/to_erl /usr/lib/erlang/releases/28/OTP_VERSION /usr/lib/erlang/releases/28/installed_application_versions /usr/lib/erlang/releases/28/no_dot_erlang.boot /usr/lib/erlang/releases/28/no_dot_erlang.rel /usr/lib/erlang/releases/28/no_dot_erlang.script /usr/lib/erlang/releases/28/start.boot /usr/lib/erlang/releases/28/start.script /usr/lib/erlang/releases/28/start_all_example.rel /usr/lib/erlang/releases/28/start_clean.boot /usr/lib/erlang/releases/28/start_clean.rel /usr/lib/erlang/releases/28/start_clean.script /usr/lib/erlang/releases/28/start_sasl.boot /usr/lib/erlang/releases/28/start_sasl.rel /usr/lib/erlang/releases/28/start_sasl.script /usr/lib/erlang/releases/RELEASES /usr/lib/erlang/releases/RELEASES.src /usr/lib/erlang/releases/start_erl.data</span><br></span></code></pre></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> buildhistory/packages/riscv32imafdc-poky-linux/erlang/erlang-kernel/latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PV </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">28.0</span><span class="token plain">.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PR </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> r0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RPROVIDES </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RDEPENDS </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RRECOMMENDS </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PKGSIZE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2931802</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FILES </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> /usr/lib/erlang/lib/kernel-*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FILELIST </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> /usr/lib/erlang/lib/kernel-10.3.1/ebin/application.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/application_controller.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/application_master.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/application_starter.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/auth.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/code.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/code_server.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/disk_log.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/disk_log_1.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/disk_log_server.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/disk_log_sup.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/dist_ac.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/dist_util.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/erl_boot_server.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/erl_compile_server.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/erl_ddll.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/erl_debugger.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/erl_distribution.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/erl_epmd.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/erl_erts_errors.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/erl_kernel_errors.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/erl_reply.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/erl_signal_handler.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/erpc.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/error_handler.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/error_logger.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/erts_debug.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/file.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/file_io_server.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/file_server.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/gen_sctp.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/gen_tcp.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/gen_tcp_socket.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/gen_udp.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/gen_udp_socket.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/global.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/global_group.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/global_search.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/group.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/group_history.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/heart.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/inet.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/inet6_sctp.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/inet6_tcp.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/inet6_tcp_dist.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/inet6_udp.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/inet_config.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/inet_db.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/inet_dns.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/inet_dns_tsig.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/inet_epmd_dist.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/inet_epmd_socket.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/inet_gethost_native.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/inet_hosts.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/inet_parse.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/inet_res.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/inet_sctp.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/inet_tcp.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/inet_tcp_dist.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/inet_udp.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/kernel.app /usr/lib/erlang/lib/kernel-10.3.1/ebin/kernel.appup /usr/lib/erlang/lib/kernel-10.3.1/ebin/kernel.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/kernel_config.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/kernel_refc.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/local_tcp.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/local_udp.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/logger.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/logger_backend.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/logger_config.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/logger_disk_log_h.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/logger_filters.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/logger_formatter.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/logger_h_common.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/logger_handler.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/logger_handler_watcher.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/logger_olp.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/logger_proxy.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/logger_server.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/logger_simple_h.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/logger_std_h.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/logger_sup.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/net.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/net_adm.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/net_kernel.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/os.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/pg.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/pg2.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/prim_tty.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/prim_tty_sighandler.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/ram_file.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/raw_file_io.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/raw_file_io_compressed.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/raw_file_io_deflate.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/raw_file_io_delayed.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/raw_file_io_inflate.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/raw_file_io_list.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/rpc.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/seq_trace.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/socket.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/standard_error.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/trace.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/user_drv.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/user_sup.beam /usr/lib/erlang/lib/kernel-10.3.1/ebin/wrap_log_reader.beam</span><br></span></code></pre></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> buildhistory/packages/riscv32imafdc-poky-linux/erlang/erlang-stdlib/latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PV </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">28.0</span><span class="token plain">.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PR </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> r0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RPROVIDES </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RDEPENDS </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RRECOMMENDS </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PKGSIZE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6571412</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FILES </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> /usr/lib/erlang/lib/stdlib-*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FILELIST </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> /usr/lib/erlang/lib/stdlib-7.0.1/ebin/argparse.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/array.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/base64.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/beam_lib.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/binary.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/c.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/calendar.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/dets.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/dets_server.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/dets_sup.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/dets_utils.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/dets_v9.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/dict.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/digraph.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/digraph_utils.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/edlin.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/edlin_context.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/edlin_expand.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/edlin_key.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/edlin_type_suggestion.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/epp.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/erl_abstract_code.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/erl_anno.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/erl_bits.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/erl_compile.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/erl_error.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/erl_eval.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/erl_expand_records.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/erl_features.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/erl_internal.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/erl_lint.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/erl_parse.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/erl_posix_msg.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/erl_pp.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/erl_scan.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/erl_stdlib_errors.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/erl_tar.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/error_logger_file_h.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/error_logger_tty_h.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/escript.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/ets.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/eval_bits.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/file_sorter.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/filelib.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/filename.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/gb_sets.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/gb_trees.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/gen.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/gen_event.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/gen_fsm.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/gen_server.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/gen_statem.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/io.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/io_lib.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/io_lib_format.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/io_lib_fread.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/io_lib_pretty.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/json.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/lists.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/log_mf_h.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/maps.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/math.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/ms_transform.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/orddict.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/ordsets.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/otp_internal.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/peer.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/pool.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/proc_lib.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/proplists.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/qlc.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/qlc_pt.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/queue.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/rand.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/random.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/re.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/sets.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/shell.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/shell_default.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/shell_docs.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/shell_docs_markdown.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/shell_docs_test.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/slave.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/sofs.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/stdlib.app /usr/lib/erlang/lib/stdlib-7.0.1/ebin/stdlib.appup /usr/lib/erlang/lib/stdlib-7.0.1/ebin/string.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/supervisor.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/supervisor_bridge.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/sys.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/timer.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/unicode.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/unicode_util.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/uri_string.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/win32reg.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/zip.beam /usr/lib/erlang/lib/stdlib-7.0.1/ebin/zstd.beam</span><br></span></code></pre></div></div>
<p>Based on PKGSIZE for each package, we have the following graph showing which
package consumes more space:</p>
<!-- -->
<table><thead><tr><th>Package</th><th>Size</th></tr></thead><tbody><tr><td>hellow-erlang-autoconf</td><td>12705</td></tr><tr><td>erlang-epmd</td><td>47150</td></tr><tr><td>erlang-kernel</td><td>2931802</td></tr><tr><td>erlang-erts</td><td>4690380</td></tr><tr><td>erlang-stdlib</td><td>6571412</td></tr><tr><td>Total</td><td>14253449</td></tr></tbody></table>
<p>So, almost 15Mb is necessary for a simple erlang application. Nowadays it is
almost nothing. But that raise some questions:</p>
<ol>
<li class="">Is that possible to reduce the size of ERTS ?<!-- -->
<ul>
<li class="">Maybe using some configure and build flags for better code optimization</li>
<li class="">Or even necessary detect which places in Erlang/OTP source code worth
optimizations</li>
</ul>
</li>
<li class="">Double check if debug symbols are present in each .beam file</li>
<li class="">erlang-stdlib is consuming most of the space. However, it has everything
needed for building applications. It's a fact.<!-- -->
<ul>
<li class="">Maybe there are open room for spliting erlang-stdlib in small libraries ?</li>
</ul>
</li>
</ol>]]></content>
        <author>
            <name>Jo√£o Henrique Ferreira de Freitas</name>
            <uri>https://github.com/joaohf</uri>
        </author>
        <category label="meta-erlang" term="meta-erlang"/>
        <category label="autotools" term="autotools"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[New Erlang releases 25.3.2.20, 26.2.5.11, 27.3.3]]></title>
        <id>https://meta-erlang.github.io/blog/2025/04/19/index/</id>
        <link href="https://meta-erlang.github.io/blog/2025/04/19/index/"/>
        <updated>2025-04-19T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Due CVE-2025-32433, more]]></summary>
        <content type="html"><![CDATA[<p>Due <a href="https://nvd.nist.gov/vuln/detail/CVE-2025-32433" target="_blank" rel="noopener noreferrer" class="">CVE-2025-32433</a>, more
details at
<a href="https://github.com/erlang/otp/security/advisories/GHSA-37cp-fgq5-7wc2" target="_blank" rel="noopener noreferrer" class="">Unauthenticated Remote Code Execution in Erlang/OTP SSH</a>,</p>
<p>we have updated the following new Erlang/OTP releases:</p>
<table><thead><tr><th>meta-erlang branch</th><th>Erlang/OTP version</th></tr></thead><tbody><tr><td>master</td><td>25.3.2.20, 26.2.5.11, 27.3.3</td></tr><tr><td>scarthgap</td><td>25.3.2.20, 26.2.5.11, 27.3.3</td></tr><tr><td>kirkstone</td><td>25.3.2.20, 26.2.5.11, 27.3.3</td></tr></tbody></table>]]></content>
        <author>
            <name>Jo√£o Henrique Ferreira de Freitas</name>
            <uri>https://github.com/joaohf</uri>
        </author>
        <category label="meta-erlang" term="meta-erlang"/>
        <category label="news" term="news"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[fwup for A/B image upgrades on raspberrypi machines with NervesCloud, part I]]></title>
        <id>https://meta-erlang.github.io/blog/2025/03/21/index/</id>
        <link href="https://meta-erlang.github.io/blog/2025/03/21/index/"/>
        <updated>2025-03-21T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This blog post introduces nerves-hub-link running on raspberrypi machines in]]></summary>
        <content type="html"><![CDATA[<p>This blog post introduces nerves-hub-link running on raspberrypi machines in
order to upgrade firmware via <a href="https://nervescloud.com/" target="_blank" rel="noopener noreferrer" class="">NervesCloud</a>.</p>
<p>On previous <a class="" href="https://meta-erlang.github.io/blog/tags/fwup/">blog posts about fwup</a>, we have explored and
tested using QEMU based machines. Now it's time to change the target and use a
real machine.</p>
<p>Nowadays, raspberrypi is an accessible development platform for prototyping and
why not for real use cases too.</p>
<p>On Yocto side, there is a stable layer called
<a href="https://github.com/agherzan/meta-raspberrypi" target="_blank" rel="noopener noreferrer" class="">meta-raspberrypi</a> which
implements many of raspberrypi boards.</p>
<p>The end goal is to update the target board using NervesCloud, the
<a class="" href="https://meta-erlang.github.io/blog/2025/01/26/index/">same way that was done using QEMU based machines</a>.</p>
<p>The focus of this post is about how to prepare a working Yocto setup for
raspberry context. I'll not show a demonstration this time, reserving it for the
next blog posts ;)</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="ypoe-setup">YP/OE Setup<a href="https://meta-erlang.github.io/blog/2025/03/21/index/#ypoe-setup" class="hash-link" aria-label="Direct link to YP/OE Setup" title="Direct link to YP/OE Setup" translate="no">‚Äã</a></h3>
<p>I'll try to simplify the YP/OE setup to just tree small steps:</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>This is the same steps taken for the previous blog post called
<a class="" href="https://meta-erlang.github.io/blog/2025/01/26/index/">fwup for A/B image upgrades on QEMU machines with NervesCloud, part III</a>.
But now, with one additional layer called
<a href="https://github.com/agherzan/meta-raspberrypi" target="_blank" rel="noopener noreferrer" class="">meta-raspberrypi</a>.</p><p>Also, removing the meta-qemu-bsp.</p></div></div>
<ol>
<li class="">
<p>Cloning all repositories for master release:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master git://git.yoctoproject.org/poky</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/openembedded/meta-openembedded.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/fwup-home/meta-fwup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/joaohf/meta-fwup-examples</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/meta-erlang/meta-erlang</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/meta-erlang/meta-axon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/joaohf/meta-nerves-hub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/agherzan/meta-raspberrypi</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>Source the init build environment script:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> poky</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> oe-init-build-env </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/build</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>Add the needed layers:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-openembedded/meta-oe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-fwup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-fwup-examples</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-nerves-hub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-raspberrypi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-axon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-erlang</span><br></span></code></pre></div></div>
</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="configuring-the-build-environment">Configuring the build environment<a href="https://meta-erlang.github.io/blog/2025/03/21/index/#configuring-the-build-environment" class="hash-link" aria-label="Direct link to Configuring the build environment" title="Direct link to Configuring the build environment" translate="no">‚Äã</a></h3>
<p>For this use case, the quickest way is edit and add the <em>conf/local.conf</em>
configuration file.</p>
<p>We start enabling some
<a href="https://docs.yoctoproject.org/5.0.7/dev-manual/building.html#building-images-for-multiple-targets-using-multiple-configurations" target="_blank" rel="noopener noreferrer" class="">multiconfig configurations</a>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">BBMULTICONFIG ?</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"\</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    raspberrypi0-wifi-nerves-hub-link \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    raspberrypi4-64-nerves-hub-link \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    raspberrypi5-nerves-hub-link \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">   "</span><br></span></code></pre></div></div>
<p>The layer meta-axon provides some samples for
<a href="https://github.com/meta-erlang/meta-axon/tree/master/conf/multiconfig" target="_blank" rel="noopener noreferrer" class="">raspberry configurations with nerves-hub enabled</a>.</p>
<p>multiconfig is useful because it simplify bitbake configurations when we have
many target boards. On my test setup I'm building for raspberrypi 0, 4 and 5.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="building-images">Building images<a href="https://meta-erlang.github.io/blog/2025/03/21/index/#building-images" class="hash-link" aria-label="Direct link to Building images" title="Direct link to Building images" translate="no">‚Äã</a></h3>
<p>Next, we need to build images:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake multiconfig:raspberrypi4-64-nerves-hub-link:core-image-base</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake multiconfig:raspberrypi5-nerves-hub-link:core-image-base</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake multiconfig:raspberrypi0-wifi-nerves-hub-link:core-image-base</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>core-image-base is being used here. It's suitable for raspberrypi.</p></div></div>
<p>After the above commands, the result are the following files:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tmp-raspberrypi0-wifi-glibc-nerves-hub-link/deploy/images/raspberrypi0-wifi/core-image-base-raspberrypi0-wifi.rootfs.fwup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tmp-raspberrypi4-64-glibc-nerves-hub-link/deploy/images/raspberrypi4-64/core-image-base-raspberrypi4-64.rootfs.fwup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tmp-raspberrypi5-glibc-nerves-hub-link/deploy/images/raspberrypi5/core-image-base-raspberrypi5.rootfs.fwup</span><br></span></code></pre></div></div>
<p>And are ready to flash into a bootable device.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="flashing-image">Flashing image<a href="https://meta-erlang.github.io/blog/2025/03/21/index/#flashing-image" class="hash-link" aria-label="Direct link to Flashing image" title="Direct link to Flashing image" translate="no">‚Äã</a></h3>
<p>Before running fwup commands:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake fwup-native -caddto_recipe_sysroot</span><br></span></code></pre></div></div>
<p>For each fwup image, and using <code>fwup</code> for flashing (one sdcard for each image):</p>
<p>rpi0:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">oe-run-native fwup-native \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fwup -a -d /dev/sdc \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -t complete \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -i tmp-raspberrypi0-wifi-glibc-nerves-hub-link/deploy/images/raspberrypi0-wifi/core-image-base-raspberrypi0-wifi.rootfs.fwup</span><br></span></code></pre></div></div>
<p>rpi4:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">oe-run-native fwup-native \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fwup -a -d /dev/sdc \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -t complete \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -i tmp-raspberrypi4-64-glibc-nerves-hub-link/deploy/images/raspberrypi4-64/core-image-base-raspberrypi4-64.rootfs.fwup</span><br></span></code></pre></div></div>
<p>rpi5:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">oe-run-native fwup-native \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fwup -a -d /dev/sdc \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -t complete \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -i tmp-raspberrypi5-glibc-nerves-hub-link/deploy/images/raspberrypi5/core-image-base-raspberrypi5.rootfs.fwup</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="and-booting">And booting<a href="https://meta-erlang.github.io/blog/2025/03/21/index/#and-booting" class="hash-link" aria-label="Direct link to And booting" title="Direct link to And booting" translate="no">‚Äã</a></h3>
<p>Just put the sdcard into raspiberrypi and boot. It should work as expected.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>I promised, for the next blog post I'll share a full demonstration</p></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="some-important-details-not-discussed-before">Some important details not discussed before<a href="https://meta-erlang.github.io/blog/2025/03/21/index/#some-important-details-not-discussed-before" class="hash-link" aria-label="Direct link to Some important details not discussed before" title="Direct link to Some important details not discussed before" translate="no">‚Äã</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="meta-nerves-hub">meta-nerves-hub<a href="https://meta-erlang.github.io/blog/2025/03/21/index/#meta-nerves-hub" class="hash-link" aria-label="Direct link to meta-nerves-hub" title="Direct link to meta-nerves-hub" translate="no">‚Äã</a></h3>
<p>The <a href="https://github.com/joaohf/meta-nerves-hub" target="_blank" rel="noopener noreferrer" class="">meta-nerves-hub</a> layer has a
recipe for
<a href="https://github.com/joaohf/meta-nerves-hub/tree/master/recipes-extended/nerves-hub-link_2.5.2.bb" target="_blank" rel="noopener noreferrer" class="">nerves-hub-link_2.5.2.bb</a>.
This recipe installs a standalone nerves-hub-link. I've tested the version 2.5.2
and it works for my initial goals.</p>
<p>However, the later nerves-hub-link versions are not prepared to run as
standalone application anymore. It needs to be part of a BEAM application in
order to be properly configured.</p>
<p>I've tested recent versions and ended up with nerves-hub-link fighting with
linux network stack; for instance trying to configure it where it should not or
using others ways to detect configurations.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>It's up to you when design Yocto based linux distributions select what network
manager best fits to your needs. Yocto gives to you many options as well a
default one.</p></div></div>
<p>So, the next organic step will be to implement a BEAM application that uses
nerves-hub-link. That would be a kind of nerves-hub-link-agent. I just want to
start it and play nice with linux network configuration stack.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="conclusions">Conclusions<a href="https://meta-erlang.github.io/blog/2025/03/21/index/#conclusions" class="hash-link" aria-label="Direct link to Conclusions" title="Direct link to Conclusions" translate="no">‚Äã</a></h2>
<p>So, this blog post was more to make a milestone for this trip. And we are
getting closer to get Yocto based linux distro full integrated with NervesCloud
without thinking too much.</p>]]></content>
        <author>
            <name>Jo√£o Henrique Ferreira de Freitas</name>
            <uri>https://github.com/joaohf</uri>
        </author>
        <category label="meta-erlang" term="meta-erlang"/>
        <category label="fwup" term="fwup"/>
        <category label="rpi" term="rpi"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[fwup for A/B image upgrades on QEMU machines with NervesCloud, part III]]></title>
        <id>https://meta-erlang.github.io/blog/2025/01/26/index/</id>
        <link href="https://meta-erlang.github.io/blog/2025/01/26/index/"/>
        <updated>2025-01-26T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This blog post shows how to use NervesCloud in order]]></summary>
        <content type="html"><![CDATA[<p>This blog post shows how to use <a href="https://nervescloud.com/" target="_blank" rel="noopener noreferrer" class="">NervesCloud</a> in order
to upgrade and manage linux images based on Yocto Project.</p>
<p>We will run this demonstration with QEMU ARM based machine prepared as a result
of previous blog post called
<a class="" href="https://meta-erlang.github.io/blog/2024/12/20/index/">fwup for A/B image upgrades on QEMU machines with fwup, part II</a>.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-is-nervescloud">What is NervesCloud<a href="https://meta-erlang.github.io/blog/2025/01/26/index/#what-is-nervescloud" class="hash-link" aria-label="Direct link to What is NervesCloud" title="Direct link to What is NervesCloud" translate="no">‚Äã</a></h2>
<p><a href="https://nervescloud.com/" target="_blank" rel="noopener noreferrer" class="">NervesCloud</a> is an instance of
<a href="https://github.com/nerves-hub" target="_blank" rel="noopener noreferrer" class="">NervesHub</a> based on cloud. It could be
considered NervesCloud as a SaaS for NervesHub. In that way, instead you having
to install and manage your own instance of NervesHub for
<a href="https://nerves-project.org/" target="_blank" rel="noopener noreferrer" class="">Nerves devices</a> management, NervesCloud takes care
of all the infrastructure and provides to you the benefits without worry with
details.</p>
<p>In this demonstration, we will use NervesCloud with a development account called
<em>Experiments</em>. As NervesCloud is a multi-tenant system, anyone can have an
account for real or development purposes.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>It's not part of this demonstration how to setup a NervesCloud account. However,
I would like to say thank you to NervesCloud team to take care of these details.</p></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="preparing-a-key-pair-for-firmware-signing">Preparing a key pair for firmware signing<a href="https://meta-erlang.github.io/blog/2025/01/26/index/#preparing-a-key-pair-for-firmware-signing" class="hash-link" aria-label="Direct link to Preparing a key pair for firmware signing" title="Direct link to Preparing a key pair for firmware signing" translate="no">‚Äã</a></h3>
<p>NervesCloud works with signed firmware images files. It's mandatory to signed
these images before uploading into NervesCloud.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>I expected that you have a working Elixir environment for the following steps.</p></div></div>
<p>Clone <a href="https://github.com/nerves-hub/nerves_hub_cli" target="_blank" rel="noopener noreferrer" class="">nerves_hub_cli</a> project:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/nerves-hub/nerves_hub_cli</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> nerves_hub_cli</span><br></span></code></pre></div></div>
<p>Let's start configuring two environment variable that nerver_hub_cli tool will
use:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">NERVES_HUB_ORG</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Experiments</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">NERVES_HUB_URI</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://devices.nervescloud.com</span><br></span></code></pre></div></div>
<p>Next, we need to create a key pair for signed fw files later. For that, we use
the subcommand <code>nerves_hub.key create</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mix  nerves_hub.key create QemuMachines1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NervesHub server: devices.nervescloud.com:443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NervesHub organization: Experiments</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Creating a firmware signing key pair named </span><span class="token string" style="color:#e3116c">'QemuMachines1'</span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The private key is stored locally and must be protected by a password.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">If you are sharing the firmware signing private key with others,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">please choose an appropriate password.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Signing key password </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'QemuMachines1'</span><span class="token builtin class-name">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Firmware public key written to </span><span class="token string" style="color:#e3116c">'/home/joaohf/.nerves-hub/keys/Experiments/QemuMachines1.pub'</span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Password-protected firmware private key written to </span><span class="token string" style="color:#e3116c">'/home/joaohf/.nerves-hub/keys/Experiments/QemuMachines1.priv'</span><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Registering the firmware signing public key </span><span class="token string" style="color:#e3116c">'QemuMachines1'</span><span class="token plain"> with NervesHub.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:35:09.524 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> POST https://devices.nervescloud.com/api/orgs/Experiments/keys -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">201</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">578.459</span><span class="token plain"> ms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:35:09.528 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> REQUEST </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">no query</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Authorization: token nhu_xyz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">name: </span><span class="token string" style="color:#e3116c">"QemuMachines1"</span><span class="token plain">, key: </span><span class="token string" style="color:#e3116c">"xyz"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;&lt;&lt;</span><span class="token plain"> RESPONSE </span><span class="token operator" style="color:#393A34">&lt;&lt;&lt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">date: Sun, 09 Feb </span><span class="token number" style="color:#36acaa">2025</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:35:08 GMT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">content-length: </span><span class="token number" style="color:#36acaa">86</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vary: accept-encoding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">content-type: application/json</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">charset</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cache-control: max-age</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, private, must-revalidate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">strict-transport-security: max-age</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">31536000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x-request-id: GCKrFDWwXjoGnjQAHQLx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server: Fly/1ab217aa </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2025</span><span class="token plain">-02-07</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">via: </span><span class="token number" style="color:#36acaa">1.1</span><span class="token plain"> fly.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fly-request-id: 01JKPDMBHQP83WW1971PCXC0FZ-gig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"data"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> %</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"key"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"xyz"</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">"name"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"QemuMachines1"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Success. Key information:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name:       QemuMachines1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public key: xyz</span><br></span></code></pre></div></div>
<p>The main outcome here is that the command <code>nerves_hub.key create</code> has created a
valide key pair called QemuMachines1. We also need to export this key pair to
something that Yocto can read later. For that, we use the command
<code>nerves_hub.key export</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mix nerves_hub.key </span><span class="token builtin class-name">export</span><span class="token plain"> QemuMachines1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NervesHub server: devices.nervescloud.com:443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NervesHub organization: Experiments</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Local signing key password </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'QemuMachines1'</span><span class="token builtin class-name">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Fwup keys exported to: /home/joaohf/.nerves-hub/nerves_hub-fwup-keys-Experiments-QemuMachines1.tar.gz</span><br></span></code></pre></div></div>
<p>That is great, the key pair QemuMachines1 is ready. We just need one small step
in order to extract two files from the tar.gz file:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /tmp/exported_keys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> zxf ~/.nerves-hub/nerves_hub-fwup-keys-Experiments-QemuMachines1.tar.gz </span><span class="token parameter variable" style="color:#36acaa">-C</span><span class="token plain"> /tmp/exported_keys</span><br></span></code></pre></div></div>
<p>And finally, we have the keys as expected:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-l</span><span class="token plain"> /tmp/exported_keys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> joaohf joaohf </span><span class="token number" style="color:#36acaa">88</span><span class="token plain"> fev  </span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">19</span><span class="token plain">:36 QemuMachines1.priv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> joaohf joaohf </span><span class="token number" style="color:#36acaa">44</span><span class="token plain"> fev  </span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">19</span><span class="token plain">:36 QemuMachines1.pub</span><br></span></code></pre></div></div>
<p>Keep QemuMachines1.priv and QemuMachines1.pub files around. We will need to
configure Yocto in order to make fwup signed firmwares automatically.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="upgradedowngrade-demonstration">Upgrade/Downgrade demonstration<a href="https://meta-erlang.github.io/blog/2025/01/26/index/#upgradedowngrade-demonstration" class="hash-link" aria-label="Direct link to Upgrade/Downgrade demonstration" title="Direct link to Upgrade/Downgrade demonstration" translate="no">‚Äã</a></h2>
<p>As always, I like to describe all steps. In case someone wants to try it. My
target here is to play with NervesCloud for upgrade -&gt; downgrade -&gt; upgrade
cycle.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="ypoe-setup">YP/OE Setup<a href="https://meta-erlang.github.io/blog/2025/01/26/index/#ypoe-setup" class="hash-link" aria-label="Direct link to YP/OE Setup" title="Direct link to YP/OE Setup" translate="no">‚Äã</a></h3>
<p>I'll try to simplify the YP/OE setup to just tree small steps:</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>This is the same steps taken for the previous blog post called
<a class="" href="https://meta-erlang.github.io/blog/2024/12/20/index/">fwup for A/B image upgrades on QEMU machines with fwup, part II</a>.
But now, with one additional layer called
<a href="https://github.com/joaohf/meta-nerves-hub" target="_blank" rel="noopener noreferrer" class="">meta-nerves_hub</a>.</p></div></div>
<ol>
<li class="">
<p>Cloning all repositories for master release:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master git://git.yoctoproject.org/poky</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/openembedded/meta-openembedded.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/fwup-home/meta-fwup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/joaohf/meta-fwup-examples</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/meta-erlang/meta-qemu-bsp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/meta-erlang/meta-erlang</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/meta-erlang/meta-axon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/joaohf/meta-nerves-hub</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>Source the init build environment script:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> poky</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> oe-init-build-env </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/build</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>Add the needed layers:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-openembedded/meta-oe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-fwup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-qemu-bsp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-fwup-examples</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-nerves-hub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-axon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-erlang</span><br></span></code></pre></div></div>
</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="configuring-the-build-environment">Configuring the build environment<a href="https://meta-erlang.github.io/blog/2025/01/26/index/#configuring-the-build-environment" class="hash-link" aria-label="Direct link to Configuring the build environment" title="Direct link to Configuring the build environment" translate="no">‚Äã</a></h3>
<p>For this use case, the quickest way is edit and add the <em>conf/local.conf</em>
configuration file.</p>
<p>We start defining the MACHINE and DISTRO:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MACHINE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"qemuarm64-uboot"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DISTRO </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"poky"</span><br></span></code></pre></div></div>
<p>The machine <em>qemuarm64-uboot</em> is provided by
<a href="https://github.com/meta-erlang/meta-qemu-bsp" target="_blank" rel="noopener noreferrer" class="">meta-qemu-bsp</a> layer. That
machine uses u-boot as bootloader.</p>
<p>As YP/OE supports many types of image outputs, we want to be specific here and
pick only the <em>fwup</em> type.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> conf/local.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># enable support for making fwup images</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">IMAGE_CLASSES += "image_types_fwup"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">IMAGE_FSTYPES = "fwup fwup.qcow2"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="configure-nervescloud-product-name">Configure NervesCloud product name<a href="https://meta-erlang.github.io/blog/2025/01/26/index/#configure-nervescloud-product-name" class="hash-link" aria-label="Direct link to Configure NervesCloud product name" title="Direct link to Configure NervesCloud product name" translate="no">‚Äã</a></h3>
<p>Edit the file <em>conf/local.conf</em> and overwrite the variable <code>FWUP_META_PRODUCT</code>
with the contents of NervesHub Cloud product. In my case the product name is
<em>YoctoFwup</em>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> conf/local.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># NervesHub product name</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">FWUP_META_PRODUCT = "YoctoFwup"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="configure-private-and-public-keys-for-fwup-tool">Configure private and public keys for fwup tool<a href="https://meta-erlang.github.io/blog/2025/01/26/index/#configure-private-and-public-keys-for-fwup-tool" class="hash-link" aria-label="Direct link to Configure private and public keys for fwup tool" title="Direct link to Configure private and public keys for fwup tool" translate="no">‚Äã</a></h3>
<p>The bbclass image<em>types_fwup.bbclass takes care of signing fwup images when the
variables <code>FWUP_PRIVATE_KEY_FILE</code> and <code>FWUP_PUBLIC_KEY_FILE</code> are available. For
this demonstration, we need to make signed .fw (firmware update files) images.
Let's add these two variables to _conf/local.conf</em> too:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> conf/local.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">FWUP_PRIVATE_KEY_FILE = "/tmp/exported_keys/QemuMachines1.priv"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">FWUP_PUBLIC_KEY_FILE = "/tmp/exported_keys/QemuMachines1.pub"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre></div></div>
<p>That is all for this step.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="build-fwup-firmware">Build fwup firmware<a href="https://meta-erlang.github.io/blog/2025/01/26/index/#build-fwup-firmware" class="hash-link" aria-label="Direct link to Build fwup firmware" title="Direct link to Build fwup firmware" translate="no">‚Äã</a></h3>
<p>In this experiment we will build two images. And, for each build, the variable
<code>FWUP_META_VERSION</code> will be changed.</p>
<p>Let's start creating an image that represents the version 1.0.1. Edit the file
<em>conf/local.conf</em> and add the following:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 1st build</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FWUP_META_VERSION </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1.0.1"</span><br></span></code></pre></div></div>
<p>Next, we need to build a new image:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake multiconfig:qemuarm64-uboot-nerves-hub-link:core-image-full-cmdline</span><br></span></code></pre></div></div>
<p>After this build, let's copy the signed fwup firmware image (*signed.fw) to a
temporary folder. For better organization, rename it adding the version "1.0.1":</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> tmp-qemuarm64-uboot-glibc-nerves-hub-link/deploy/images/qemuarm64-uboot/core-image-full-cmdline-qemuarm64-uboot.rootfs-20250126203524.fw </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /tmp/core-image-full-cmdline-qemuarm64-uboot.rootfs-20250126203524-1.0.1.signed.fw</span><br></span></code></pre></div></div>
<p>Ok. We got the version 1.0.1. Now, let's prepare the version 1.2.0.</p>
<p>Still in build folder, edit the file <em>conf/local.conf</em> and change the variable
<code>FWUP_META_VERSION</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 2nd build</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FWUP_META_VERSION </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"1.2.0"</span><br></span></code></pre></div></div>
<p>Build the new image:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake multiconfig:qemuarm64-uboot-nerves-hub-link:core-image-full-cmdline</span><br></span></code></pre></div></div>
<p>And when finished, copy the fwup firmware (*signed.fw) to a temporary folder.
Add to the filename the version "1.2.0":</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> tmp-qemuarm64-uboot-glibc-nerves-hub-link/deploy/images/qemuarm64-uboot/core-image-full-cmdline-qemuarm64-uboot.rootfs-20250126211722.fw </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /tmp/core-image-full-cmdline-qemuarm64-uboot.rootfs-20250126211722.1.2.0.signed.fw</span><br></span></code></pre></div></div>
<p>The final result is like that:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-l</span><span class="token plain"> /tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-rw-r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">229596347</span><span class="token plain"> jan </span><span class="token number" style="color:#36acaa">26</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">18</span><span class="token plain">:02 core-image-full-cmdline-qemuarm64-uboot.rootfs-20250126203524-1.0.1.signed.fw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-rw-r-- </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">229596346</span><span class="token plain"> jan </span><span class="token number" style="color:#36acaa">26</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">18</span><span class="token plain">:23 core-image-full-cmdline-qemuarm64-uboot.rootfs-20250126211722.1.2.0.signed.fw</span><br></span></code></pre></div></div>
<p>There are two signed fwup firmware images ready to be uploaded into Nerves
Cloud.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="fwup-firmware-upload">fwup firmware upload<a href="https://meta-erlang.github.io/blog/2025/01/26/index/#fwup-firmware-upload" class="hash-link" aria-label="Direct link to fwup firmware upload" title="Direct link to fwup firmware upload" translate="no">‚Äã</a></h3>
<p>The procedures to upload the fwup image is very simple. Inside the NervesCloud
web interface, go to 'Firmware' menu and use the button 'Upload Firmware' to
start uploading a new firmware file.</p>
<p>We'll need to upload both images (1.0.1 and 1.2.0) for the next exercises. The
final Firmware list pages should be something like that:</p>
<p><img decoding="async" loading="lazy" alt="alt Firmware listing" src="https://meta-erlang.github.io/assets/images/nhc_firmware_listing-d14863c8144ee28d8c00a79c581c9c56.png" title="Firmwares uploaded" width="1213" height="463" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="playing-with-upgrades">Playing with upgrades<a href="https://meta-erlang.github.io/blog/2025/01/26/index/#playing-with-upgrades" class="hash-link" aria-label="Direct link to Playing with upgrades" title="Direct link to Playing with upgrades" translate="no">‚Äã</a></h3>
<p>Now, it's time to observe and play with some upgrades and downgrades.</p>
<p>First, let's start runqemu with our last image build:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">runqemu  nographic serialstdio slirp </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">multiconfig:qemuarm64-uboot-nerves-hub-link:core-image-full-cmdline </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wic.qcow2 </span><span class="token assign-left variable" style="color:#36acaa">qemuparams</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"-m 1024"</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>In my case, the parameter <code>-m 1024</code> was necessary because my development images
were a bit oversized.</p></div></div>
<p>Inside QEMU instance, start nerves_cloud_link application:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/usr/lib/nerves-hub-link/bin/nerves_hub_link start_iex</span><br></span></code></pre></div></div>
<p>In NervesCloud web interface, check with the device has listed there:</p>
<p><img decoding="async" loading="lazy" alt="alt Device up" src="https://meta-erlang.github.io/assets/images/nhc_device_10_connected-7529f0457aa0a7c2c2858645a2286110.png" title="Device up with 1.2.0 version" width="1236" height="457" class="img_ev3q"></p>
<p>The 'Firmware' column should be pointing to '1.2.0' version (because this
version was the latest build).</p>
<p>For upgrade and downgrade using NervesCloud, there are some options like
creating a Deployment or send an update command to a specific device. In this
experiment, let's send update command.</p>
<p>We want to test the following scenarios:</p>
<ul>
<li class="">
<p>downgrade 1.2.0 -&gt; 1.0.1</p>
<p>Select the device that we want to work, in my case the device is '10'. And on
device administration page, select the firmware version that we want to send.
In this case it will be the version 1.0.1. And click on "Send update" button.</p>
<p><img decoding="async" loading="lazy" alt="alt Sending firmware" src="https://meta-erlang.github.io/assets/images/nhc-send-update-to-1.0.1-36d46e43cae67b1e90f7bd976ebc1142.png" title="Sensing firmware 1.0.1" width="1240" height="872" class="img_ev3q"></p>
<p>While NervesCloud is sending the new firmware to device, on QEMU console we
can check that nerves_hub_link is working as expected:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">22</span><span class="token plain">:01:38.452 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NervesHubLink</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Resuming download attempt number </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> https://files.nervescloud.com/firmware/38/a6fd8354-ecc6-50c9-e337-5c72d8c105d5.fw?X-Amz-Algorithm</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">AWS4-HMAC-SHA256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:01:38.469 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NervesHubLink</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Downloading firmware: https://files.nervescloud.com/firmware/38/a6fd8354-ecc6-50c9-e337-5c72d8c105d5.fw?X-Amz-Algorithm</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">AWS4-HMAC-SHA256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:01:38.472 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">notice</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">     :alarm_handler: </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">:set, </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">NervesHubLink.UpdateInProgress, </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:01:38.482 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NervesHubLink</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> FWUP PROG: </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:01:39.627 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">warning</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NervesHubLink</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> FWUP WARN: Upgrading partition B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:01:40.114 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NervesHubLink</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> FWUP PROG: </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:01:40.551 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NervesHubLink</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> FWUP PROG: </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:01:40.552 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NervesHubLink</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> FWUP PROG: </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:02:09.478 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NervesHubLink</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> FWUP PROG: </span><span class="token number" style="color:#36acaa">100</span><span class="token plain">%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:02:09.481 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NervesHubLink</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> FWUP SUCCESS: </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:02:09.482 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NervesHubLink</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> FWUP Finished</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:02:09.483 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">notice</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">     :alarm_handler: </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">:clear, NervesHubLink.UpdateInProgress</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:02:09.484 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Elixir.Nerves.Runtime.Power </span><span class="token builtin class-name">:</span><span class="token plain"> device told to </span><span class="token function" style="color:#d73a49">reboot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:02:09.488 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Heart: Erlang heart isn't running. Check vm.args.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">22</span><span class="token plain">:02:09.731 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">warning</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NervesTime</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Stopping RTC NervesTime.FileTime: :shutdown</span><br></span></code></pre></div></div>
<p>The device will update and reboot. When QEMU instance is back, start
nerves_hub_link again and check the expected version in NervesCloud web
interface:</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The manual start is OK for this experiment. Just execute nerves_hub_link again
on QEMU console:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/usr/lib/nerves-hub-link/bin/nerves_hub_link start_iex</span><br></span></code></pre></div></div></div></div>
<p><img decoding="async" loading="lazy" alt="alt Device updated" src="https://meta-erlang.github.io/assets/images/nhc_device_updated_to_101-2e26a42c06f4d40fbc19a1b7c841b74b.png" title="Device updated to 1.0.1 version" width="1246" height="439" class="img_ev3q"></p>
<p>Very good, the downgrade has been completed.</p>
</li>
<li class="">
<p>upgrade 1.0.1 -&gt; 1.2.0</p>
<p>Now, it's time to perform an upgrade from 1.0.1 to 1.2.0 version. Following
the same steps above, but selecting the version 1.2.0 this time, the device
will be updated to 1.2.0 version:</p>
<p><img decoding="async" loading="lazy" alt="alt Device updated" src="https://meta-erlang.github.io/assets/images/nhc_update_device_10_to_120-832e164c694fbb93e0ae6accf4753b00.png" title="Update to 1.2.0 version" width="1224" height="867" class="img_ev3q"></p>
<p>When QEMU is back, we can check which version NervesCloud will show:</p>
<p><img decoding="async" loading="lazy" alt="alt Device updated" src="https://meta-erlang.github.io/assets/images/nhc_device_updated_to_120-d8295165fe5dbb5332540b5b4a4aa649.png" title="Device updated to 1.2.0 version" width="1250" height="321" class="img_ev3q"></p>
</li>
</ul>
<p>We can play with this dancing many times. Proving that upgrade/downgrade works
as expected.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="some-low-level-details-introducing-meta-nerves-hub">Some low level details: introducing meta-nerves-hub<a href="https://meta-erlang.github.io/blog/2025/01/26/index/#some-low-level-details-introducing-meta-nerves-hub" class="hash-link" aria-label="Direct link to Some low level details: introducing meta-nerves-hub" title="Direct link to Some low level details: introducing meta-nerves-hub" translate="no">‚Äã</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="meta-nerves-hub">meta-nerves-hub<a href="https://meta-erlang.github.io/blog/2025/01/26/index/#meta-nerves-hub" class="hash-link" aria-label="Direct link to meta-nerves-hub" title="Direct link to meta-nerves-hub" translate="no">‚Äã</a></h3>
<p><a href="https://github.com/joaohf/meta-nerves-hub" target="_blank" rel="noopener noreferrer" class="">meta-nerves-hub</a> layer is a new
layer introduced to keep common application and configurations for
<a href="https://github.com/nerves-hub" target="_blank" rel="noopener noreferrer" class="">NervesHub</a> and
<a href="https://github.com/nerves-project" target="_blank" rel="noopener noreferrer" class="">Nerves Project</a> working with Yocto Project.
The purpose is to bring essential and base components for anyone that wants to
use YP/Openembedded in your products.</p>
<p>meta-nerves-hub has a recipe called
<a href="https://github.com/joaohf/meta-nerves-hub/tree/master/recipes-extended/nerves-hub-link_2.5.2.bb" target="_blank" rel="noopener noreferrer" class="">nerves-hub-link_2.5.2.bb</a>
which builds nerves-hub-link application. I had to apply two patches for
nerves-hub-link source code in order to make it work well when building inside
Yocto environment:</p>
<ul>
<li class="">
<p>The first one is
<a href="https://github.com/joaohf/meta-nerves-hub/blob/master/recipes-extended/nerves-hub-link/nerves-hub-link/0001-Use-MIX_TARGET_INCLUDE_ERTS-for-include-ERTS-release.patch" target="_blank" rel="noopener noreferrer" class="">0001-Use-MIX_TARGET_INCLUDE_ERTS-for-include-ERTS-release.patch</a></p>
</li>
<li class="">
<p>And the second one was about using KVBackend from UbootEnv instead memory:
<a href="https://github.com/joaohf/meta-nerves-hub/blob/master/recipes-extended/nerves-hub-link/nerves-hub-link/0001-Use-UbootEnv-as-kv_backend.patch" target="_blank" rel="noopener noreferrer" class="">0001-Use-UbootEnv-as-kv_backend.patch</a></p>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="extending-nerves-hub-link-recipe">extending nerves-hub-link recipe<a href="https://meta-erlang.github.io/blog/2025/01/26/index/#extending-nerves-hub-link-recipe" class="hash-link" aria-label="Direct link to extending nerves-hub-link recipe" title="Direct link to extending nerves-hub-link recipe" translate="no">‚Äã</a></h3>
<p>The nerves-hub-link recipe is not intend for use as standalone. It's purpose is
for development and demonstration. When running nerves-hub-link it's necessary
to configure it with the correct
<a href="https://github.com/nerves-hub/nerves_hub_link?tab=readme-ov-file#connecting-your-device-to-nerveshub" target="_blank" rel="noopener noreferrer" class="">shared secret credentials</a>.</p>
<p>To get quick results, I've extended
<a href="https://github.com/meta-erlang/meta-axon/tree/master/dynamic-layers/meta-nerves-hub/recipes-extended/nerves-hub-link/nerves-hub-link_2.5.2.bbappend" target="_blank" rel="noopener noreferrer" class="">nerves-hub-link from meta-axon layer</a>
with the correct shared secret credentials used by my development instance on
NervesCloud.</p>
<p>For a real use of nerves-hub-link, the correct way would be creating a new
Elixir application that has nerves-hub-link as dependency and make all the
configuration needed.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The NervesCloud team are working on a pre-build agent model, which will simplify
setup and configuration.</p></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="conclusions">Conclusions<a href="https://meta-erlang.github.io/blog/2025/01/26/index/#conclusions" class="hash-link" aria-label="Direct link to Conclusions" title="Direct link to Conclusions" translate="no">‚Äã</a></h2>
<p>I am having so much fun playing with fwup and NervesCloud that I will keep
improving this environment. Just to recap the adventures so far:</p>
<ul>
<li class=""><a class="" href="https://meta-erlang.github.io/blog/2024/09/24/index/">fwup for A/B image upgrades, part I</a></li>
<li class=""><a class="" href="https://meta-erlang.github.io/blog/2024/12/20/index/">fwup for A/B image upgrades on QEMU machines with fwup, part II</a></li>
</ul>
<p>It is all about enabling features and managing what is feasible or not. Of
course, implementing the missing parts. When building products with Yocto
Project, it is a bit like playing a
<a href="https://en.wikipedia.org/wiki/Open_world" target="_blank" rel="noopener noreferrer" class="">open-world video game</a>. You have to
have a target in mind.</p>
<p>My plan is to continue adding more fwup configurations into meta-fwup-examples
layer in order to support more BSP layers and well know boards like raspberrypi.
Also, trying to use some other processor architectures like: riscv, ppc, mips
all running on QEMU and Yocto Project. I will stay in this loop until get
something stable.</p>]]></content>
        <author>
            <name>Jo√£o Henrique Ferreira de Freitas</name>
            <uri>https://github.com/joaohf</uri>
        </author>
        <category label="meta-erlang" term="meta-erlang"/>
        <category label="fwup" term="fwup"/>
        <category label="qemu" term="qemu"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[fwup for A/B image upgrades on QEMU machines with fwup, part II]]></title>
        <id>https://meta-erlang.github.io/blog/2024/12/20/index/</id>
        <link href="https://meta-erlang.github.io/blog/2024/12/20/index/"/>
        <updated>2024-12-20T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This blog post describes all parts involved in order to use QEMU machines with]]></summary>
        <content type="html"><![CDATA[<p>This blog post describes all parts involved in order to use QEMU machines with
Yocto images for testing and developing A/B image upgrades. Moreover, this blog
post could be considered an extension for the
<a class="" href="https://meta-erlang.github.io/blog/2024/09/24/index/">fwup for A/B image upgrades, part I</a> blog post.</p>
<p>The <a href="https://github.com/fwup-home/fwup" target="_blank" rel="noopener noreferrer" class="">fwup</a> tool and
<a href="https://github.com/fwup-home/meta-fwup" target="_blank" rel="noopener noreferrer" class="">meta-fwup</a> have been introduced in the
previous blog post and serve as a base knowledge for this post.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="objectives-and-tools">Objectives and Tools<a href="https://meta-erlang.github.io/blog/2024/12/20/index/#objectives-and-tools" class="hash-link" aria-label="Direct link to Objectives and Tools" title="Direct link to Objectives and Tools" translate="no">‚Äã</a></h2>
<p>When I was writing and testing the post
<a class="" href="https://meta-erlang.github.io/blog/2024/09/24/index/">fwup for A/B image upgrades, part I</a>, it was very
tedious have to wait the test cycle which basically was:</p>
<ol>
<li class="">Make one change</li>
<li class="">Build a new image</li>
<li class="">Burn the image into sdcard</li>
<li class="">Plug the sdcard on the target real board</li>
<li class="">Power on</li>
<li class="">Test</li>
<li class="">Power off</li>
<li class="">Get the results</li>
<li class="">Go to step #1</li>
</ol>
<p>I've spent too much time waiting for feedback. Since then, I've been thinking
how it would be possible to speed up my test cycle.</p>
<p>Maybe buying more target boards or reduce the final image footprint or buy a
faster build machine. None of them would help much the situation.</p>
<p>Then, I remember that one of the greatest feature from Yocto Project is the
integration with <a href="https://www.qemu.org/" target="_blank" rel="noopener noreferrer" class="">QEMU</a> emulator. Yocto brings some
ready-to-use
<a href="https://git.yoctoproject.org/poky/tree/README.qemu.md" target="_blank" rel="noopener noreferrer" class="">qemu machines</a> that one
could use in order to run an image made with Yocto Project and spending no
money.</p>
<p>However, some pieces were missing:</p>
<ul>
<li class="">The qemu default machines are not prepared for using u-boot as boot loader</li>
<li class="">u-boot does not know how to load environment variables from virtio block
devices</li>
<li class="">lack of qemu device-tree files (.dtb) when booting qemu machines</li>
</ul>
<p>It was clear that without some patches my idea of short test cycle would not be
feasible.</p>
<p>So, this blog post continues the story about
<a href="https://github.com/fwup-home/fwup" target="_blank" rel="noopener noreferrer" class="">fwup tool</a> in Yocto world. There are two
important sections:</p>
<ul>
<li class="">One showing a practical use case with all steps necessary to test the A/B
upgrades with fwup on qemu u-boot.</li>
<li class="">A second one describing the patches and layers that I've created for booting
qemu machines with u-boot and Yocto images.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="use-case-ab-upgrades-with-qemu-u-boot-machines">Use case: A/B upgrades with QEMU u-boot machines<a href="https://meta-erlang.github.io/blog/2024/12/20/index/#use-case-ab-upgrades-with-qemu-u-boot-machines" class="hash-link" aria-label="Direct link to Use case: A/B upgrades with QEMU u-boot machines" title="Direct link to Use case: A/B upgrades with QEMU u-boot machines" translate="no">‚Äã</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="ypoe-setup">YP/OE setup<a href="https://meta-erlang.github.io/blog/2024/12/20/index/#ypoe-setup" class="hash-link" aria-label="Direct link to YP/OE setup" title="Direct link to YP/OE setup" translate="no">‚Äã</a></h3>
<p>I'll try to simplify the YP/OE setup to just tree small steps:</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The YP documentation is very good. I strong recommend its reading. For this
section the release version used is
<a href="https://docs.yoctoproject.org/brief-yoctoprojectqs/index.html" target="_blank" rel="noopener noreferrer" class="">master</a>.</p><p>One important point is to double check the
<a href="https://docs.yoctoproject.org/ref-manual/system-requirements.html#required-packages-for-the-build-host." target="_blank" rel="noopener noreferrer" class="">Required Packages for the Build Host</a></p></div></div>
<ol>
<li class="">
<p>Cloning all repositories for master release:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master git://git.yoctoproject.org/poky</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/openembedded/meta-openembedded.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/fwup-home/meta-fwup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/meta-erlang/meta-qemu-bsp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/joaohf/meta-fwup-examples</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>Source the init build environment script:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> poky</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> oe-init-build-env </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/build</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>Add the needed layers:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-openembedded/meta-oe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-fwup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-qemu-bsp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-fwup-examples</span><br></span></code></pre></div></div>
</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="configuring-the-build-environment">Configuring the build environment<a href="https://meta-erlang.github.io/blog/2024/12/20/index/#configuring-the-build-environment" class="hash-link" aria-label="Direct link to Configuring the build environment" title="Direct link to Configuring the build environment" translate="no">‚Äã</a></h3>
<p>For this use case, the quickest way is edit and add the <em>conf/local.conf</em>
configuration file.</p>
<p>We start defining the MACHINE and DISTRO:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MACHINE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"qemuarm64-uboot"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DISTRO </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"poky"</span><br></span></code></pre></div></div>
<p>The machine <em>qemuarm64-uboot</em> is provided by
<a href="https://github.com/meta-erlang/meta-qemu-bsp" target="_blank" rel="noopener noreferrer" class="">meta-qemu-bsp</a> layer. That
machine uses u-boot as bootloader.</p>
<p>As YP/OE supports many types of image outputs, we want to be specific here and
pick only the <em>fwup</em> type.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> conf/local.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># enable support for making fwup images</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">IMAGE_CLASSES += "image_types_fwup"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">IMAGE_FSTYPES = "fwup fwup.qcow2"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The fwup type is provided by the bbclass
<a href="https://github.com/fwup-home/meta-fwup/blob/master/classes/image_types_fwup.bbclass" target="_blank" rel="noopener noreferrer" class="">image_types_fwup.bbclass</a>.
It relies on wic image generator and uses their build artifacts for bootloader
and rootfs.</p></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="building-an-image">Building an image<a href="https://meta-erlang.github.io/blog/2024/12/20/index/#building-an-image" class="hash-link" aria-label="Direct link to Building an image" title="Direct link to Building an image" translate="no">‚Äã</a></h3>
<p>Now that the configuration is over. Let's start a build:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake core-image-full-cmdline</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>For this example, and demonstration purposes, we'll use the image called
<a href="https://git.yoctoproject.org/poky/tree/meta/recipes-core/images/core-image-full-cmdline.bb" target="_blank" rel="noopener noreferrer" class="">core-image-full-cmdline</a>.</p></div></div>
<p>Once the build has finished, let's inspect the build outputs:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> tmp/deploy/images/qemuarm64-uboot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-lh</span><span class="token plain"> core-image-full-cmdline*.fw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> joaohf joaohf 71M dez </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20 core-image-full-cmdline-qemuarm64-uboot.rootfs-20241227191846.fw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> joaohf joaohf  </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> dez </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20 core-image-full-cmdline-qemuarm64-uboot.rootfs.fw -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> core-image-full-cmdline-qemuarm64-uboot.rootfs-20241227191846.fw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-lh</span><span class="token plain"> core-image-full-cmdline*fwup*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> joaohf joaohf </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">,1G dez </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20 core-image-full-cmdline-qemuarm64-uboot.rootfs-20241227191846.fwup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> joaohf joaohf 199M dez </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">17</span><span class="token plain">:36 core-image-full-cmdline-qemuarm64-uboot.rootfs-20241227191846.fwup.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> joaohf joaohf   </span><span class="token number" style="color:#36acaa">66</span><span class="token plain"> dez </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20 core-image-full-cmdline-qemuarm64-uboot.rootfs.fwup -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> core-image-full-cmdline-qemuarm64-uboot.rootfs-20241227191846.fwup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> joaohf joaohf   </span><span class="token number" style="color:#36acaa">72</span><span class="token plain"> dez </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token plain">:20 core-image-full-cmdline-qemuarm64-uboot.rootfs.fwup.qcow2 -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> core-image-full-cmdline-qemuarm64-uboot.rootfs-20241227191846.fwup.qcow2</span><br></span></code></pre></div></div>
<p>The folder <em>tmp/deploy/images/qemuarm64-uboot</em> has many files generated from the
build tasks. We are interested on some files only:</p>
<ul>
<li class="">The first one with file extension .fw, is the firmware image made by fwup.
We'll use this file for A/B upgrades.</li>
<li class="">And the second file is the <a href="https://en.wikipedia.org/wiki/Qcow" target="_blank" rel="noopener noreferrer" class="">qcow2</a> Yocto
image suitable for using it with QEMU when running the command <code>runqemu</code>.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="running-qemu-images-with-runqemu-script">Running QEMU images with runqemu script<a href="https://meta-erlang.github.io/blog/2024/12/20/index/#running-qemu-images-with-runqemu-script" class="hash-link" aria-label="Direct link to Running QEMU images with runqemu script" title="Direct link to Running QEMU images with runqemu script" translate="no">‚Äã</a></h3>
<p>The <a href="https://git.yoctoproject.org/poky/tree/scripts/runqemu" target="_blank" rel="noopener noreferrer" class="">runqemu script</a> is
the official way for running QEMU with the image previously created. The scripts
accepts many QEMU parameters.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>For more details about using QEMU with Yocto, check out the official
documentation:
<a href="https://docs.yoctoproject.org/dev-manual/qemu.html" target="_blank" rel="noopener noreferrer" class="">Using the Quick EMUlator (QEMU)</a></p></div></div>
<p>For this tutorial the follow command will be used:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">runqemu core-image-full-cmdline nographic serialstdio wic.qcow2</span><br></span></code></pre></div></div>
<p>It starts QEMU without graphic support and with serial console attached to
stdio. The <em>wic.qcow2</em> says to runqemu that we want to boot using the
<em>core-image-full-cmdline-qemuarm64-uboot.rootfs.fwup.qcow2</em> image.</p>
<p>After running the runqemu command, we got:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ runqemu core-image-full-cmdline nographic serialstdio slirp wic.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runqemu - INFO - Running bitbake -e  core-image-full-cmdline...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runqemu - INFO - Continuing with the following parameters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MACHINE: [qemuarm64-uboot]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FSTYPE: [wic.qcow2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ROOTFS: [/data-work/yocto/work/fwup/build/tmp/deploy/images/qemuarm64-uboot/core-image-full-cmdline-qemuarm64-uboot.rootfs.wic.qcow2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONFFILE: [/data-work/yocto/work/fwup/build/tmp/deploy/images/qemuarm64-uboot/core-image-full-cmdline-qemuarm64-uboot.rootfs.qemuboot.conf]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runqemu - INFO - Setting up tap interface under sudo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runqemu - INFO - Network configuration: ip=192.168.7.2::192.168.7.1:255.255.255.0::eth0:off:8.8.8.8 net.ifnames=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runqemu - INFO - Running /data-work/yocto/work/fwup/build/tmp/work/x86_64-linux/qemu-helper-native/1.0/recipe-sysroot-native/usr/bin/qemu-system-aarch64 -device virtio-net-pci,netdev=net0,mac=52:54:00:1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2:34:02 -netdev tap,id=net0,ifname=tap0,script=no,downscript=no -object rng-random,filename=/dev/urandom,id=rng0 -device virtio-rng-pci,rng=rng0 -drive id=disk0,file=/data-work/yocto/work/fwup/build/tmp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/deploy/images/qemuarm64-uboot/core-image-full-cmdline-qemuarm64-uboot.rootfs.wic.qcow2,if=none,format=qcow2 -device virtio-blk-device,drive=disk0 -device qemu-xhci -device usb-tablet -device usb-kbd  -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">machine virt -cpu cortex-a57 -smp 4 -m 256 -serial mon:stdio -serial null -nographic -device virtio-gpu-pci -bios /data-work/yocto/work/fwup/build/tmp/deploy/images/qemuarm64-uboot/u-boot.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runqemu - INFO - Host uptime: 26648.54</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">U-Boot 2024.10-dirty (Oct 07 2024 - 14:54:35 +0000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DRAM:  256 MiB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Core:  52 devices, 14 uclasses, devicetree: board</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Flash: 64 MiB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loading Environment from VIRTIO_BLK... OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">In:    serial,usbkbd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Out:   serial,vidconsole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Err:   serial,vidconsole</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Bus xhci_pci: Register 8001040 NbrPorts 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting the controller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">USB XHCI 1.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scanning bus xhci_pci for devices... 3 USB Device(s) found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Net:   eth0: virtio-net#32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hit any key to stop autoboot:  0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Saving Environment to VIRTIO_BLK... OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">board_name=[qemu-arm] ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">21881344 bytes read in 8 ms (2.5 GiB/s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loading qemu.dtb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1048576 bytes read in 0 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">debug: [console=ttyAMA0 root=/dev/vda2] ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">debug: [bootz 0x40200000 - 0x49000000] ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Flattened Device Tree blob at 49000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Booting using the fdt blob at 0x49000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Working FDT set to 49000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Loading Device Tree to 000000004d491000, end 000000004d593fff ... OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Working FDT set to 4d491000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting kernel ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[    0.000000] Booting Linux on physical CPU 0x0000000000 [0x411fd070]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[    0.000000] Linux version 6.12.3-yocto-standard (oe-user@oe-host) (aarch64-poky-linux-gcc (GCC) 14.2.0, GNU ld (GNU Binutils) 2.43.1.20241111) #1 SMP PREEMPT Thu Dec 12 17:25:00 UTC 2024</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Poky (Yocto Project Reference Distro) 5.1 qemuarm64-uboot ttyAMA0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qemuarm64-uboot login:</span><br></span></code></pre></div></div>
<p>That log above shows some very interesting points:</p>
<ul>
<li class="">QEMU was configure with <em>-bios</em> parameter:<!-- -->
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-bios /build/tmp/deploy/images/qemuarm64-uboot/u-boot.bin</span><br></span></code></pre></div></div>
<!-- -->Which means u-boot will be used as bootloader for linux kernel.</li>
<li class="">we can check that u-boot support for virtio block device is working as
expected:<!-- -->
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Loading Environment from VIRTIO_BLK... OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Saving Environment to VIRTIO_BLK... OK</span><br></span></code></pre></div></div>
</li>
</ul>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>When logged on qemu instance, it's necessary to run the command:
<code>ifconfig eth0 192.168.7.2 netmask 255.255.255.0</code> to setup a IP address to eth0
interface.</p></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="inspecting-a-partition">Inspecting A partition<a href="https://meta-erlang.github.io/blog/2024/12/20/index/#inspecting-a-partition" class="hash-link" aria-label="Direct link to Inspecting A partition" title="Direct link to Inspecting A partition" translate="no">‚Äã</a></h3>
<ul>
<li class="">
<p>partition layout:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@qemuarm64-uboot:~# sfdisk -l /dev/vda</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disk /dev/vda: 1.02 GiB, 1096941568 bytes, 2142464 sectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Units: sectors of 1 * 512 = 512 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sector size (logical/physical): 512 bytes / 512 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disklabel type: dos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disk identifier: 0x00000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Device     Boot   Start     End Sectors   Size Id Type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/vda1  *       8192   93035   84844  41.4M  c W95 FAT32 (LBA)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/vda2         93036 1117585 1024550 500.3M 83 Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/vda3       1117586 2142135 1024550 500.3M 83 Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/vda4       2142136 3190711 1048576   512M 83 Linux</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>uname</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@qemuarm64-uboot:~# uname -a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Linux qemuarm64-uboot 6.12.3-yocto-standard #1 SMP PREEMPT Thu Dec 12 17:25:00 UTC 2024 aarch64 GNU/Linux</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>uboot variables:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@qemuarm64-uboot:~# fw_printenv nerves_fw_active nerves_fw_validated nerves_fw_booted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nerves_fw_active=a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nerves_fw_validated=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nerves_fw_booted=1</span><br></span></code></pre></div></div>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="moving-to-b-partition">Moving to B partition<a href="https://meta-erlang.github.io/blog/2024/12/20/index/#moving-to-b-partition" class="hash-link" aria-label="Direct link to Moving to B partition" title="Direct link to Moving to B partition" translate="no">‚Äã</a></h3>
<p>Alright, partition A looks fine. Now, we want to run an upgrade using the fwup
firmware image.</p>
<p>From the build machine:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> build/tmp/deploy/images/qemuarm64-uboot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> core-image-full-cmdline-qemuarm64-uboot.rootfs.fw </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ssh</span><span class="token plain"> root@192.168.7.2 </span><span class="token string" style="color:#e3116c">'fwup -v -a -U -d /dev/vda -t upgrade.b'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fwup: require-uboot-variable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uboot-env, nerves_fw_active</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> met</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fwup: require-uboot-variable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uboot-env, nerves_fw_validated</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> met</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fwup: require-uboot-variable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uboot-env, a.nerves_fw_platform</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> met</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fwup: require-uboot-variable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uboot-env, a.nerves_fw_architecture</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> met</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fwup: Upgrading partition B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">100</span><span class="token plain">% </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">73.74</span><span class="token plain"> MB </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> / </span><span class="token number" style="color:#36acaa">570.79</span><span class="token plain"> MB out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Success</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Elapsed time: </span><span class="token number" style="color:#36acaa">9.758</span><span class="token plain"> s</span><br></span></code></pre></div></div>
<p>The important argument is the <code>-t upgrade.b</code> telling to fwup which partition
will be upgraded.</p>
<p>Let's also inspect u-boot environment variables. Because the task upgrade.b
should changed something there:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@qemuarm64-uboot:~</span><span class="token comment" style="color:#999988;font-style:italic"># fw_printenv nerves_fw_active nerves_fw_validated nerves_fw_booted</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">nerves_fw_active</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">nerves_fw_validated</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">nerves_fw_booted</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre></div></div>
<p>Indeed, the <em>nerves_fw_active</em> variable has changed.</p>
<p>Inside qemu, reboot the system using the <code>reboot</code> command in order to change the
partition.</p>
<p>Once the system come back, let's inspect the u-boot environment variables to
check if those variables are pointing to the B partition now.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@qemuarm64-uboot:~</span><span class="token comment" style="color:#999988;font-style:italic"># fw_printenv nerves_fw_active nerves_fw_validated nerves_fw_booted</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">nerves_fw_active</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">nerves_fw_validated</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">nerves_fw_booted</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre></div></div>
<p>And they are ok. Not only still pointing to B partition as well validated and
booted.</p>
<p>The lsblk output also proves that vda3 is mounted as root partition:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@qemuarm64-uboot:~</span><span class="token comment" style="color:#999988;font-style:italic"># lsblk</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vda    </span><span class="token number" style="color:#36acaa">253</span><span class="token plain">:0    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     1G  </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> disk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-vda1 </span><span class="token number" style="color:#36acaa">253</span><span class="token plain">:1    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">41</span><span class="token plain">.4M  </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> part /boot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-vda2 </span><span class="token number" style="color:#36acaa">253</span><span class="token plain">:2    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">500</span><span class="token plain">.5M  </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> part</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-vda3 </span><span class="token number" style="color:#36acaa">253</span><span class="token plain">:3    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">500</span><span class="token plain">.5M  </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> part /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`-vda4 </span><span class="token number" style="color:#36acaa">253</span><span class="token plain">:4    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">   238K  </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> part</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="moving-from-b-to-a-partition">Moving from B to A partition<a href="https://meta-erlang.github.io/blog/2024/12/20/index/#moving-from-b-to-a-partition" class="hash-link" aria-label="Direct link to Moving from B to A partition" title="Direct link to Moving from B to A partition" translate="no">‚Äã</a></h3>
<p>Ok, looks like partition B is up and running too.</p>
<p>Now, it's time to run a second upgrade and moving back to A partition.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">cd</span><span class="token plain"> build/tmp/deploy/images/qemuarm64-uboot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> core-image-full-cmdline-qemuarm64-uboot.rootfs.fw </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ssh</span><span class="token plain"> root@192.168.7.2 </span><span class="token string" style="color:#e3116c">'fwup -v -a -U -d /dev/vda -t upgrade.a'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fwup: require-uboot-variable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uboot-env, nerves_fw_active</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> met</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fwup: require-uboot-variable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uboot-env, nerves_fw_validated</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> met</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fwup: require-uboot-variable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uboot-env, b.nerves_fw_platform</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> met</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fwup: require-uboot-variable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uboot-env, b.nerves_fw_architecture</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> met</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fwup: Upgrading partition A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">100</span><span class="token plain">% </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">73.74</span><span class="token plain"> MB </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> / </span><span class="token number" style="color:#36acaa">570.79</span><span class="token plain"> MB out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Success</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Elapsed time: </span><span class="token number" style="color:#36acaa">8.515</span><span class="token plain"> s</span><br></span></code></pre></div></div>
<p>Again, checking u-boot variables:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@qemuarm64-uboot:~</span><span class="token comment" style="color:#999988;font-style:italic"># fw_printenv nerves_fw_active nerves_fw_validated nerves_fw_booted</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">nerves_fw_active</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">nerves_fw_validated</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">nerves_fw_booted</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre></div></div>
<p>And rebooting the system using <code>reboot</code> command in order to change the partition
to A. After the reboot, let's check what is the state of u-boot variables:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@qemuarm64-uboot:~</span><span class="token comment" style="color:#999988;font-style:italic"># fw_printenv nerves_fw_active nerves_fw_validated nerves_fw_booted</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">nerves_fw_active</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">nerves_fw_validated</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">nerves_fw_booted</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre></div></div>
<p>The lsblk output should point vda2 mounted as root partition:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@qemuarm64-uboot:~</span><span class="token comment" style="color:#999988;font-style:italic"># lsblk</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vda    </span><span class="token number" style="color:#36acaa">253</span><span class="token plain">:0    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     1G  </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> disk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-vda1 </span><span class="token number" style="color:#36acaa">253</span><span class="token plain">:1    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">41</span><span class="token plain">.4M  </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> part /boot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-vda2 </span><span class="token number" style="color:#36acaa">253</span><span class="token plain">:2    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">500</span><span class="token plain">.5M  </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> part /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">-vda3 </span><span class="token number" style="color:#36acaa">253</span><span class="token plain">:3    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">500</span><span class="token plain">.5M  </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> part</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">`-vda4 </span><span class="token number" style="color:#36acaa">253</span><span class="token plain">:4    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">   238K  </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> part</span><br></span></code></pre></div></div>
<p>It worked as expected. The system is using a rootfs from partition A.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="low-level-details">Low level details<a href="https://meta-erlang.github.io/blog/2024/12/20/index/#low-level-details" class="hash-link" aria-label="Direct link to Low level details" title="Direct link to Low level details" translate="no">‚Äã</a></h2>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>A bit more Yocto vocabulary.</p></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="meta-qemu-bsp-layer">meta-qemu-bsp layer<a href="https://meta-erlang.github.io/blog/2024/12/20/index/#meta-qemu-bsp-layer" class="hash-link" aria-label="Direct link to meta-qemu-bsp layer" title="Direct link to meta-qemu-bsp layer" translate="no">‚Äã</a></h3>
<p>The <a href="https://github.com/meta-erlang/meta-qemu-bsp" target="_blank" rel="noopener noreferrer" class="">meta-qemu-bsp layer</a> is a BSP
(board support package) type layer. The target is to bring some machines
extended from default Yocto QEMU machines.</p>
<p>By default, Yocto brings the following QEMU machines:</p>
<ul>
<li class="">ARM (qemuarm + qemuarm64)</li>
<li class="">x86 (qemux86 + qemux86-64)</li>
<li class="">PowerPC (qemuppc only)</li>
<li class="">MIPS (qemumips + qemumips64)</li>
</ul>
<p>These machines don't work with u-boot for instance. In order to enable u-boot,
some configuration are necessary. Thus, the following machine proveded by
meta-qemu-bsp layer were created:</p>
<ul>
<li class=""><a href="https://github.com/meta-erlang/meta-qemu-bsp/blob/master/conf/machine/qemuarm-uboot.conf" target="_blank" rel="noopener noreferrer" class="">qemuarm-uboot</a></li>
<li class=""><a href="https://github.com/meta-erlang/meta-qemu-bsp/blob/master/conf/machine/qemuarm64-uboot.conf" target="_blank" rel="noopener noreferrer" class="">qemuarm64-uboot</a></li>
</ul>
<p>A WIC file is also provided:
<a href="https://github.com/meta-erlang/meta-qemu-bsp/blob/master/wic/qemuarm-uboot-directdisk.wks" target="_blank" rel="noopener noreferrer" class="">qemuarm-uboot-directdisk.wks</a>
and it is used when creating wic images.</p>
<p>The meta-qemu-bsp layer was design to use with any other Yocto layer. It's not
specific for fwup use cases.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="patching-u-boot">Patching u-boot<a href="https://meta-erlang.github.io/blog/2024/12/20/index/#patching-u-boot" class="hash-link" aria-label="Direct link to Patching u-boot" title="Direct link to Patching u-boot" translate="no">‚Äã</a></h3>
<p>The u-boot bootloader was not prepared to load environment variables from virtio
block device. So, a patch called
<a href="https://github.com/meta-erlang/meta-qemu-bsp/blob/master/recipes-bsp/u-boot/files/0001-Load-and-save-environment-from-virtio-block-device.patch" target="_blank" rel="noopener noreferrer" class="">Load and save environment from virtio block device</a>
was developed.</p>
<p>It allows u-boot to load environment variables from virtio block device reading
data from a specific offset and size. As u-boot already provides support for
<a href="https://docs.u-boot.org/en/stable/develop/driver-model/virtio.html" target="_blank" rel="noopener noreferrer" class="">virtio</a>,
the bits needed to load variables from virtio was easy to implement.</p>
<p>So far, this patch was not submited to u-boot upstream project.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="fwup-examples-layer">fwup examples layer<a href="https://meta-erlang.github.io/blog/2024/12/20/index/#fwup-examples-layer" class="hash-link" aria-label="Direct link to fwup examples layer" title="Direct link to fwup examples layer" translate="no">‚Äã</a></h3>
<p>A new layer called
<a href="https://github.com/joaohf/meta-fwup-examples" target="_blank" rel="noopener noreferrer" class="">meta-fwup-examples</a> was developed
to hold fwup examples for Yocto images.</p>
<p>The process of enabling Yocto images to use fwup is not so smooth and it depends
on details like:</p>
<ul>
<li class="">partition layout</li>
<li class="">boot load paramenters</li>
<li class="">boot load environment scripts</li>
<li class="">fwup tasks</li>
<li class="">custom logics</li>
</ul>
<p>Then, each of these details is a combination that works for a specific target
board. Having a dedicated layer with working fwup examples helps for
demonstration and new implementations.</p>
<p>The meta-fwup-examples is also a repository of .fwup description files:</p>
<ul>
<li class=""><a href="https://github.com/joaohf/meta-fwup-examples/blob/master/fwup/qemuarm-uboot.fwup" target="_blank" rel="noopener noreferrer" class="">qemuarm-uboot.fwup</a></li>
<li class=""><a href="https://github.com/joaohf/meta-fwup-examples/blob/master/fwup/qemuarm64-uboot.fwup" target="_blank" rel="noopener noreferrer" class="">qemuarm64-uboot.fwup</a></li>
</ul>
<p>It's important to mention that I'm reusing and adapting .fwup files from
<a href="https://github.com/orgs/nerves-project" target="_blank" rel="noopener noreferrer" class="">Nerves Project</a>.</p>
<p>The .fwup used for raspberrypi in
<a class="" href="https://meta-erlang.github.io/blog/2024/09/24/index/">fwup for A/B image upgrades, part I</a> will be moved to
the layer meta-fwup-examples soon.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="conclusions">Conclusions<a href="https://meta-erlang.github.io/blog/2024/12/20/index/#conclusions" class="hash-link" aria-label="Direct link to Conclusions" title="Direct link to Conclusions" translate="no">‚Äã</a></h2>
<p>Yes, QEMU machines with u-boot enabled is feasible. And it will help me to
reduce time when testing/developing.</p>
<p>While the <a class="" href="https://meta-erlang.github.io/blog/2024/09/24/index/">fwup for A/B image upgrades, part I</a> blog
post discussed fwup and meta-fwup details, this post explored how QEMU could be
used instead a real hardware for testing.</p>
<p>Now it's possible to move fowarding and try some
<a href="https://github.com/nerves-hub/nerves_hub_link" target="_blank" rel="noopener noreferrer" class="">nerves_hub_link</a> high level
integration for A/B upgrades using <a href="https://www.nerves-hub.org/" target="_blank" rel="noopener noreferrer" class="">nerves-hub</a>.</p>
<p>But that will be a topic for further blog posts.</p>]]></content>
        <author>
            <name>Jo√£o Henrique Ferreira de Freitas</name>
            <uri>https://github.com/joaohf</uri>
        </author>
        <category label="meta-erlang" term="meta-erlang"/>
        <category label="fwup" term="fwup"/>
        <category label="qemu" term="qemu"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Introducing Gleam to meta-erlang layer]]></title>
        <id>https://meta-erlang.github.io/blog/2024/11/03/index/</id>
        <link href="https://meta-erlang.github.io/blog/2024/11/03/index/"/>
        <updated>2024-11-03T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Gleam is a new language that runs on Erlang VM. As one the]]></summary>
        <content type="html"><![CDATA[<p><a href="https://gleam.run/" target="_blank" rel="noopener noreferrer" class="">Gleam</a> is a new language that runs on Erlang VM. As one the
aims of meta-erlang layer is to offer support to BEAM ecosystem in YP/OE
ecosystem
<a href="https://github.com/meta-erlang/meta-erlang/pull/340" target="_blank" rel="noopener noreferrer" class="">gleam support has been added</a>
to meta-erlang.</p>
<p>I'm not a gleam programming. Actually, I recently discovered gleam (and its
purposes). And I'm still learning it. After watching the talk
<a href="https://www.youtube.com/watch?v=6I0IbJtUC3U" target="_blank" rel="noopener noreferrer" class="">Keynote: Gleam's Journey on the BEAM - Hayleigh Thompson &amp; Louis Pilfold</a>
at Code BEAM Europe 2024, I give a try and add it to meta-erlang layer.</p>
<p>In this post I'll describe a simple experiment using the gleam example code
called <a href="https://github.com/gleam-lang/example-echo-server" target="_blank" rel="noopener noreferrer" class="">example-echo-server</a>
as it is simple and easy to understand.</p>
<p>At the end of this post we will be ready to create more recipes for programs
written in glean that runs on Yocto based images.</p>
<p>Also, as gleam is the third language supported by meta-erlang the
<a href="https://github.com/meta-erlang/meta-erlang/releases" target="_blank" rel="noopener noreferrer" class="">beamtools</a> will be updated
to also provide a gleam toolchain.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="gleam-is-written-in-rust">gleam is written in rust<a href="https://meta-erlang.github.io/blog/2024/11/03/index/#gleam-is-written-in-rust" class="hash-link" aria-label="Direct link to gleam is written in rust" title="Direct link to gleam is written in rust" translate="no">‚Äã</a></h2>
<p><a href="https://github.com/gleam-lang/gleam" target="_blank" rel="noopener noreferrer" class="">Gleam</a> language is written in rust
programming language. It could be a challenge to get it working on Yocto.
However, the support for building rust programs by Yocto has been added many
releases ago (check it out here
<a href="https://git.yoctoproject.org/poky/tree/meta/recipes-devtools/rust" target="_blank" rel="noopener noreferrer" class="">Yocto rust support</a>).
That means all the pieces and rust toolchain support to build gleam inside Yocto
were already there.</p>
<p>The
<a href="https://github.com/meta-erlang/meta-erlang/tree/master/recipes-devtools/gleam/gleam_1.5.1.bb" target="_blank" rel="noopener noreferrer" class="">gleam.bb recipe</a>
is responsible for compiling gleam as native program (that is, a program that
runs on the build machine). The final gleam package will not be installed in the
target because gleam compiles to .beam modules (erlang modules). At the end a
software written in gleam will be just BEAM modules that runs on Erlang VM.</p>
<p>There is also a new bitbake class called
<a href="https://github.com/meta-erlang/meta-erlang/tree/master/classes/gleam.bbclass" target="_blank" rel="noopener noreferrer" class="">gleam.bbclass</a>.
It is a class that every gleam recipe will use in order to fetch dependencies,
compile and packing.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="running-gleam-on-yocto-based-images">Running gleam on Yocto based images<a href="https://meta-erlang.github.io/blog/2024/11/03/index/#running-gleam-on-yocto-based-images" class="hash-link" aria-label="Direct link to Running gleam on Yocto based images" title="Direct link to Running gleam on Yocto based images" translate="no">‚Äã</a></h2>
<p>Alright, the following is a step by step listing a fresh build session and run
the hello-gleam-echo-server using QEMU.</p>
<ol>
<li class="">
<p>Cloning all repositories for master:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master git://git.yoctoproject.org/poky</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/openembedded/meta-openembedded.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/meta-erlang/meta-erlang</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>Source the init build environment script:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> poky</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> oe-init-build-env </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/build</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>Add the needed layers:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-openembedded/meta-oe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-erlang</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>Open the configuration file <em>build/local.conf</em> and change the 'MACHINE'
variable to 'qemux86-64'</p>
</li>
<li class="">
<p>Add what we want to install, hello-gleam-echo-server:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tee -a &lt;&lt;EOF conf/local.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IMAGE_INSTALL:append = " hello-gleam-echo-server curl"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span></code></pre></div></div>
<p>Let's install curl too. Because we want to check if echo-server is working as
expected.</p>
</li>
<li class="">
<p>Build a minimal image for testing purposes:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake core-image-minimal</span><br></span></code></pre></div></div>
<p>Depending your build machine it could take some time. It's ok. Remember that
YP/OE builds everything from source code.</p>
</li>
<li class="">
<p>Let's test running the QEMU:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">runqemu core-image-minimal serialstdio nographic slirp</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>You should see the login prompt after running the runqemu command:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Poky (Yocto Project Reference Distro) 5.1 qemux86-64 ttyS0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qemux86-64 login:</span><br></span></code></pre></div></div>
<p>The login name is root</p>
</li>
<li class="">
<p>The command <code>systemctl status hello-gleam-echo-server</code> shows that echo-server
is disabled and not running</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@qemux86-64:~# systemctl status hello-gleam-echo-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* hello-gleam-echo-server.service - gleam echo server example</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Loaded: loaded (/usr/lib/systemd/system/hello-gleam-echo-server.service; disabled; preset: disabled)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Active: inactive (dead)</span><br></span></code></pre></div></div>
<p>Let's start it with <code>systemctl start hello-gleam-echo-server</code></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@qemux86-64:~# systemctl start hello-gleam-echo-server</span><br></span></code></pre></div></div>
<p>And check again with <code>systemctl status</code></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@qemux86-64:~# systemctl status hello-gleam-echo-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* hello-gleam-echo-server.service - gleam echo server example</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Loaded: loaded (/usr/lib/systemd/system/hello-gleam-echo-server.service; disabled; preset: disabled)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Active: active (running) since Mon 2024-11-04 00:26:37 UTC; 1s ago</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Invocation: 721b391508544a27bdacd484d3f35be3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Main PID: 239 (entrypoint.sh)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Tasks: 26 (limit: 255)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Memory: 51.1M (peak: 51.5M)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     CPU: 3.043s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CGroup: /system.slice/hello-gleam-echo-server.service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |-239 /bin/sh /usr/lib/hello-gleam-echo-server/entrypoint.sh run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |-241 /usr/lib/erlang/erts-15.1.2/bin/beam.smp -- -root /usr/lib/erlang -bindir /usr/lib/erlang/erts-15.1.2/bin -progname erl -- -- -pa /usr/lib/hello-gleam-echo-server/elli/ebin /usr/lib/hello-gleam-echo-server/gleam_e...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          `-247 erl_child_setup 1024</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Nov 04 00:26:37 qemux86-64 systemd[1]: Started gleam echo server example.</span><br></span></code></pre></div></div>
<p>That looks really good. We can see that systemd is happy and tracking the
beam.smp process.</p>
</li>
<li class="">
<p>Calling curl to check if echo-server is working. We want to reach the
function hello from
<a href="https://github.com/gleam-lang/example-echo-server/blob/main/src/reply/web.gleam#L32" target="_blank" rel="noopener noreferrer" class="">web.gleam</a>
source code:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@qemux86-64:~</span><span class="token comment" style="color:#999988;font-style:italic"># curl -X POST -d 'Hello, Gleam!' http://localhost:3000/echo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello, Gleam</span><span class="token operator" style="color:#393A34">!</span><br></span></code></pre></div></div>
</li>
</ol>
<p>That's amazing and it's working as expected.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="hello-gleam-echo-server-explained">hello-gleam-echo-server explained<a href="https://meta-erlang.github.io/blog/2024/11/03/index/#hello-gleam-echo-server-explained" class="hash-link" aria-label="Direct link to hello-gleam-echo-server explained" title="Direct link to hello-gleam-echo-server explained" translate="no">‚Äã</a></h2>
<p>A bit more about bitbake, recipes and how gleam recipes works.</p>
<p>The snippet below shows the recipe
<a href="https://github.com/meta-erlang/meta-erlang/tree/master/recipes-examples/hello-gleam-echo-server/hello-gleam-echo-server_0.1.0.bb" target="_blank" rel="noopener noreferrer" class="">hello-gleam-echo-server</a>.
Thanks to gleam.bbclass the recipe is short and declarative.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SUMMARY = "An example Gleam web application "</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SECTION = "examples"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LICENSE = "Apache-2.0"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LIC_FILES_CHKSUM = "file://LICENCE;md5=bd052113ed5b73a32ff7cf9f42c3265c"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">S = "${WORKDIR}/git"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SRCREV = "94f29a84dc82ed4e7878d4027fd27acacdb8be84"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PV = "0.1.0+git${SRCPV}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SRC_URI = "git://github.com/gleam-lang/example-echo-server;branch=main;protocol=https \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           file://hello-gleam-echo-server.service"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">inherit gleam systemd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">do_install:append() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if ${@bb.utils.contains('DISTRO_FEATURES','systemd','true','false',d)}; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        install -d ${D}${systemd_unitdir}/system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        install -m 0644 ${UNPACKDIR}/hello-gleam-echo-server.service ${D}${systemd_unitdir}/system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SYSTEMD_SERVICE:${PN} = "hello-gleam-echo-server.service"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SYSTEMD_AUTO_ENABLE = "disable"</span><br></span></code></pre></div></div>
<p>This recipe instructs bitbake to fetch the example-echo-server source code,
build it and install some systemd scripts in order to start the
example-echo-server on target machine.</p>
<p>The systemd script is very simple:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description=gleam echo server example</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WorkingDirectory=/usr/lib/hello-gleam-echo-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStart=/usr/lib/hello-gleam-echo-server/entrypoint.sh run</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Install]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WantedBy=multi-user.target</span><br></span></code></pre></div></div>
<p>It just "runs" the entrypoint.sh script. The entrypoint.sh was created by gleam
tooling. The recipe takes care of installing the echo-server artifacts at
<em>/usr/lib/hello-gleam-echo-server</em>.</p>
<p>For more details, I recommend checking out the bitbake class
<a href="https://github.com/meta-erlang/meta-erlang/tree/master/classes/gleam.bbclass" target="_blank" rel="noopener noreferrer" class="">gleam.bbclass</a>.</p>]]></content>
        <author>
            <name>Jo√£o Henrique Ferreira de Freitas</name>
            <uri>https://github.com/joaohf</uri>
        </author>
        <category label="meta-erlang" term="meta-erlang"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Running Erlang/OTP test suite on target with ptest]]></title>
        <id>https://meta-erlang.github.io/blog/2024/10/12/index/</id>
        <link href="https://meta-erlang.github.io/blog/2024/10/12/index/"/>
        <updated>2024-10-12T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[ptest (package test) means packaging and installing runtime tests that are]]></summary>
        <content type="html"><![CDATA[<p>ptest (package test) means packaging and installing runtime tests that are
included in many upstream packages. At the end of the day it runs Erlang/OTP
cross compiled test suite on the target hardware. The aim is to detect a range
of problems when running test suites on different combinations of architecture
processors and libc.</p>
<p>The Erlang/OTP howto about
<a href="https://github.com/erlang/otp/blob/master/HOWTO/TESTING.md" target="_blank" rel="noopener noreferrer" class="">TESTING.md</a>
explains most of the details when running tests. While the Yocto's documentation
about
<a href="https://docs.yoctoproject.org/dev-manual/packages.html#testing-packages-with-ptest" target="_blank" rel="noopener noreferrer" class="">Testing Packages With ptest</a>
explains the ptest configuration.</p>
<p>So, this post is about how to run those tests using ptest approach on Yocto
builds.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="how-does-ptest-work-">How does ptest work ?<a href="https://meta-erlang.github.io/blog/2024/10/12/index/#how-does-ptest-work-" class="hash-link" aria-label="Direct link to How does ptest work ?" title="Direct link to How does ptest work ?" translate="no">‚Äã</a></h2>
<p>Recipes with ptest enabled includes a shell script called <em>run-ptest</em> with the
steps necessary to start the test suite provided by the target software (e.g.:
Erlang/OTP).</p>
<p>The run-ptest script is responsible for starting the test suite and
consolidating the test results into a single format. The format is the
<a href="https://www.gnu.org/software/automake/manual/automake.html#Simple-Tests" target="_blank" rel="noopener noreferrer" class="">automake simple test</a>
format:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">result: testName</span><br></span></code></pre></div></div>
<p>Where: <em>result</em> is one of PASS, FAIL or SKIP and <em>testName</em> can be anything.</p>
<p>The erlang recipe from meta-erlang layer supports ptest. And, when activated,
the package erlang-ptest is installed into the final image. It has the erlang
test suite cross compiled and ready to be executed.</p>
<p>When ptest for erlang recipe gets executed, it finishes the erlang test suite
configuration and starts to run each test configured in run-ptest script.</p>
<p>The Erlang/OTP requires several hours to finish. Because of that, ptest for
erlang just executes a small set of all tests available (currently only
<em>emulator</em> and <em>kernel</em> tests are enabled).</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>To get a better idea about how to run Erlang/OTP test suites the documentation
<a href="https://github.com/erlang/otp/blob/master/HOWTO/TESTING.md" target="_blank" rel="noopener noreferrer" class="">TESTING.md</a>,
specially the session Running the tests.</p></div></div>
<p>The erlang-ptest package installs the test suite and also the run-ptest script
at <em>/usr/lib/erlang/ptest</em> folder.</p>
<p>One point very important is that Erlang/OTP test suites need some tools
installed into the target image in order to execute some tests. For example, to
run emulator and kernel tests the target OS needs tmux and openssh packages.
However the erlang recipe takes care of these details.</p>
<p>Each test suite might require additional packages. As there is no documentation
describing all the requirements the best strategy is to inspect the test suite
for each Erlang/OTP application
(<a href="https://github.com/erlang/otp/tree/master/lib" target="_blank" rel="noopener noreferrer" class="">lib/*/test</a> and
<a href="https://github.com/erlang/otp/tree/master/erts/test" target="_blank" rel="noopener noreferrer" class="">erts/test</a> folders).</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="running-erlangotp-ptest">Running Erlang/OTP ptest<a href="https://meta-erlang.github.io/blog/2024/10/12/index/#running-erlangotp-ptest" class="hash-link" aria-label="Direct link to Running Erlang/OTP ptest" title="Direct link to Running Erlang/OTP ptest" translate="no">‚Äã</a></h2>
<p>Yocto provides some configuration when enabling ptest. As it is only relevant
for testing purposes.</p>
<p>A specific image feature exists that enables ptest. So, in the local.conf
configuration file:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># ptest image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EXTRA_IMAGE_FEATURES += "ptest-pkgs"</span><br></span></code></pre></div></div>
<p>This is all that is necessary to do in order to enable ptest build.</p>
<p>As we want to install erlang in the final image, we also need to add it to the
final image. On build/local.conf configuration file:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># installing erlang and elixir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IMAGE_INSTALL:append:pn-core-image-minimal = " erlang erlang-modules-dev elixir elixir-modules-dev links"</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The <em>links</em> package here is necessary to open HTML common test reports from
console.</p></div></div>
<p>It's ready to build the core-image-minimal image:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake core-image-minimal</span><br></span></code></pre></div></div>
<p>And, for testing purposes, run the generated image using qemu emulator:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">runqemu slirp kvm nographic serialstdio core-image-minimal</span><br></span></code></pre></div></div>
<p>Logging into the running system and execute ptest for erlang:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Poky (Yocto Project Reference Distro) 5.1 qemux86-64 ttyS0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qemux86-64 login: root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: Poky is a reference Yocto Project distribution that should be used for</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">testing and development purposes only. It is recommended that you create your</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">own distribution for production use.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@qemux86-64:~# ptest-run erlang</span><br></span></code></pre></div></div>
<p>The script /usr/lib/erlang/ptest/run-ptest starts execute controlled by the
application called <a href="https://git.yoctoproject.org/ptest-runner2/" target="_blank" rel="noopener noreferrer" class="">ptest runner</a>.
After several hours we get the following results:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">START: ptest-runner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024-10-14T17:15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BEGIN: /usr/lib/erlang/ptest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FAIL: emulator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">... lots of console messages ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FAIL: kernel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">... lots of console messages ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">=== common test Summary ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Testing tests.emulator_test: TEST COMPLETE, 2112 ok, 4 failed, 82 skipped of 2198 test cases</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Testing tests.kernel_test: TEST COMPLETE, 1338 ok, 20 failed, 293 skipped of 1651 test cases</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">=== Test Summary ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TOTAL: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PASSED: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FAILED: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DURATION: 5822</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">END: /usr/lib/erlang/ptest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024-10-14T01:39</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">STOP: ptest-runner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TOTAL: 1 FAIL: 0</span><br></span></code></pre></div></div>
<p>Well, we got 4 fails for emulator tests and 20 fails for kernel tests. Not bad,
but I don't know if it is also good.</p>
<p>For further inspection, it's possible to also check output messages for each
test. The run-ptest script writes a specific log console for each test executed:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@qemux86-64:~# ls /usr/lib/erlang/ptest/ -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total 14680</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--  1 root root   236964 Oct 14 00:40 erlang_ptest_emulator_20241014-000215.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r--  1 root root 14770546 Oct 14 01:39 erlang_ptest_kernel_20241014-004016.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x  1 root root      807 Oct 14 00:01 run-ptest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 39 root root     4096 Apr  5  2011 tests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>As usual when running common tests (remember Erlang/OTP test suites are just
common tests), the HTML reports were written at
<em>/usr/lib/erlang/ptest/tests/test_server/index.html</em>. Opening it with links
command to check the results:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">links /usr/lib/erlang/ptest/tests/test_server/index.html</span><br></span></code></pre></div></div>
<p>ptest produces a lot of data to inspect.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="running-elixir-ptest">Running Elixir ptest<a href="https://meta-erlang.github.io/blog/2024/10/12/index/#running-elixir-ptest" class="hash-link" aria-label="Direct link to Running Elixir ptest" title="Direct link to Running Elixir ptest" translate="no">‚Äã</a></h2>
<p>The steps for running elixir ptest are almost the same for erlang. We just call
ptest-run with the argument elixir:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@qemux86-64:~# ptest-run elixir</span><br></span></code></pre></div></div>
<p>The above command runs elixir ptest and reports some results:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">START: ptest-runner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024-10-18T02:27</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BEGIN: /usr/lib/elixir/ptest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PASS: erlang</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FAIL: stdlib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PASS: ex_unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FAIL: logger</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PASS: eex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FAIL: mix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FAIL: iex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">=== Test Summary ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TOTAL: 7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PASSED: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FAILED: 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DURATION: 148</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">END: /usr/lib/elixir/ptest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2024-10-18T02:30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">STOP: ptest-runner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TOTAL: 1 FAIL: 0</span><br></span></code></pre></div></div>
<p>For further inspection, it's possible to also check output messages for each
test. The run-ptest script writes a specific log console for each test executed:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@qemux86-64:~# ls /usr/lib/elixir/ptest/ -l</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x 6 root root  4096 Apr  5  2011 elixir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root   840 Oct 18 02:28 elixir_ptest_eex_20241018-022812.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root   323 Oct 18 02:27 elixir_ptest_erlang_20241018-022744.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root  1156 Oct 18 02:28 elixir_ptest_ex_unit_20241018-022806.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root  4230 Oct 18 02:30 elixir_ptest_iex_20241018-023005.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root  2648 Oct 18 02:28 elixir_ptest_logger_20241018-022810.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root 11243 Oct 18 02:30 elixir_ptest_mix_20241018-022814.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 root root 16895 Oct 18 02:28 elixir_ptest_stdlib_20241018-022745.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x 1 root root   950 Oct 18 02:27 run-ptest</span><br></span></code></pre></div></div>
<p>Again, ptest produces a lot of data to inspect.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="why-running-ptest-for-erlangotp-on-yocto-builds-is-important-">Why running ptest for Erlang/OTP on Yocto builds is important ?<a href="https://meta-erlang.github.io/blog/2024/10/12/index/#why-running-ptest-for-erlangotp-on-yocto-builds-is-important-" class="hash-link" aria-label="Direct link to Why running ptest for Erlang/OTP on Yocto builds is important ?" title="Direct link to Why running ptest for Erlang/OTP on Yocto builds is important ?" translate="no">‚Äã</a></h2>
<p>Now that we know what is ptest. Given the following question:</p>
<blockquote>
<p>How do we know that a cross compiled Erlang/OTP build really works on the
target hardware ?</p>
</blockquote>
<p>The answer could be: testing it using tests provided by Erlang/OTP source code.</p>
<p>So, ptest is great for detecting problems.</p>
<p>As ptest has the ability of running Erlang/OTP test suites on the final image
and reporting the results, we can get a baseline when comparing tests executed
on different combinations of processor architectures and C standard libraries
(libc) or any other aspect like different linux kernel versions. It's possible
to detect regressions or find weak spots not covered by tests in a specific
platform.</p>
<p>Also, the mechanism of executing those tests is simple. The user does not need
to be an Erlang expert to check that something is not ok on some platform.</p>]]></content>
        <author>
            <name>Jo√£o Henrique Ferreira de Freitas</name>
            <uri>https://github.com/joaohf</uri>
        </author>
        <category label="meta-erlang" term="meta-erlang"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Anatomy of erlang and elixir packages for YP/OE]]></title>
        <id>https://meta-erlang.github.io/blog/2024/10/06/index/</id>
        <link href="https://meta-erlang.github.io/blog/2024/10/06/index/"/>
        <updated>2024-10-06T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Usually, when designing a linux distribution using YP/OE we want a slim image]]></summary>
        <content type="html"><![CDATA[<p>Usually, when designing a linux distribution using YP/OE we want a slim image
with only what we need to run a specific application (or applications). In this
post we'll discuss a bit about erlang and elixir packages that meta-erlang layer
provides.</p>
<p>It's important to know how the packages are divided into smaller ones in order
to offer a better composition when creating linux distributions with YP/OE.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="environment-setup">Environment setup<a href="https://meta-erlang.github.io/blog/2024/10/06/index/#environment-setup" class="hash-link" aria-label="Direct link to Environment setup" title="Direct link to Environment setup" translate="no">‚Äã</a></h2>
<ol>
<li class="">
<p>Cloning all repositories for master branch:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master git://git.yoctoproject.org/poky</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/openembedded/meta-openembedded.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/meta-erlang/meta-erlang</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> master https://github.com/meta-erlang/meta-axon</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>Source the init build environment script:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> poky</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> oe-init-build-env </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/build</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>Add the needed layers:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-openembedded/meta-oe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-erlang</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-axon</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>Configure the <code>conf/local.conf</code> and enable multiconfig builds:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># debug-tweaks</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EXTRA_IMAGE_FEATURES ?= "debug-tweaks"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">USER_CLASSES ?= "buildhistory buildstats"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">BUILDHISTORY_COMMIT = "1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">PACKAGE_CLASSES = "package_ipk"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">PATCHRESOLVE = "noop"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">INHERIT += "rm_work"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">RM_WORK_EXCLUDE = "erlang erlang-native nativesdk-erlang"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># diskmon</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">BB_DISKMON_DIRS = "\</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    STOPTASKS,</span><span class="token string variable" style="color:#36acaa">${TMPDIR}</span><span class="token string" style="color:#e3116c">,1G,100K \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    STOPTASKS,</span><span class="token string variable" style="color:#36acaa">${DL_DIR}</span><span class="token string" style="color:#e3116c">,1G,100K \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    STOPTASKS,</span><span class="token string variable" style="color:#36acaa">${SSTATE_DIR}</span><span class="token string" style="color:#e3116c">,1G,100K \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    STOPTASKS,/tmp,100M,100K \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    HALT,</span><span class="token string variable" style="color:#36acaa">${TMPDIR}</span><span class="token string" style="color:#e3116c">,100M,1K \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    HALT,</span><span class="token string variable" style="color:#36acaa">${DL_DIR}</span><span class="token string" style="color:#e3116c">,100M,1K \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    HALT,</span><span class="token string variable" style="color:#36acaa">${SSTATE_DIR}</span><span class="token string" style="color:#e3116c">,100M,1K \</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    HALT,/tmp,10M,1K"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># general config</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">SDKMACHINE = "x86_64"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># local</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">CONNECTIVITY_CHECK_URIS = "https://www.google.com/"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># master</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># qemu configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">PACKAGECONFIG:append:pn-qemu-system-native = " sdl"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">PACKAGECONFIG:append:pn-qemu-system-native = " gtk+"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># systemd only</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">INIT_MANAGER = "systemd"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">MACHINE ??= "qemuarm"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">DISTRO ??= "poky"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">BBMULTICONFIG ?= "qemux86-64-erlang-elixir qemuarm64-erlang-elixir qemuarm-erlang-elixir qemux86-erlang-elixir qemux86-64-x32-erlang-elixir"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># To disable QA checks for https://github.com/meta-erlang/meta-erlang/issues/328</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">ERROR_QA:remove = "buildpaths"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre></div></div>
</li>
</ol>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="multiconfig-build">multiconfig build<a href="https://meta-erlang.github.io/blog/2024/10/06/index/#multiconfig-build" class="hash-link" aria-label="Direct link to multiconfig build" title="Direct link to multiconfig build" translate="no">‚Äã</a></h2>
<p>YP/OE provides a smart way to build the same image (or different images) for
multiple targets. It is called multiconfig build and it is fully described at
<a href="https://docs.yoctoproject.org/dev-manual/building.html?highlight=multiconfig#building-images-for-multiple-targets-using-multiple-configurations" target="_blank" rel="noopener noreferrer" class="">Building Images for Multiple Targets Using Multiple Configurations</a>.</p>
<p>Four our context, don't forget to checkout the section
<a href="https://meta-erlang.github.io/blog/2024/10/06/index/#environment-setup" class="">Environment setup</a>, we need to compare the erlang and
elixir packages using different processor architectures (<em>MACHINES</em> in YP/OE
language).</p>
<p>We can build five targets using the command below:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake </span><span class="token parameter variable" style="color:#36acaa">-c</span><span class="token plain"> build </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    multiconfig:qemux86-64-erlang-elixir:core-image-minimal </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    multiconfig:qemux86-erlang-elixir:core-image-minimal </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    multiconfig:qemuarm-erlang-elixir:core-image-minimal </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    multiconfig:qemuarm64-erlang-elixir:core-image-minimal </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    multiconfig:qemux86-64-x32-erlang-elixir:core-image-minimal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>The multiconfig build was configured to create a specific TMPDIR for each
processor architecture. Then, the final results at build folder will be one
folder for each architecture:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tmp-qemuarm64-glibc-erlang-elixir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tmp-qemuarm-glibc-erlang-elixir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tmp-qemux86-64-glibc-erlang-elixir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tmp-qemux86-64-glibc-x32-erlang-elixir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tmp-qemux86-glibc-erlang-elixir</span><br></span></code></pre></div></div>
<p>That way, it's easy to navigate into the final output files.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="introspection-with-buildhistory">Introspection with buildhistory<a href="https://meta-erlang.github.io/blog/2024/10/06/index/#introspection-with-buildhistory" class="hash-link" aria-label="Direct link to Introspection with buildhistory" title="Direct link to Introspection with buildhistory" translate="no">‚Äã</a></h2>
<p>The buildhistory is a YP/OE feature that writes some meta data into a git
repository for further inspection. Then, it's possible check and interact with
files using standard linux tools like find and grep to collect insights. Using
buildhistory is a shortcut because we can inspect how files would be installed
into the final image, without having to burn the image and boot it on a real (or
virtual) target.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Check out the
<a href="https://docs.yoctoproject.org/5.0.3/dev-manual/build-quality.html?highlight=buildhistory#enabling-and-disabling-build-history" target="_blank" rel="noopener noreferrer" class="">Enabling and Disabling Build History</a>
instructions for how to enable buildhistory.</p></div></div>
<p>In this post we are interested in check the size of erlang and elixir packages.</p>
<p>After a success build and from the YP/OE build folder, it's possible to explore
the buildhistory git repository:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> buildhistory/packages/cortexa57-poky-linux/erlang</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-name</span><span class="token plain"> latest </span><span class="token parameter variable" style="color:#36acaa">-print0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">xargs</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-0</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> PKGSIZE </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sort</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> buildhistory/packages/cortexa57-poky-linux/elixir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-name</span><span class="token plain"> latest </span><span class="token parameter variable" style="color:#36acaa">-print0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">xargs</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-0</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> PKGSIZE </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sort</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span></code></pre></div></div>
<p><code>PKGSIZE</code> gives to us the size in bytes of the final packages generated by
erlang and elixir recipes.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="ypoe-packaging-for-erlang-and-elixir-recipes">YP/OE packaging for erlang and elixir recipes<a href="https://meta-erlang.github.io/blog/2024/10/06/index/#ypoe-packaging-for-erlang-and-elixir-recipes" class="hash-link" aria-label="Direct link to YP/OE packaging for erlang and elixir recipes" title="Direct link to YP/OE packaging for erlang and elixir recipes" translate="no">‚Äã</a></h2>
<p>The nature of Erlang/OTP is to isolate erlang modules into applications. The
Erlang/OTP source code embraces this philosophy and it is natural to transform
each application into an installed package (IPK, DEB, RPM). For that,
meta-erlang uses a simple script that creates a recipe manifest (see
<a href="https://github.com/meta-erlang/meta-erlang/blob/cb94887c108b63c6cba290cb019468f246df5ea4/scripts/contrib/erlang/generate-manifest#L76" target="_blank" rel="noopener noreferrer" class="">erlang recipe manifest</a>
for details).</p>
<p>An erlang recipe manifest, for example
<a href="https://github.com/meta-erlang/meta-erlang/blob/cb94887c108b63c6cba290cb019468f246df5ea4/recipes-devtools/erlang/erlang-27.1-manifest.inc" target="_blank" rel="noopener noreferrer" class="">erlang-27.1-manifest.inc</a>,
declares each Erlang/OTP application. For each application there are five
packages:</p>
<ul>
<li class=""><code>application_name-doc</code>: documentation, man pages and examples</li>
<li class=""><code>application_name-dbg</code>: debug symbols, if any</li>
<li class=""><code>application_name-dev</code>: development C headers, shared libraries (*.so)</li>
<li class=""><code>application_name-staticdev</code>: static libraries (*.a)</li>
<li class=""><code>application_name</code>: BEAM modules and files from <code>priv</code> folder</li>
</ul>
<p>Where <code>application_name</code> is the name of the application like: kernel, stdlib,
sasl, ...</p>
<p>This separation is necessary because YP/OE splits the package of any recipe into
doc, dbg, dev and staticdev. Then, the user have more control about what will be
installed into the final image.</p>
<p>The elixir recipe follows the same way, but simpler (check out the
<a href="https://github.com/meta-erlang/meta-erlang/blob/cb94887c108b63c6cba290cb019468f246df5ea4/recipes-devtools/elixir/elixir.inc" target="_blank" rel="noopener noreferrer" class="">elixir.inc</a>
include file).</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="special-metapackages">Special metapackages<a href="https://meta-erlang.github.io/blog/2024/10/06/index/#special-metapackages" class="hash-link" aria-label="Direct link to Special metapackages" title="Direct link to Special metapackages" translate="no">‚Äã</a></h3>
<p>As there are many packages for erlang and elixir, sometimes we need to setup a
development environment will all erlang and elixir packages installed. Or a
minimum set of packages. There are a couple of metapackages created for that
purpose:</p>
<ul>
<li class="">erlang-modules: install <em>all</em> Erlang/OTP applications</li>
<li class="">erlang-modules-dev: install <em>all</em> Erlang/OTP applications development packages</li>
<li class="">elixir-modules: install <em>all</em> elixir applications</li>
<li class="">elixir-modules-dev: install <em>all</em> elixir applications development packages</li>
<li class="">erlang: install the minimal Erlang/OTP applications</li>
<li class="">elixir: install the minimal elixir applications</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="where-the-files-get-installed-">Where the files get installed ?<a href="https://meta-erlang.github.io/blog/2024/10/06/index/#where-the-files-get-installed-" class="hash-link" aria-label="Direct link to Where the files get installed ?" title="Direct link to Where the files get installed ?" translate="no">‚Äã</a></h3>
<p>The best way to awnser this is to take a look into buildhistory data.</p>
<p>At the build folder there is a folder called buildhistory. That folder is split
by images and packages. And for each architecture, there is a specific folder.
So, let's check the first 20 lines from file: files-in-packages.txt for
erlang-erts package:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">head</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-n</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token plain"> buildhistory/packages/core2-32-poky-linux/erlang/erlang-erts/files-in-package.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> ./usr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> ./usr/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx root       root               </span><span class="token number" style="color:#36acaa">22</span><span class="token plain"> ./usr/bin/epmd -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/lib/erlang/bin/epmd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx root       root               </span><span class="token number" style="color:#36acaa">21</span><span class="token plain"> ./usr/bin/erl -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/lib/erlang/bin/erl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx root       root               </span><span class="token number" style="color:#36acaa">25</span><span class="token plain"> ./usr/bin/escript -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/lib/erlang/bin/escript</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx root       root               </span><span class="token number" style="color:#36acaa">25</span><span class="token plain"> ./usr/bin/run_erl -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/lib/erlang/bin/run_erl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx root       root               </span><span class="token number" style="color:#36acaa">24</span><span class="token plain"> ./usr/bin/to_erl -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/lib/erlang/bin/to_erl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> ./usr/lib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> ./usr/lib/erlang</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">drwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> ./usr/lib/erlang/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx root       root               </span><span class="token number" style="color:#36acaa">21</span><span class="token plain"> ./usr/lib/erlang/bin/epmd -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/erts-15.1/bin/epmd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">1474</span><span class="token plain"> ./usr/lib/erlang/bin/erl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x root       root           </span><span class="token number" style="color:#36acaa">140752</span><span class="token plain"> ./usr/lib/erlang/bin/erl_call</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x root       root            </span><span class="token number" style="color:#36acaa">38456</span><span class="token plain"> ./usr/lib/erlang/bin/escript</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- root       root             </span><span class="token number" style="color:#36acaa">6860</span><span class="token plain"> ./usr/lib/erlang/bin/no_dot_erlang.boot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x root       root            </span><span class="token number" style="color:#36acaa">25996</span><span class="token plain"> ./usr/lib/erlang/bin/run_erl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">1745</span><span class="token plain"> ./usr/lib/erlang/bin/start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- root       root             </span><span class="token number" style="color:#36acaa">6885</span><span class="token plain"> ./usr/lib/erlang/bin/start.boot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- root       root             </span><span class="token number" style="color:#36acaa">6885</span><span class="token plain"> ./usr/lib/erlang/bin/start_clean.boot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rwxr-xr-x root       root             </span><span class="token number" style="color:#36acaa">1244</span><span class="token plain"> ./usr/lib/erlang/bin/start_erl</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="erlang-package-sizes">erlang package sizes<a href="https://meta-erlang.github.io/blog/2024/10/06/index/#erlang-package-sizes" class="hash-link" aria-label="Direct link to erlang package sizes" title="Direct link to erlang package sizes" translate="no">‚Äã</a></h2>
<p>When installing the metapackage called <code>erlang</code> the following packages will be
automatically installed:</p>
<ul>
<li class="">erlang-erts</li>
<li class="">erlang-kernel</li>
<li class="">erlang-stdlib</li>
<li class="">erlang-sasl</li>
</ul>
<p>These packages are the basic ones needed in order to run Erlang programs.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Actually, your application is in charge of making a proper Erlang/OTP
release. Installing the package <code>erlang</code> is an option if you need it installed
into standard locations. Otherwise, your application should produce a valide
release with a builtin ERTS inside.</p></div></div>
<p>The following charts are listed below to get a view about the size of those
basic erlang packages.</p>
<p>The difference between each build, besides the processor architecture, is the
size in bytes of the package erlang-erts. That makes sense because that package
is the ERTS (which is architecture dependent, like word size). On other hand,
the packages kernel, stdlib, sasl have the same size across all builds.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="qemux86">qemux86<a href="https://meta-erlang.github.io/blog/2024/10/06/index/#qemux86" class="hash-link" aria-label="Direct link to qemux86" title="Direct link to qemux86" translate="no">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake </span><span class="token parameter variable" style="color:#36acaa">-c</span><span class="token plain"> build multiconfig:qemux86-erlang-elixir:core-image-minimal</span><br></span></code></pre></div></div>
<!-- -->
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="qemux86-64">qemux86-64<a href="https://meta-erlang.github.io/blog/2024/10/06/index/#qemux86-64" class="hash-link" aria-label="Direct link to qemux86-64" title="Direct link to qemux86-64" translate="no">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake </span><span class="token parameter variable" style="color:#36acaa">-c</span><span class="token plain"> build multiconfig:qemux86-64-erlang-elixir:core-image-minimal</span><br></span></code></pre></div></div>
<!-- -->
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="qemux86-64-with-x32-psabi">qemux86-64 with x32 psABI<a href="https://meta-erlang.github.io/blog/2024/10/06/index/#qemux86-64-with-x32-psabi" class="hash-link" aria-label="Direct link to qemux86-64 with x32 psABI" title="Direct link to qemux86-64 with x32 psABI" translate="no">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake </span><span class="token parameter variable" style="color:#36acaa">-c</span><span class="token plain"> build multiconfig:x86_64_x32-poky-linux-gnux32:core-image-minimal</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Enabling x32 psABI should be considered if your application needs to
handle 64-bit features, but you can't afford wasting space with addressing. See
the blog post <a class="" href="https://meta-erlang.github.io/blog/2023/09/02/index/">Exploring x32 psABI for Erlang/OTP</a>.</p><p>The package size difference in bytes between x32 build and a normal x86-64
is 4615556.</p></div></div>
<!-- -->
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="qemuarm64">qemuarm64<a href="https://meta-erlang.github.io/blog/2024/10/06/index/#qemuarm64" class="hash-link" aria-label="Direct link to qemuarm64" title="Direct link to qemuarm64" translate="no">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake </span><span class="token parameter variable" style="color:#36acaa">-c</span><span class="token plain"> build multiconfig:qemuarm64-erlang-elixir:core-image-minimal</span><br></span></code></pre></div></div>
<!-- -->
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="qemuarm">qemuarm<a href="https://meta-erlang.github.io/blog/2024/10/06/index/#qemuarm" class="hash-link" aria-label="Direct link to qemuarm" title="Direct link to qemuarm" translate="no">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake </span><span class="token parameter variable" style="color:#36acaa">-c</span><span class="token plain"> build multiconfig:qemuarm-erlang-elixir:core-image-minimal</span><br></span></code></pre></div></div>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="elixir-package-sizes">elixir package sizes<a href="https://meta-erlang.github.io/blog/2024/10/06/index/#elixir-package-sizes" class="hash-link" aria-label="Direct link to elixir package sizes" title="Direct link to elixir package sizes" translate="no">‚Äã</a></h2>
<p>When installing the metapackage called <code>elixir</code> the following packages will be
automatically installed:</p>
<ul>
<li class="">erlang (see <a href="https://meta-erlang.github.io/blog/2024/10/06/index/#erlang-package-sizes" class="">erlang package size for details</a>)</li>
<li class="">erlang-compiler</li>
</ul>
<p>That is because elixir package needs erlang (erts, kernel, stdlib and sasl)
installed. And, the erlang compiler is also a requirement.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Again, your application should manage a release for best results.
Installing the package <code>elixir</code> only makes sense for testing purposes.</p></div></div>
<p>The following table summarizes the packages sizes per processor architecture.</p>
<table><thead><tr><th>Processor architecture</th><th>Package size in bytes</th></tr></thead><tbody><tr><td>core2-32-poky-linux (qemux86)</td><td>5760108</td></tr><tr><td>core2-64-poky-linux (qemux86-64)</td><td>5760368</td></tr><tr><td>qemux86-64-x32-erlang-elixir</td><td>5763392</td></tr><tr><td>cortexa57-poky-linux (qemuarm64)</td><td>5760476</td></tr><tr><td>cortexa15t2hf-neon-poky-linux-gnueabi</td><td>5764076</td></tr></tbody></table>
<p>There are slight size differences. It should not as there is no architecture
dependency on elixir beam files.</p>]]></content>
        <author>
            <name>Jo√£o Henrique Ferreira de Freitas</name>
            <uri>https://github.com/joaohf</uri>
        </author>
        <category label="meta-erlang" term="meta-erlang"/>
        <category label="x32" term="x32"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[fwup for A/B image upgrades, part I]]></title>
        <id>https://meta-erlang.github.io/blog/2024/09/24/index/</id>
        <link href="https://meta-erlang.github.io/blog/2024/09/24/index/"/>
        <updated>2024-09-24T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[This blog post is a tutorial about how to make A/B software updates with fwup]]></summary>
        <content type="html"><![CDATA[<p>This blog post is a tutorial about how to make A/B software updates with fwup
tool and Yocto Project.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="objectives-and-tools">Objectives and Tools<a href="https://meta-erlang.github.io/blog/2024/09/24/index/#objectives-and-tools" class="hash-link" aria-label="Direct link to Objectives and Tools" title="Direct link to Objectives and Tools" translate="no">‚Äã</a></h2>
<p>A short sentence as requirement for this tutorial is:</p>
<blockquote>
<p>I wish to make an image using Yocto Project and be able to run software
updates using A/B approach.</p>
</blockquote>
<p>There are many references on the Internet for A/B software updates. It's a
well-known approach with many different implementations. In short it's strategy
to minimize downtime when changing the firmware of embedded devices. While the
new software gets written to the unused slot and the current slot is still
running. When everything are ready to swap, the system gets restarted. Booting
using the unused slot (now it becomes the current slot).</p>
<p>So, in this blog post we are going to play with A/B software updates using fwup
tool.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-is-fwup-">What is fwup ?<a href="https://meta-erlang.github.io/blog/2024/09/24/index/#what-is-fwup-" class="hash-link" aria-label="Direct link to What is fwup ?" title="Direct link to What is fwup ?" translate="no">‚Äã</a></h2>
<p>The best <a href="https://github.com/fwup-home/fwup" target="_blank" rel="noopener noreferrer" class="">fwup</a> definition is from its
official project home:</p>
<blockquote>
<p>fwup is a configurable image-based software update utility for embedded
Linux-based systems. It primarily supports software upgrade strategies that
update entire root filesystem images at once. This includes strategies like
swapping back and forth between A and B partitions, recovery partitions, and
various trial update/failback scenarios. All software update information is
combined into a ZIP archive that may optionally be cryptographically signed.
fwup has minimal dependencies and runtime requirements. Scripts are
intentionally limited to make failure scenarios easier to reason about.
Distribution of software update archives is not a feature. Users can call out
to fwup to run upgrades from external media, stream them from the network, or
script them using a tool like Ansible if so desired.</p>
</blockquote>
<p>In practice, fwup is simple and easy to use.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="ypoe-setup">YP/OE setup<a href="https://meta-erlang.github.io/blog/2024/09/24/index/#ypoe-setup" class="hash-link" aria-label="Direct link to YP/OE setup" title="Direct link to YP/OE setup" translate="no">‚Äã</a></h2>
<p>I'll try to simplify the YP/OE setup to just tree small steps:</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The YP documentation is very good. I strong recommend its reading. For this
section the release version used is
<a href="https://docs.yoctoproject.org/brief-yoctoprojectqs/index.html" target="_blank" rel="noopener noreferrer" class="">scarthgap</a>.</p><p>One important point is to double check the
<a href="https://docs.yoctoproject.org/ref-manual/system-requirements.html#required-packages-for-the-build-host." target="_blank" rel="noopener noreferrer" class="">Required Packages for the Build Host</a></p></div></div>
<ol>
<li class="">
<p>Cloning all repositories for scarthgap release:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> scarthgap git://git.yoctoproject.org/poky</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> scarthgap https://github.com/openembedded/meta-openembedded.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> scarthgap https://github.com/fwup-home/meta-fwup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> scarthgap https://github.com/meta-erlang/meta-erlang</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> scarthgap https://github.com/meta-erlang/meta-axon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone </span><span class="token parameter variable" style="color:#36acaa">--branch</span><span class="token plain"> scarthgap https://github.com/agherzan/meta-raspberrypi</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>Source the init build environment script:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> poky</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> oe-init-build-env </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/build</span><br></span></code></pre></div></div>
</li>
<li class="">
<p>Add the needed layers:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-openembedded/meta-oe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-erlang</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-axon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-fwup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bitbake-layers add-layer </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/meta-raspberrypi</span><br></span></code></pre></div></div>
</li>
</ol>
<p>Why five layers are needed ? Because the YP/OE approach is to isolate components
into layer in order to maximize the software reusability.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="configuring-the-build-environment">Configuring the build environment<a href="https://meta-erlang.github.io/blog/2024/09/24/index/#configuring-the-build-environment" class="hash-link" aria-label="Direct link to Configuring the build environment" title="Direct link to Configuring the build environment" translate="no">‚Äã</a></h2>
<p>For this tutorial, the quickest way is edit and add the <em>conf/local.conf</em>
configuration file.</p>
<p>We start defining the MACHINE and DISTRO:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MACHINE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"raspberrypi0-wifi"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DISTRO </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"poky"</span><br></span></code></pre></div></div>
<p>The layer
<a href="https://meta-raspberrypi.readthedocs.io/en/latest/readme.html" target="_blank" rel="noopener noreferrer" class="">meta-raspberry</a>
provides the machine <em>raspberrypi0-wifi</em> which is what I'm using for this
demonstration as my current development board is a raspberry pi 0.</p>
<p>Next, we need to enable some raspberry features like UART and USB host support
(it's important to get some network connectivity):</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> conf/local.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># https://meta-raspberrypi.readthedocs.io/en/latest/extra-build-config.html#enable-uart</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">ENABLE_UART = "1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># https://meta-raspberrypi.readthedocs.io/en/latest/extra-build-config.html#enable-usb-host-support</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">ENABLE_DWC2_PERIPHERAL = "1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># add some package to allow networking</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">IMAGE_INSTALL:append = " raspi2go kernel-module-libcomposite kernel-module-g-ether kernel-module-dwc2"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre></div></div>
<p>As YP/OE supports many types of image outputs, we want to be specific here and
pick only the <em>fwup</em> type.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> conf/local.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># enable support for making fwup images</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">IMAGE_CLASSES += "image_types_fwup"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">IMAGE_FSTYPES = "fwup"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre></div></div>
<p>The fwup type is provided by the bbclass
<a href="https://github.com/fwup-home/meta-fwup/blob/master/classes/image_types_fwup.bbclass" target="_blank" rel="noopener noreferrer" class="">image_types_fwup.bbclass</a>.
It relies on wic image generator and uses their build artifacts for bootloader
and rootfs.</p>
<p>Ok, now we also want to include Erlang/OTP and Elixir. As meta-erlang provides
many versions, I recommend to stick with a specific one. In our case the latest
1.17.x and 27.0.x are good:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> conf/local.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># select specific elixir and erlang versions</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">PREFERRED_VERSION_elixir = "1.17%"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">PREFERRED_VERSION_elixir-native = "1.17%"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">PREFERRED_VERSION_nativesdk-elixir = "1.17%"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">PREFERRED_VERSION_erlang = "27.0%"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">PREFERRED_VERSION_erlang-native = "27.0%"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">PREFERRED_VERSION_nativesdk-erlang = "27.0%"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre></div></div>
<p>Finally, add erlang and elixir to the image:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> conf/local.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># add erlang and elixir into image</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">IMAGE_INSTALL:append = " erlang elixir"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre></div></div>
<p>Now that the configuration is over. Let's start a build:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake core-image-full-cmdline</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>It might take some time for the first build. As YP/OE will build everything from
scratch. The next builds should be faster.</p></div></div>
<p>Once the build has finished, let's inspect the build outputs:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> tmp/deploy/images/raspberrypi0-wifi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-l</span><span class="token plain"> core-image-full-cmdline*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> builder builder </span><span class="token number" style="color:#36acaa">68465478</span><span class="token plain"> Sep </span><span class="token number" style="color:#36acaa">24</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">21</span><span class="token plain">:19 core-image-full-cmdline-raspberrypi0-wifi.rootfs-20240924200317.fw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lrwxrwxrwx </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> builder builder       </span><span class="token number" style="color:#36acaa">66</span><span class="token plain"> Sep </span><span class="token number" style="color:#36acaa">24</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">21</span><span class="token plain">:19 core-image-full-cmdline-raspberrypi0-wifi.rootfs.fw -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> core-image-full-cmdline-raspberrypi0-wifi.rootfs-20240924200317.fw</span><br></span></code></pre></div></div>
<p>The folder <em>tmp/deploy/images/raspberrypi0-wifi</em> has many files generated from
the build tasks. We are interested only the final .fw file. In this case we the
file <em>core-image-full-cmdline-raspberrypi0-wifi.rootfs-20240924200317.fw</em> is
what we need.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="deploying-fw-images">Deploying .fw images<a href="https://meta-erlang.github.io/blog/2024/09/24/index/#deploying-fw-images" class="hash-link" aria-label="Direct link to Deploying .fw images" title="Direct link to Deploying .fw images" translate="no">‚Äã</a></h2>
<p>Before deploying, let's understand a bit the image partition layout created by
YP/OE and fwup tool:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># +----------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># | MBR                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># +----------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># | Firmware configuration data|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># | (formatted as uboot env)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># +----------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># | p0*: Boot A (FAT32)        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># | zImage, bootcode.bin,      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># | config.txt, etc.           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># +----------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># | p0*: Boot B (FAT32)        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># +----------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># | p1*: Rootfs A (ext4)       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># +----------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># | p1*: Rootfs B (ext4)       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># +----------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># | p2: Application (ext4)     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># +----------------------------+</span><br></span></code></pre></div></div>
<p>There is a total of three partitions. Where partition p0 and p1 have been
divided by half each one. It's not clear to get this idea. So, I recommend you
to take a look into fwup configuration file used by this tutorial,
<a href="https://github.com/meta-erlang/meta-axon/blob/master/fwup/core-image-full-cmdline.raspberrypi0-wifi.fwup" target="_blank" rel="noopener noreferrer" class="">core-image-full-cmdline.raspberrypi0-wifi.fwup</a>.
That file has been adapted from the original
<a href="https://github.com/nerves-project/nerves_system_rpi0/blob/main/fwup.conf" target="_blank" rel="noopener noreferrer" class="">nerves_system_rpi0 fwup configuration</a>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="burn-a-complete-image">burn a complete image<a href="https://meta-erlang.github.io/blog/2024/09/24/index/#burn-a-complete-image" class="hash-link" aria-label="Direct link to burn a complete image" title="Direct link to burn a complete image" translate="no">‚Äã</a></h3>
<p>My target sdcard has 16GB there is enough space for the core-image-full-cmdline
image. To start using it we need write a <em>complete</em> image to the sdcard. By
complete image also means the the partition A will be used when the board gets
booted.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> fwup </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-d</span><span class="token plain"> /dev/sda </span><span class="token parameter variable" style="color:#36acaa">-t</span><span class="token plain"> complete </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> core-image-full-cmdline-raspberrypi0-wifi.rootfs-20240924200317.fw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">100</span><span class="token plain">% </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">68.46</span><span class="token plain"> MB </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> / </span><span class="token number" style="color:#36acaa">382.20</span><span class="token plain"> MB out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Success</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Elapsed time: </span><span class="token number" style="color:#36acaa">55.932</span><span class="token plain"> s</span><br></span></code></pre></div></div>
<p>When I inserted the sdcard into my workstation, my host Linux recognized it as
<em>/dev/sda</em> device, using sudo when calling fwup took almost 56 seconds to write
382 MB to the sdcard.</p>
<p>That is all we need to get the sdcard and boot it into raspberry board.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The next output is just the partition layout for a real board booted from the
sdcard.</p></div></div>
<p>And in fact, it works as expected:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@raspberrypi0-wifi:~</span><span class="token comment" style="color:#999988;font-style:italic"># sfdisk -l /dev/mmcblk0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disk /dev/mmcblk0: </span><span class="token number" style="color:#36acaa">14.84</span><span class="token plain"> GiB, </span><span class="token number" style="color:#36acaa">15931539456</span><span class="token plain"> bytes, </span><span class="token number" style="color:#36acaa">31116288</span><span class="token plain"> sectors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Units: sectors of </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> * </span><span class="token number" style="color:#36acaa">512</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">512</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sector size </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">logical/physical</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">: </span><span class="token number" style="color:#36acaa">512</span><span class="token plain"> bytes / </span><span class="token number" style="color:#36acaa">512</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">I/O size </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">minimum/optimal</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">: </span><span class="token number" style="color:#36acaa">512</span><span class="token plain"> bytes / </span><span class="token number" style="color:#36acaa">512</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disklabel type: dos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disk identifier: 0x00000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Device         Boot   Start      End  Sectors  Size Id Type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/mmcblk0p1 *         </span><span class="token number" style="color:#36acaa">63</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">266302</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">266240</span><span class="token plain">  130M  c W95 FAT32 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LBA</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/mmcblk0p2       </span><span class="token number" style="color:#36acaa">532543</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">1011774</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">479232</span><span class="token plain">  234M </span><span class="token number" style="color:#36acaa">83</span><span class="token plain"> Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/dev/mmcblk0p3      </span><span class="token number" style="color:#36acaa">1491007</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">31116287</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">29625281</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token plain">.1G </span><span class="token number" style="color:#36acaa">83</span><span class="token plain"> Linux</span><br></span></code></pre></div></div>
<p>Checking erl and iex versions:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@raspberrypi0-wifi:~</span><span class="token comment" style="color:#999988;font-style:italic"># erl</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Erlang/OTP </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">erts-15.0.1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">source</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32</span><span class="token plain">-bit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">smp:1:1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ds:1:1:10</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">async-threads:1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Eshell V15.0.1 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">press Ctrl+G to abort, </span><span class="token builtin class-name">type</span><span class="token plain"> help</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">. </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token builtin class-name">help</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator file-descriptor important" style="color:#393A34">1</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User switch </span><span class="token builtin class-name">command</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type h </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token builtin class-name">help</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> --</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> q</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@raspberrypi0-wifi:~</span><span class="token comment" style="color:#999988;font-style:italic"># iex</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Erlang/OTP </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">erts-15.0.1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">source</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32</span><span class="token plain">-bit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">smp:1:1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ds:1:1:10</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">async-threads:1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">warning: the VM is running with native name encoding of latin1 </span><span class="token function" style="color:#d73a49">which</span><span class="token plain"> may cause Elixir to malfunction as it expects utf8. Please ensure your locale is </span><span class="token builtin class-name">set</span><span class="token plain"> to UTF-8 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">whiche</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Interactive Elixir </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1.17</span><span class="token plain">.1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> - press Ctrl+C to </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type h</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ENTER </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token builtin class-name">help</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="move-to-b-partition">move to B partition<a href="https://meta-erlang.github.io/blog/2024/09/24/index/#move-to-b-partition" class="hash-link" aria-label="Direct link to move to B partition" title="Direct link to move to B partition" translate="no">‚Äã</a></h3>
<p>Still using the image
core-image-full-cmdline-raspberrypi0-wifi.rootfs-20240924200317.fw, I want to
test the B upgrade path. For that, the easiest way is to call fwup (which has
been installed into the image) passing some usual flags for this
<a href="https://github.com/fwup-home/fwup?tab=readme-ov-file#whats-something-cool-that-you-can-do-with-fwup" target="_blank" rel="noopener noreferrer" class="">kind of operation</a>:</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The instructions for setting board's network stack using USB is not part of the
scope of this tutorial.</p></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> core-image-full-cmdline-raspberrypi0-wifi.rootfs-20240924200317.fw </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ssh</span><span class="token plain"> root@192.168.7.7 </span><span class="token string" style="color:#e3116c">'fwup -v -a -U -d /dev/mmcblk0 -t upgrade.b'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fwup: require-partition-offset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">532543</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> met</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fwup: require-uboot-variable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uboot-env, a.nerves_fw_platform</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> met</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fwup: require-uboot-variable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uboot-env, a.nerves_fw_architecture</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> met</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fwup: Upgrading partition B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">100</span><span class="token plain">% </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">68.46</span><span class="token plain"> MB </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> / </span><span class="token number" style="color:#36acaa">381.82</span><span class="token plain"> MB out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Success</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Elapsed time: </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> min </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> s</span><br></span></code></pre></div></div>
<p>The important argument is the <code>-t upgrade.b</code> telling to fwup which partition
will be upgraded.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>In my setup I called <code>reboot</code> to get raspberry rebooted.</p></div></div>
<p>Checking erl and iex versions:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@raspberrypi0-wifi:~</span><span class="token comment" style="color:#999988;font-style:italic"># erl</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Erlang/OTP </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">erts-15.0.1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">source</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32</span><span class="token plain">-bit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">smp:1:1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ds:1:1:10</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">async-threads:1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Eshell V15.0.1 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">press Ctrl+G to abort, </span><span class="token builtin class-name">type</span><span class="token plain"> help</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">. </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token builtin class-name">help</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator file-descriptor important" style="color:#393A34">1</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User switch </span><span class="token builtin class-name">command</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type h </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token builtin class-name">help</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> --</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> q</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@raspberrypi0-wifi:~</span><span class="token comment" style="color:#999988;font-style:italic"># iex</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Erlang/OTP </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">erts-15.0.1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">source</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32</span><span class="token plain">-bit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">smp:1:1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ds:1:1:10</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">async-threads:1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">warning: the VM is running with native name encoding of latin1 </span><span class="token function" style="color:#d73a49">which</span><span class="token plain"> may cause Elixir to malfunction as it expects utf8. Please ensure your locale is </span><span class="token builtin class-name">set</span><span class="token plain"> to UTF-8 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">whiche</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Interactive Elixir </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1.17</span><span class="token plain">.1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> - press Ctrl+C to </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type h</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ENTER </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token builtin class-name">help</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre></div></div>
<p>The versions are still 1.17.x and 27.0.x, as expected.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="move-from-b-to-a-partition">move from B to A partition<a href="https://meta-erlang.github.io/blog/2024/09/24/index/#move-from-b-to-a-partition" class="hash-link" aria-label="Direct link to move from B to A partition" title="Direct link to move from B to A partition" translate="no">‚Äã</a></h3>
<p>For testing purposes, let's change the Elixir preferred version from 1.17.x to
1.16.x. For that, edit the local.conf file and change the
<code>PREFERRED_VERSION_elixir*</code> variables:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> conf/local.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># select specific elixir and erlang versions</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">PREFERRED_VERSION_elixir = "1.16%"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">PREFERRED_VERSION_elixir-native = "1.16%"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">PREFERRED_VERSION_nativesdk-elixir = "1.16%"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre></div></div>
<p>Running the build again:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake core-image-full-cmdline</span><br></span></code></pre></div></div>
<p>The result will be a new core-image-full-cmdline-raspberrypi0-wifi.rootfs-*.fw
filename which is ready to be used:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> core-image-full-cmdline-raspberrypi0-wifi.rootfs-20240920190231.fw </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ssh</span><span class="token plain"> root@192.168.7.7 </span><span class="token string" style="color:#e3116c">'fwup -v -a -U -d /dev/mmcblk0 -t upgrade.a'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fwup: require-partition-offset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">1011775</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> met</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fwup: require-uboot-variable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uboot-env, b.nerves_fw_platform</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> met</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fwup: require-uboot-variable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uboot-env, b.nerves_fw_architecture</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> -</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> met</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fwup: Upgrading partition A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">100</span><span class="token plain">% </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">68.46</span><span class="token plain"> MB </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> / </span><span class="token number" style="color:#36acaa">381.82</span><span class="token plain"> MB out</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Success</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Elapsed time: </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> min </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"> s</span><br></span></code></pre></div></div>
<p>Rebooting the board and checking the iex version, we get:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@raspberrypi0-wifi:~</span><span class="token comment" style="color:#999988;font-style:italic"># erl</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Erlang/OTP </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">erts-15.0.1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">source</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32</span><span class="token plain">-bit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">smp:1:1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ds:1:1:10</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">async-threads:1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Eshell V15.0.1 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">press Ctrl+G to abort, </span><span class="token builtin class-name">type</span><span class="token plain"> help</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">. </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token builtin class-name">help</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator file-descriptor important" style="color:#393A34">1</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User switch </span><span class="token builtin class-name">command</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type h </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token builtin class-name">help</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> --</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> q</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@raspberrypi0-wifi:~</span><span class="token comment" style="color:#999988;font-style:italic"># iex</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">warning: the VM is running with native name encoding of latin1 </span><span class="token function" style="color:#d73a49">which</span><span class="token plain"> may cause Elixir to malfunction as it expects utf8. Please ensure your locale is </span><span class="token builtin class-name">set</span><span class="token plain"> to UTF-8 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">whiche</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Erlang/OTP </span><span class="token number" style="color:#36acaa">27</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">erts-15.0.1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">source</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32</span><span class="token plain">-bit</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">smp:1:1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ds:1:1:10</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">async-threads:1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Interactive Elixir </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1.16</span><span class="token plain">.3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> - press Ctrl+C to </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type h</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ENTER </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token builtin class-name">help</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>That works! Erlang/OTP 27 and Elixir 1.16.3.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="conclusions">Conclusions<a href="https://meta-erlang.github.io/blog/2024/09/24/index/#conclusions" class="hash-link" aria-label="Direct link to Conclusions" title="Direct link to Conclusions" translate="no">‚Äã</a></h2>
<p>The <a href="https://github.com/fwup-home/fwup" target="_blank" rel="noopener noreferrer" class="">fwup</a> tool has shown as a feasibly
approach for image A/B software upgrades. It is integrated into YP/OE ecosystem
through <a href="https://github.com/fwup-home/meta-fwup" target="_blank" rel="noopener noreferrer" class="">meta-fwup</a> layer and ready to
try.</p>
<p>fwup is also used by Nerves Project together with others Elixir components in
order to provide a full
<a href="https://en.wikipedia.org/wiki/Over-the-air_update" target="_blank" rel="noopener noreferrer" class="">OTA updates</a>.</p>]]></content>
        <author>
            <name>Jo√£o Henrique Ferreira de Freitas</name>
            <uri>https://github.com/joaohf</uri>
        </author>
        <category label="meta-erlang" term="meta-erlang"/>
        <category label="fwup" term="fwup"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[New Erlang releases 27.0]]></title>
        <id>https://meta-erlang.github.io/blog/2024/05/31/index/</id>
        <link href="https://meta-erlang.github.io/blog/2024/05/31/index/"/>
        <updated>2024-05-31T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[We've added support for the following new Erlang/OTP releases:]]></summary>
        <content type="html"><![CDATA[<p>We've added support for the following new Erlang/OTP releases:</p>
<table><thead><tr><th>meta-erlang branch</th><th>Erlang/OTP version</th></tr></thead><tbody><tr><td>scarthgap</td><td>25.3.2.12, 26.2.5, 27.0</td></tr><tr><td>master</td><td>25.3.2.12, 26.2.5, 27.0</td></tr></tbody></table>
<p>And the following Elixir releases:</p>
<table><thead><tr><th>meta-erlang branch</th><th>Elixir version</th></tr></thead><tbody><tr><td>scarthgap</td><td>1.13.4, 1.14.4, 1.15.7, 1.16.3</td></tr><tr><td>master</td><td>1.13.4, 1.14.4, 1.15.7, 1.16.3</td></tr></tbody></table>
<p>I was planing to also add Erlang/OTP 27.0 to LTS kirkstone release. However it
is not feasible as Erlang/OTP 27 uses autoconf 2.72 and kirkstone uses 2.71.
Thus, there is an incompatible related to build system.</p>]]></content>
        <author>
            <name>Jo√£o Henrique Ferreira de Freitas</name>
            <uri>https://github.com/joaohf</uri>
        </author>
        <category label="meta-erlang" term="meta-erlang"/>
        <category label="news" term="news"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[livebook server]]></title>
        <id>https://meta-erlang.github.io/blog/2024/04/28/index/</id>
        <link href="https://meta-erlang.github.io/blog/2024/04/28/index/"/>
        <updated>2024-04-28T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Intro]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="intro">Intro<a href="https://meta-erlang.github.io/blog/2024/04/28/index/#intro" class="hash-link" aria-label="Direct link to Intro" title="Direct link to Intro" translate="no">‚Äã</a></h2>
<p>From <a href="https://livebook.dev/" target="_blank" rel="noopener noreferrer" class="">livebook.dev</a> website:</p>
<blockquote>
<p>Automate code &amp; data workflows with interactive notebooks.</p>
</blockquote>
<p>Livebook is getting famous for modern notebooks. It helps a lot for several
tasks and to solve issues where documentation and code have to walk together.</p>
<p>Live book has been added to the standard beamtools SDK. That is very handy
because one can start livebook quickly and it will work with all SDK tools. That
means, we don't need to install anything else. It's all integrated.</p>
<p>If one more tool is needed, it's just a matter of including it into SDK and it
will be ready to use.</p>
<p>The following section is a step by step in order to install livebook in any
modern Linux server.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="livebook-as-a-linux-systemd-service">livebook as a Linux systemd service<a href="https://meta-erlang.github.io/blog/2024/04/28/index/#livebook-as-a-linux-systemd-service" class="hash-link" aria-label="Direct link to livebook as a Linux systemd service" title="Direct link to livebook as a Linux systemd service" translate="no">‚Äã</a></h3>
<p>All commands as sudo:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wget -O /tmp/x86_64-beamtools-nativesdk-standalone-5.0.2-erlang-27.0-elixir-1.17.1.sh https://github.com/meta-erlang/meta-erlang/releases/download/beamtools-0.9.1/x86_64-beamtools-nativesdk-standalone-5.0.2-erlang-27.0-elixir-1.17.1.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chmod +x /tmp/x86_64-beamtools-nativesdk-standalone-5.0.2-erlang-27.0-elixir-1.17.1.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">adduser --group livebook livebook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir /home/livebook/sdk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/tmp/x86_64-beamtools-nativesdk-standalone-5.0.2-erlang-27.0-elixir-1.17.1.sh -y -d /home/livebook/sdk/5.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chown -R livebook:livebook /home/livebook/sdk/5.0.2</span><br></span></code></pre></div></div>
<p>Create a file at /etc/livebook/livebook.conf with permission livebook<!-- -->:livebook<!-- -->
and the following configuration:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LIVEBOOK_DEFAULT_RUNTIME=standalone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LIVEBOOK_IP=0.0.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LIVEBOOK_PORT=8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LIVEBOOK_PASSWORD=livebook-instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LIVEBOOK_HOME=/home/livebook</span><br></span></code></pre></div></div>
<p>Create a systemd service file at /lib/systemd/system/livebook.service with the
following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[Unit]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Description=Livebook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type=simple</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User=livebook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Group=livebook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Environment=SHELL=/bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Environment=HOME=/home/livebook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EnvironmentFile=/etc/livebook/livebook.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WorkingDirectory=/home/livebook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStart=/home/livebook/livebook.sh start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ExecStop=/home/livebook/livebook.sh stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Restart=on-failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Install]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WantedBy=multi-user.target</span><br></span></code></pre></div></div>
<p>Create a file /home/livebook/livebook.sh, change permission to
livebook<!-- -->:livebook<!-- -->.</p>
<p>With the following contents:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Load SDK environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source /home/livebook/sdk/5.0.2/environment-setup-x86_64-pokysdk-linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Start/Stop livebook</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">livebook $@</span><br></span></code></pre></div></div>
<p>In order to start and stop livebook, it's all about systemctl commands:</p>
<ul>
<li class="">start: <code>systemctl start livebook</code></li>
<li class="">stop: <code>systemctl stop livebook</code></li>
<li class="">check status: <code>systemctl status livebook</code></li>
</ul>]]></content>
        <author>
            <name>Jo√£o Henrique Ferreira de Freitas</name>
            <uri>https://github.com/joaohf</uri>
        </author>
        <category label="meta-erlang" term="meta-erlang"/>
        <category label="livebook" term="livebook"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[New Erlang releases 24.3.4.17, 25.3.2.12, 26.2.5, 27.0-rc3]]></title>
        <id>https://meta-erlang.github.io/blog/2024/04/21/index/</id>
        <link href="https://meta-erlang.github.io/blog/2024/04/21/index/"/>
        <updated>2024-04-21T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[We've added support for the following new Erlang/OTP releases:]]></summary>
        <content type="html"><![CDATA[<p>We've added support for the following new Erlang/OTP releases:</p>
<table><thead><tr><th>meta-erlang branch</th><th>Erlang/OTP version</th></tr></thead><tbody><tr><td>kirkstone</td><td>24.3.4.17, 25.3.2.12, 26.2.5</td></tr><tr><td>master</td><td>25.3.2.12, 26.2.5, 27.0-rc3</td></tr></tbody></table>]]></content>
        <author>
            <name>Jo√£o Henrique Ferreira de Freitas</name>
            <uri>https://github.com/joaohf</uri>
        </author>
        <category label="meta-erlang" term="meta-erlang"/>
        <category label="news" term="news"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[New Erlang releases 24.3.4.16, 25.3.2.10, 26.2.3]]></title>
        <id>https://meta-erlang.github.io/blog/2024/03/17/index/</id>
        <link href="https://meta-erlang.github.io/blog/2024/03/17/index/"/>
        <updated>2024-03-17T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[We've added support for the following new Erlang/OTP releases:]]></summary>
        <content type="html"><![CDATA[<p>We've added support for the following new Erlang/OTP releases:</p>
<table><thead><tr><th>meta-erlang branch</th><th>Erlang/OTP version</th></tr></thead><tbody><tr><td>dunfell</td><td>24.3.4.16</td></tr><tr><td>kirkstone</td><td>24.3.4.16, 25.3.2.10, 26.2.3</td></tr><tr><td>master</td><td>25.3.2.10, 26.2.3</td></tr></tbody></table>]]></content>
        <author>
            <name>Jo√£o Henrique Ferreira de Freitas</name>
            <uri>https://github.com/joaohf</uri>
        </author>
        <category label="meta-erlang" term="meta-erlang"/>
        <category label="news" term="news"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[New Erlang releases 24.3.4.15, 25.3.2.8, 26.2.1]]></title>
        <id>https://meta-erlang.github.io/blog/2023/12/25/index/</id>
        <link href="https://meta-erlang.github.io/blog/2023/12/25/index/"/>
        <updated>2023-12-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[We've added support for the following new Erlang/OTP releases:]]></summary>
        <content type="html"><![CDATA[<p>We've added support for the following new Erlang/OTP releases:</p>
<table><thead><tr><th>meta-erlang branch</th><th>Erlang/OTP version</th></tr></thead><tbody><tr><td>dunfell</td><td>24.3.4.15</td></tr><tr><td>kirkstone</td><td>24.3.4.15, 25.3.2.8, 26.2.1</td></tr><tr><td>master</td><td>25.3.2.8, 26.2.1</td></tr></tbody></table>
<p>In additional to those new versions, now it's possible to read Erlang/OTP
documentation in Erlang shell. The docs .chunk files get generated during build
time and one could easily install it by adding the package <em>erlang-modules-dev</em>.</p>]]></content>
        <author>
            <name>Jo√£o Henrique Ferreira de Freitas</name>
            <uri>https://github.com/joaohf</uri>
        </author>
        <category label="meta-erlang" term="meta-erlang"/>
        <category label="news" term="news"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[meta-erlang meets atomvm]]></title>
        <id>https://meta-erlang.github.io/blog/2023/11/02/index/</id>
        <link href="https://meta-erlang.github.io/blog/2023/11/02/index/"/>
        <updated>2023-11-02T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Intro]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="intro">Intro<a href="https://meta-erlang.github.io/blog/2023/11/02/index/#intro" class="hash-link" aria-label="Direct link to Intro" title="Direct link to Intro" translate="no">‚Äã</a></h2>
<p>From <a href="https://www.atomvm.net/" target="_blank" rel="noopener noreferrer" class="">atomvm.net</a> website, atomvm is:</p>
<blockquote>
<p>AtomVM is a lightweight implementation of the the Bogdan Erlang Abstract
Machine (aka, the BEAM), a virtual machine that can execute byte-code
instructions compiled from Erlang or Elixir source code. AtomVM supports a
limited but functional subset of the BEAM opcodes, and also includes a small
subset of the Erlang/OTP standard libraries, all optimized to run on tiny
micro-controllers. With AtomVM, you can write your IoT applications in a
functional programming language, using a modern actor-based concurrency model,
making them vastly easier to write and understand!</p>
</blockquote>
<p>One of the atomvm goals is the possibility to run BEAM code on really small
systems like MCUs.</p>
<p>For a while, I was wondering what could be the benefits of integrating atomvm
into meta-erlang recipes. It didn't look to make any sense for me. Then, I
started playing with that just to see if I was able to run an atomvm program in
Qemu emulation.</p>
<p>Suddenly, I ended up with all pieces to run atomvm programs integrated with
meta-erlang. So this post is about how it is possible to use atomvm in Linux
images based on YP/OE.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="atomvm-recipe">atomvm recipe<a href="https://meta-erlang.github.io/blog/2023/11/02/index/#atomvm-recipe" class="hash-link" aria-label="Direct link to atomvm recipe" title="Direct link to atomvm recipe" translate="no">‚Äã</a></h3>
<p>The
<a href="https://github.com/meta-erlang/meta-erlang/blob/master/recipes-devtools/atomvm/atomvm_0.6.0-alpha1.bb" target="_blank" rel="noopener noreferrer" class="">atomvm.bb</a>
recipe is very simple because the atomvm project is based on CMake and YP has
support to it.</p>
<p>However, I had to make a specific recipe to isolate the tool packbeam. The
packbeam tool lives inside atomvm source code I've created a recipe called
<a href="https://github.com/meta-erlang/meta-erlang/blob/master/recipes-devtools/atomvm/packbeam_0.6.0-alpha1.bb" target="_blank" rel="noopener noreferrer" class="">packbeam.bb</a>
which compiles packbeam as native (that is runs on build host machine). That was
necessary because the atomvm recipe crosscompile the atomvm and packbeam is used
by CMake to pack all .beam files to create .avm files.</p>
<p>To make atomvm recipe works, I applied a patch
(<a href="https://github.com/meta-erlang/meta-erlang/blob/master/recipes-devtools/atomvm/files/0001-Remove-PackBEAM-dependency-rules.patch" target="_blank" rel="noopener noreferrer" class="">0001-Remove-PackBEAM-dependency-rules.patch</a>)
to disable the packbeam dependency internally. That allows me to use my packbeam
tool from sysroot-native instead.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The mentioned patch works for my needs but is not target for sending a PR to
atomvm project.</p></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="atomvm-examples">atomvm examples<a href="https://meta-erlang.github.io/blog/2023/11/02/index/#atomvm-examples" class="hash-link" aria-label="Direct link to atomvm examples" title="Direct link to atomvm examples" translate="no">‚Äã</a></h3>
<p>There is the <a href="https://github.com/atomvm/atomvm_examples" target="_blank" rel="noopener noreferrer" class="">atomvm_examples</a>
project that provides great source of ideas and examples. I wish to create some
recipes to build and pack each example. So I started with the
<a href="https://github.com/atomvm/atomvm_examples/tree/master/erlang/system_info" target="_blank" rel="noopener noreferrer" class="">system_info</a>.</p>
<p>The following code is the
<a href="https://github.com/meta-erlang/meta-erlang/blob/master/recipes-examples/atomvm-examples/atomvm-examples-system-info_0.1.0.bb" target="_blank" rel="noopener noreferrer" class="">atomvm-examples-system-info_0.1.0.bb</a>
recipe. And should be enough for any Erlang project build which uses
<a href="https://github.com/atomvm/atomvm_rebar3_plugin" target="_blank" rel="noopener noreferrer" class="">atomvm_rebar3_plugin</a>.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SUMMARY = "Collects and displays various information about AtomVM and the environment in which it is running."</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SECTION = "examples"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LICENSE = "Apache-2.0"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LIC_FILES_CHKSUM = "file://LICENSE;md5=745e8b23501916820b8a509f8e3ba3d4"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ATOMVM_EXAMPLE = "erlang/system_info"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">S = "${WORKDIR}/system_info"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SRCREV = "8e54aaf475a74b59a20f914e575202b1810a7954"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PV = "0.1.0+git${SRCPV}"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SRC_URI = "git://github.com/atomvm/atomvm_examples;branch=master;subpath=${ATOMVM_EXAMPLE};protocol=https"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">inherit atomvm</span><br></span></code></pre></div></div>
<p>The <code>inherit atomvm</code> inherits the
<a href="https://github.com/meta-erlang/meta-erlang/blob/master/classes/atomvm.bbclass" target="_blank" rel="noopener noreferrer" class="">atomvm.bbclass</a>
which implements rebar3 commands to compile and create avm files.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="build-and-run-session">Build and run session<a href="https://meta-erlang.github.io/blog/2023/11/02/index/#build-and-run-session" class="hash-link" aria-label="Direct link to Build and run session" title="Direct link to Build and run session" translate="no">‚Äã</a></h3>
<p>To build the atomvm-examples-system-info recipe, we call bitbake like that:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake atomvm-examples-system-info</span><br></span></code></pre></div></div>
<p>Now, we want to run system_info application inside Qemu. The first step is to
install the atomvm-examples-system-info in the final image.</p>
<p>In <em>conf/local.conf</em> file add the recipe name to the IMAGE_INSTALL variable:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">IMAGE_INSTALL:append:pn-core-image-minimal = " atomvm-examples-system-info"</span><br></span></code></pre></div></div>
<p>When building the core-image-minimal image and running it with Qemu:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">runqemu core-image-minimal slirp nographic serialstdio</span><br></span></code></pre></div></div>
<p>Inside the Qemu, let's run our first atomvm program:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@qemux86-64:~# uname -a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Linux qemux86-64 6.5.7-yocto-standard #1 SMP PREEMPT_DYNAMIC Thu Oct 19 14:51:09 UTC 2023 x86_64 GNU/Linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@qemux86-64:~# atomvm /usr/share/atomvm-examples-system-info/system_info.avm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Unsupported line_ref tag: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SystemInfo:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">===========</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">atom_count: 162</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">port_count: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">process_count: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">system_architecture: &lt;&lt;"Linux--x86_64"&gt;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">word_size: 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PlatformInfo:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">=============</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ProcessInfo:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">============</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pid: &lt;0.1.0&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">heap_size: 51</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">memory: 848</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message_queue_len: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stack_size: 9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Return value: ok</span><br></span></code></pre></div></div>
<p>That works as expected.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="integration-outcomes-and-questions">Integration outcomes and questions<a href="https://meta-erlang.github.io/blog/2023/11/02/index/#integration-outcomes-and-questions" class="hash-link" aria-label="Direct link to Integration outcomes and questions" title="Direct link to Integration outcomes and questions" translate="no">‚Äã</a></h3>
<p>The recipes created so far covers running atomvm for generic unix (Linux in my
case). Well, if you can afford running Erlang/Elixir on Linux, then there is no
selling point to use atomvm. That is true if we look at the current state of
atomvm project for generic unix platform.</p>
<p>Maybe in the future we can see extensions to generic unix allowing it to talk
with i2c, gpio, spi on Linux for example, then atomvm and meta-erlang starts to
cover a lot of possibilities. Projects like
<a href="https://github.com/eclipse/mraa" target="_blank" rel="noopener noreferrer" class="">Eclipse Mraa</a> could be integrated with atomvm
providing all the low level access for low speed IO.</p>
<p>There is another idea for meta-erlang and atomvm which is the heterogeneous
system with a combination of:</p>
<ul>
<li class="">Linux based images running on the "application processing unit" (CPU)</li>
<li class="">and "real-time processing unit" (MCU) running an atomvm program.</li>
</ul>
<p>meta-erlang could build atomvm images for MCU as well for CPU. The seeds for
this integration was described in this talk
<a href="https://www.youtube.com/watch?v=mFgiIXv7b5U" target="_blank" rel="noopener noreferrer" class="">One Build to Rule Them All: Building FreeRTOS &amp; Linux Using Yocto - Alejandro Hernandez</a>
(the pdf is
<a href="https://elinux.org/images/9/9f/ELC_Europe_2019_Presentation_AlejandroHernandez_FreeRTOS_ToUpload.pdf" target="_blank" rel="noopener noreferrer" class="">here</a>).
In that talk Alejandro shows how YP/OE projects can build MCU target images.
Using the same principles also works for meta-erlang.</p>]]></content>
        <author>
            <name>Jo√£o Henrique Ferreira de Freitas</name>
            <uri>https://github.com/joaohf</uri>
        </author>
        <category label="meta-erlang" term="meta-erlang"/>
        <category label="atomvm" term="atomvm"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Exploring x32 psABI for Erlang/OTP]]></title>
        <id>https://meta-erlang.github.io/blog/2023/09/02/index/</id>
        <link href="https://meta-erlang.github.io/blog/2023/09/02/index/"/>
        <updated>2023-09-02T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Intro]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="intro">Intro<a href="https://meta-erlang.github.io/blog/2023/09/02/index/#intro" class="hash-link" aria-label="Direct link to Intro" title="Direct link to Intro" translate="no">‚Äã</a></h2>
<p>According to <a href="https://en.wikipedia.org/wiki/X32_ABI" target="_blank" rel="noopener noreferrer" class="">Wikipedia X32 ABI</a> page:</p>
<blockquote>
<p>The x32 ABI is an application binary interface (ABI) and one of the interfaces
of the Linux kernel. The x32 ABI provides 32-bit integers, long and pointers
(ILP32) on Intel and AMD 64-bit hardware. The ABI allows programs to take
advantage of the benefits of x86-64 instruction set (larger number of CPU
registers, better floating-point performance, faster position-independent
code, shared libraries, function parameters passed via registers, faster
syscall instruction) while using 32-bit pointers and thus avoiding the
overhead of 64-bit pointers.</p>
</blockquote>
<p>So, I'm wondering if it would be possible to enable x32 support in Erlang/OTP
build. That way, I could make a Yocto image for x32 that runs on x86-64
machines.</p>
<p>Here is some references about the subject:</p>
<ul>
<li class=""><a href="https://docs.yoctoproject.org/dev-manual/x32-psabi.html" target="_blank" rel="noopener noreferrer" class="">Yocto, Using x32 psABI</a></li>
<li class=""><a href="https://sites.google.com/site/x32abi/home?authuser=0" target="_blank" rel="noopener noreferrer" class="">x32-abi</a></li>
<li class=""><a href="http://linuxplumbersconf.org/2011/ocw//system/presentations/531/original/x32-LPC-2011-0906.pptx" target="_blank" rel="noopener noreferrer" class="">X32 ‚Äì A Native 32bit ABI For X86-64</a></li>
<li class=""><a href="https://wiki.debian.org/X32Port" target="_blank" rel="noopener noreferrer" class="">Debian x32 port</a></li>
<li class=""><a href="https://raw.githubusercontent.com/wiki/hjl-tools/x86-psABI/x86-64-psABI-1.0.pdf" target="_blank" rel="noopener noreferrer" class="">System V Application Binary Interface AMD64 Architecture Processor Supplement (With LP64 and ILP32 Programming Models</a></li>
</ul>
<p>In fact, x32 seems to be around since 2011/2012 and has been integrated in many
platforms. Like Ubuntu, Debian, Gentoo.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="building-erlangotp-using-x32-toolchain">Building Erlang/OTP using x32 toolchain<a href="https://meta-erlang.github.io/blog/2023/09/02/index/#building-erlangotp-using-x32-toolchain" class="hash-link" aria-label="Direct link to Building Erlang/OTP using x32 toolchain" title="Direct link to Building Erlang/OTP using x32 toolchain" translate="no">‚Äã</a></h2>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>A toolchain with x32 support is necessary. However, it's not easy to find one.
Instead projects like <a href="https://crosstool-ng.github.io/" target="_blank" rel="noopener noreferrer" class="">crosstool-NG</a> and
<a href="https://www.yoctoproject.org/" target="_blank" rel="noopener noreferrer" class="">Yocto Project</a> have tools to make a toolchain
with x32 support enabled.</p></div></div>
<p>In order to follow this experiment, you can download a specific toolchain with
x32 enabled here:
<a href="https://github.com/meta-erlang/meta-erlang.github.io/releases/tag/x32-toolchain" target="_blank" rel="noopener noreferrer" class="">poky-glibc-x86_64-core-image-minimal-x86_64_x32-qemux86-64-toolchain-4.2.sh</a>.</p>
<p>It will be necessary to install it in a temporary folder like the steps below:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">chmod +x poky-glibc-x86_64-core-image-minimal-x86_64_x32-qemux86-64-toolchain-4.2.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">poky-glibc-x86_64-core-image-minimal-x86_64_x32-qemux86-64-toolchain-4.2.sh -y -d /tmp/poky/4.2</span><br></span></code></pre></div></div>
<p>Following the Erlang/OTP
<a href="https://github.com/erlang/otp/blob/master/HOWTO/INSTALL-CROSS.md" target="_blank" rel="noopener noreferrer" class="">INSTALL-CROSS.md</a>
document, we first need to build a Bootstrap System:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd $ERL_TOP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./configure --enable-bootstrap-only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make</span><br></span></code></pre></div></div>
<p>Next, we have to source the toolchain environment configurations:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">. /tmp/poky/4.2/environment-setup-x86_64_x32-poky-linux-gnux32</span><br></span></code></pre></div></div>
<p>After sourcering the environment variable, the shell gets configured with some
extra variables using during the build:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">x86_64-poky-linux-gnux32-gcc -mx32 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> -fstack-protector-strong \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> -O2 -D_FORTIFY_SOURCE=2 -Wformat -Wformat-security -Werror=format-security \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> --sysroot=/tmp/poky/4.2/sysroots/x86_64_x32-poky-linux-gnux32</span><br></span></code></pre></div></div>
<p>It's important to not the GCC flag
<a href="https://gcc.gnu.org/onlinedocs/gcc/x86-Options.html#index-mx32" target="_blank" rel="noopener noreferrer" class="">-mx32</a>:</p>
<blockquote>
<p>The -mx32 option sets int, long, and pointer types to 32 bits, and generates
code for the x86-64 architecture.</p>
</blockquote>
<p>Finally, start the second part of Erlang/OTP build, which is the Cross Build:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./configure  $CONFIGURE_FLAGS  --disable-silent-rules --disable-dependency-tracking \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	--with-ssl-rpath=no --disable-static  --without-javac --without-dynamic-trace --without-observer --without-odbc</span><br></span></code></pre></div></div>
<p>Installing the build output and inspecting the <code>erlexec</code> binary to see what it
looks like:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make install DESTDIR=/tmp/e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">file /tmp/e/usr/local/lib/erlang/erts-14.0.2/bin/erlexec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">erlexec: ELF 32-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /libx32/ld-linux-x32.so.2, BuildID[sha1]=013e32ef8c57686a59a812ca452f09d677ff8e37, for GNU/Linux 5.15.0, with debug_info, not stripped</span><br></span></code></pre></div></div>
<p>Well, the build is correct. But I couldn't test this build in my machine.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="enabling-erlang-for-yocto">Enabling Erlang for Yocto<a href="https://meta-erlang.github.io/blog/2023/09/02/index/#enabling-erlang-for-yocto" class="hash-link" aria-label="Direct link to Enabling Erlang for Yocto" title="Direct link to Enabling Erlang for Yocto" translate="no">‚Äã</a></h2>
<p>In the previous section we just build Erlang/OTP using a toolchain with x32
support. Now, it's time to build Erlang/OTP inside the Yocto project and test
the results using qemu instance.</p>
<p>Enabling it for Yocto is simple, just adding the follow snippet in your
local.conf file:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MACHINE = "qemux86-64"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DEFAULTTUNE = "x86-64-x32"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">baselib = "${@d.getVar('BASE_LIB:tune-' + (d.getVar('DEFAULTTUNE') or 'INVALID')) or 'lib'}"</span><br></span></code></pre></div></div>
<p>Then, building erlang:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bitbake erlang</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>For those that want to check all configure and compiler flags, I'm including the
links to those logs:</p><ul>
<li class=""><a href="https://meta-erlang.github.io/assets/log.do_configure" target="_blank" rel="noopener noreferrer" class="">Configure log output</a></li>
<li class=""><a href="https://meta-erlang.github.io/assets/log.do_compile" target="_blank" rel="noopener noreferrer" class="">Compile log output</a></li>
</ul></div></div>
<p>The build failed in one point related to ASM code in
<a href="https://github.com/erlang/otp/blob/maint-26/erts/lib_src/pthread/ethread.c#L193" target="_blank" rel="noopener noreferrer" class="">erts/lib_src/pthread/ethread.c</a>.
Looks like an ASM incompatibility issue. In order to address it here is
<a href="https://github.com/joaohf/otp/commit/6cd15d5888a536af97f5d8e26b2db2e379fa7eab" target="_blank" rel="noopener noreferrer" class="">a patch</a>
that just adds one more compiler check to pick up the correct ifdef branch.</p>
<p>Afer that, the build runs as expected. And testing it using QEMU shows exactly
what I had in mind:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">runqemu core-image-minimal-qemux86-64.ext4 slirp nographic serialstdio</span><br></span></code></pre></div></div>
<ul>
<li class="">check the current kernel</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@qemux86-64:~# uname -a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Linux qemux86-64 6.1.32-yocto-standard #1 SMP PREEMPT_DYNAMIC Mon Jun  5 13:43:33 UTC 2023 x86_64 GNU/Linux</span><br></span></code></pre></div></div>
<ul>
<li class="">check /proc/cpuinfo to see the 'lm' (long mode)</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@qemux86-64:~# grep -o -w 'lm' /proc/cpuinfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lm</span><br></span></code></pre></div></div>
<ul>
<li class="">check Erlang shell</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Erlang/OTP 26 [erts-14.0.2] [source] [32-bit] [smp:4:4] [ds:4:4:10] [async-threads:1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Eshell V14.0.2 (press Ctrl+G to abort, type help(). for help)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1&gt; application:ensure_all_started(crypto).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{ok,[crypto]}</span><br></span></code></pre></div></div>
<p>Well, looks like we are running Erlang/OTP 32-bits in a x86_64 machine. Also, it
was able to correct load the crypto (with ssl libraries compiled for x32 too).
By the way, there is a second
<a href="https://github.com/joaohf/otp/commit/e63b5b703ffa0005bf6a8f4d3bcec18f786bda92" target="_blank" rel="noopener noreferrer" class="">patch need to proper compile the crypto application</a>.</p>
<p>Some raised questions for further investigations:</p>
<ul>
<li class="">What tests are necessary to prove that the x32 Erlang build is safe ?</li>
<li class="">Are there any other code change in order to fit the x32 build ?</li>
<li class="">Would <a href="https://www.erlang.org/doc/apps/erts/beamasm#faq" target="_blank" rel="noopener noreferrer" class="">BeamAsm</a> be available
for x32 ?</li>
</ul>]]></content>
        <author>
            <name>Jo√£o Henrique Ferreira de Freitas</name>
            <uri>https://github.com/joaohf</uri>
        </author>
        <category label="meta-erlang" term="meta-erlang"/>
        <category label="x32" term="x32"/>
    </entry>
</feed>